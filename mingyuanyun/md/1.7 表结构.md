## 1.6 表结构

### 1.6.1 申请单
### 1.6.2 合同登记
### 1.6.3 付款计划
### 1.6.4 付款申请
### 1.6.5 执行单

#### 1.6.6.1 汇总

| 表                              | 表名               | 说明 |
| ------------------------------- | ------------------ | ---- |
| ys_fy_ExecutionInfo             | 执行单             |      |
| ys_fy_ExecutionDetails          | 薪酬费用明细表     |      |
| ys_fy_HTFKApply_Execution       | 费用预算使用明细表 |      |
| ys_fy_HTFKApply_ExecutionDetail |                    |      |



#### 1.6.6.2 ys_fy_ExecutionInfo

| 列                    | 列名                 | 说明 |
| --------------------- | -------------------- | ---- |
| AllDeductionPrepaid   | 累计抵扣预付         |      |
| ApplicantDeptGUID     | 申请部门GUID         |      |
| ApplicantGUID         | 申请人GUID           |      |
| ApplyDate             | 申请日期             |      |
| ApplyGUID             | 申请单GUID           |      |
| ApproverState         | 审批状态             |      |
| BalanceAmount         | 结算金额             |      |
| BalanceDate           | 结算日期             |      |
| BalanceDeptGUID       | 结算部门GUID         |      |
| BalanceUserGUID       | 结算人GUID           |      |
| BeginDate             | 计划投放开始日期     |      |
| BussinessBelongDate   | 业务归属日期         |      |
| Content               | 执行内容             |      |
| ContractCompleted     | 签约完成额           |      |
| ContractCompletedRate | 签约完成进度         |      |
| ContractGUID          | 合同GUID             |      |
| DeductionPrepaid      | 本次抵扣预付金额     |      |
| DeptGUID              | 预算部门GUID         |      |
| EndDate               | 截止日期             |      |
| ExecutionCode         | 执行单编号           |      |
| ExecutionGUID         | 主键 执行单GUID      |      |
| ExecutionName         | 执行单名称           |      |
| ExpectCalls           | 预计来电             |      |
| ExpectVisitors        | 预计来访             |      |
| JsApproveDate         | 结算审核日期         |      |
| JsApprovedBy          | 结算审核人           |      |
| JsApproveState        | 结算审核状态         |      |
| PopCostsRate          | 推广费用率           |      |
| PrepaidMoney          | 预付金额             |      |
| ReportMoney           | 申报金额             |      |
| SaleCosts             | 推广费使用金额       |      |
| SaleCostsRate         | 营销费用率           |      |
| YearSaleCosts         | 年度营销费用使用金额 |      |

#### 1.6.6.3 ys_fy_ExecutionDetails

| 列                     | 列名               | 说明 |
| ---------------------- | ------------------ | ---- |
| Amount                 | 本次应执行费用金额 |      |
| ApplyAmount            | 累计已请款金额     |      |
| BalanceAmount          | 结算金额           |      |
| ContractCostDetailGUID | 合同预算明细GUID   |      |
| DeptCostGUID           | 部门科目GUID       |      |
| DeptGUID               | 责任部门GUID       |      |
| DeptName               | 责任部门名称       |      |
| DetailGUID             | 主键               |      |
| ExecutionGUID          | 执行单GUID         |      |
| ProcessGUID            | 事项GUID           |      |
| ProcessName            | 事项               |      |
| UserGUID               | 使用人             |      |

#### 1.6.6.4 ys_fy_HTFKApply_Execution

| 列                     | 列名               | 说明 |
| ---------------------- | ------------------ | ---- |
| Amount                 | 本次应执行费用金额 |      |
| ApplyAmount            | 累计已请款金额     |      |
| BalanceAmount          | 结算金额           |      |
| ContractCostDetailGUID | 合同预算明细GUID   |      |
| DeptCostGUID           | 部门科目GUID       |      |
| DeptGUID               | 责任部门GUID       |      |
| DeptName               | 责任部门名称       |      |
| DetailGUID             | 主键               |      |
| ExecutionGUID          | 执行单GUID         |      |
| ProcessGUID            | 事项GUID           |      |
| ProcessName            | 事项               |      |
| UserGUID               | 使用人             |      |

#### 1.6.6.5 ys_fy_HTFKApply_ExecutionDetail

| 列                   | 列名           | 说明 |
| -------------------- | -------------- | ---- |
| ApplyAmount          | 本次申请金额   |      |
| ExecutionAccountGUID | 执行单科目GUID |      |
| ExecutionApplyGUID   | 执行单付款GUID |      |
| GUID                 | 主键GUID       |      |
| TotalApplyAmount     | 累计请款金额   |      |

#### 1.6.6.6 合同口径-已发生

```
declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.ExpenseGUID                                                               报销单主键,
       a.ApplyState                                                                报销单审核状态,
       a.ExpenseCode                                                               报销单编号,
       a.Subject                                                               报销单事由,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.ExpenseAmount                                                             报销金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Expense                a
         JOIN      ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
where a.ApplyState = '已审核' and a.ExpenseTypeName <> '工程水电费代付'
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```



#### 1.6.6.6 合同口径-在途

```

declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.ExpenseGUID                                                               报销单主键,
       a.ApplyState                                                                报销单审核状态,
       a.ExpenseCode                                                               报销单编号,
       a.Subject                                                               报销单事由,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.ExpenseAmount                                                             报销金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Expense                a
         JOIN      ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
where a.ApplyState = '审核中' and a.ExpenseTypeName <> '工程水电费代付'
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```

### 1.6.6 日常报销
#### 1.6.6.1 汇总

| 表                | 表名               | 说明 |
| ----------------- | ------------------ | ---- |
| cb_Expense        | 薪酬表             |      |
| cb_ExpenseDtl     | 薪酬费用明细表     |      |
| ys_DeptCostUseDtl | 费用预算使用明细表 |      |



#### 1.6.6.2 cb_Expense

| 列                 | 列名             | 说明 |
| ------------------ | ---------------- | ---- |
| AppliedBy          | 申请人GUID       |      |
| AppliedByName      | 申请人           |      |
| ApplyBUGUID        | 申请部门GUID     |      |
| ApplyDate          | 申请日期         |      |
| ApplyGUID          | 申请单GUID       |      |
| ApplyState         | 申请状态         |      |
| ApplySubject       | 申请单主题       |      |
| ApproveBy          | 审批人           |      |
| BalanceAmount      | 冲账金额（＄）   |      |
| BalanceAmount_Bz   | 冲账金额         |      |
| BankAccounts       | 银行帐号         |      |
| BankName           | 开户银行         |      |
| BudGetGUID         | 预算主体GUID     |      |
| BudGetName         | 预算主体名称     |      |
| BUGUID             | 公司GUID         |      |
| CurrencyGUID       | 币种             |      |
| ExpenseAmount      | 报销金额（＄）   |      |
| ExpenseAmount_Bz   | 报销金额         |      |
| ExpenseApproveGUID | 批量审批GUID     |      |
| ExpenseCode        | 报销编号         |      |
| ExpenseGUID        | 报销GUID         |      |
| ExpenseTypeGUID    | 报销类型         |      |
| ExpenseTypeName    | 报销类型名称     |      |
| FinishDateTime     | 审批通过时间     |      |
| IsBatchApprove     | 是否批量审批     |      |
| IsCompanyExpense   | IsCompanyExpense |      |
| IsCopyData         | 是否复制数据     |      |
| IsDeductibleloan   | IsDeductibleloan |      |

#### 1.6.6.3 cb_ExpenseDtl

| 列                              | 列名             | 说明 |
| ------------------------------- | ---------------- | ---- |
| Amount_Bz                       | 金额             |      |
| Brief                           | 摘要             |      |
| ExpenseDtlGUID                  | 日常报销明细GUID |      |
| ExpenseDtlName                  | 名称             |      |
| ExpenseGUID                     | 日常报销GUID     |      |
| Invoice_Amount                  | 发票金额         |      |
| Invoice_ExcludingTaxApplyAmount | 发票不含税价     |      |
| Invoice_InputTaxAmount          | 发票进项税额     |      |
| InvoiceType                     | 发票类型         |      |
| OccurDate                       | 发生日期         |      |
| TaxType                         | 税率             |      |

#### 1.6.6.4 ys_DeptCostUseDtl

| 列                      | 列名                           | 说明 |
| ----------------------- | ------------------------------ | ---- |
| BudgetGUID              | 预算主体GUID                   |      |
| BudgetName              | 预算主体                       |      |
| BusinessGUID            | 业务GUID                       |      |
| BusinessType            | 业务类型，默认为：日常报销     |      |
| ContractGUID            | 合同GUID                       |      |
| CorrespondingAmount     | 冲账对应科目金额               |      |
| CorrespondingAmountList | 冲账对应科目金额List           |      |
| CostFlag                | 预警/强控状态标识，此处默认为0 |      |
| CostGUID                | 科目GUID                       |      |
| DeptCostUseDtlGUID      | 部门费项使用明细GUID           |      |
| DeptGUID                | 责任部门GUID                   |      |
| DeptName                | 责任部门                       |      |
| EntryCostCode           |                                |      |
| EntryCostGUID           | 入账科目                       |      |
| EntryCostName           |                                |      |
| FluentCostFullName      | 冲账对应科目                   |      |
| FluentLoanGUID          | 借款单guid                     |      |
| FtAmount                | 分摊金额（￥）                 |      |
| LoanBalance             | 借款余额                       |      |
| LoanFtDetailGUIDList    | 冲账对应科目GUID               |      |
| Month                   | 月，当前月份                   |      |
| PaymentGUID             | 付款单位GUID                   |      |
| PaymentName             | 付款单位                       |      |
| ProceedingGUID          | 事项GUID                       |      |
| UsedAmount              | 使用金额，新增默认为0          |      |
| Year                    | 年，当前年度                   |      |
| ZrrGUID                 | 费用使用人GUID                 |      |
| ZrrName                 | 费用使用人                     |      |

#### 1.6.6.5 合同口径-已发生

```
declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.ExpenseGUID                                                               报销单主键,
       a.ApplyState                                                                报销单审核状态,
       a.ExpenseCode                                                               报销单编号,
       a.Subject                                                               报销单事由,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.ExpenseAmount                                                             报销金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Expense                a
         JOIN      ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
where a.ApplyState = '已审核' and a.ExpenseTypeName <> '工程水电费代付'
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```



#### 1.6.6.6 合同口径-在途

```

declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.ExpenseGUID                                                               报销单主键,
       a.ApplyState                                                                报销单审核状态,
       a.ExpenseCode                                                               报销单编号,
       a.Subject                                                               报销单事由,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.ExpenseAmount                                                             报销金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Expense                a
         JOIN      ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
where a.ApplyState = '审核中' and a.ExpenseTypeName <> '工程水电费代付'
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```
### 1.6.7 借款申请

#### 1.6.7.1 汇总

| 表                  | 表名             | 说明     |
| ------------------- | ---------------- | -------- |
| cb_Loan             | 薪酬表           | 领借款表 |
| cb_Loan_FtDetail    | 领借款科目分摊表 |          |
| cb_LoanBalanceApply | 冲帐明细         |          |



#### 1.6.7.2 cb_Loan

| 列                   | 列名                       | 说明 |
| -------------------- | -------------------------- | ---- |
| Subject              | 主题                       |      |
| Remarks              | 相关说明                   |      |
| RemainAmount_Bz      | 待冲帐金额                 |      |
| RemainAmount         | 换算待冲帐金额             |      |
| ReceiveType          | 收款单位/收款人            |      |
| ReceiverName         | 收款人名称                 |      |
| ReceiverGUID         | 收款人GUID                 |      |
| ReceiverBankName     | 收款人开户银行             |      |
| ReceiverBankAccounts | 收款人银行帐号             |      |
| ReceiveProviderName  | 收款单位名称               |      |
| ReceiveProviderGUID  | 收款单位GUID               |      |
| Rate                 | 汇率                       |      |
| ProjGUID             | 项目GUID                   |      |
| PayState             | 支付状态                   |      |
| PayProviderName      | 付款单位名称               |      |
| PayProviderGUID      | 付款单位GUID               |      |
| PayMode              | 付款方式                   |      |
| LoanTypeName         | 领借款类型名称             |      |
| LoanTypeGUID         | 领借款类型GUID             |      |
| LoanType             | 借款类型                   |      |
| LoanGUID             | 领借款GUID                 |      |
| LoanCode             | 领借款编号                 |      |
| LoanAmount_Bz        | 领借款金额                 |      |
| LoanAmount           | 换算领借款金额             |      |
| IsAccount            | 是否记入资金计划的实际发生 |      |
| IfLocked             | 是否锁定                   |      |
| IfCqbyj              | 长期备用金                 |      |
| FinishDateTime       | 审批通过时间               |      |
| CurrencyGUID         | 币种                       |      |
| BUGUID               | 公司GUID                   |      |
| BankName             | 开户银行                   |      |
| BankAccounts         | 银行帐号                   |      |
| BalanceAmount_Bz     | 已冲帐金额                 |      |
| BalanceAmount        | 换算已冲帐金额             |      |
| ApproveBy            | 审批通过人                 |      |
| ApplyState           | 申请状态                   |      |
| ApplyDate            | 申请日期                   |      |
| ApplyBUGUID          | 申请部门GUID               |      |
| AppliedByName        | 申请人名称                 |      |
| AppliedBy            | 申请人GUID                 |      |
| RelateApplyGUID      | 关联申请单GUID             |      |

#### 1.6.7.3 cb_ExpenseDtl

| 列             | 列名         |
| -------------- | ------------ |
| BalanceAmount  | 冲账金额     |
| CostCode       | 科目Code     |
| CostGUID       | 科目GUID     |
| CostShortName  | 科目名称     |
| DeptGUID       | 责任部门GUID |
| DeptName       | 责任部门     |
| FtAmount       | 分摊金额     |
| FtDetailGUID   | 分摊明细GUID |
| IsUsed         | 是否已被使用 |
| LoanGUID       | 领借款GUID   |
| ProceedingGUID | 事项GUID     |
| ProceedingName | 事项名称     |

#### 1.6.7.4 cb_LoanBalanceApply

| 列                   | 列名               | 说明 |
| -------------------- | ------------------ | ---- |
| BalanceAmount_Bz     | 已冲帐金额         |      |
| CurBalanceAmount_Bz  | 本次冲账金额       |      |
| LoanAmount_Bz        | 借款金额           |      |
| LoanBalanceApplyGUID | 领借款冲账申请GUID |      |
| LoanGUID             | 领借款GUID         |      |
| RefGUID              | 相关业务GUID       |      |
| RefType              | 默认值为：日常报销 |      |
| RemainAmount_Bz      | 待冲帐金额         |      |

#### 1.6.6.5 

#### 1.6.7.6 合同口径-已发生

```
declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.ExpenseGUID                                                               报销单主键,
       a.ApplyState                                                                报销单审核状态,
       a.ExpenseCode                                                               报销单编号,
       a.Subject                                                               报销单事由,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.ExpenseAmount                                                             报销金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Expense                a
         JOIN      ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
where a.ApplyState = '已审核' and a.ExpenseTypeName <> '工程水电费代付'
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```



#### 1.6.6.6 合同口径-在途

```

declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.LoanGUID                                                               借款单主键,
       a.ApplyState                                                                借款单审核状态,
       a.LoanCode                                                               借款单编号,
       a.Subject                                                                   借款单主题,
       a.AppliedByName                                                                     申请人名称,
       a.ApplyDate                                                                      申请日期,
       datepart(year,a.ApplyDate)                                                                      年,
       datepart(month ,a.ApplyDate)                                                      月,
       a.LoanAmount                                                                  借款金额,
       a.ApplyBUGUID                                                                    申请部门标识,
       e.BUName                                                                      申请部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.SpecialUnitName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       NULL                                                                       分摊使用人标识,
       convert(varchar(7),a.ApplyDate,120)                                                     分摊分摊年月
from dbo.cb_Loan                a
         JOIN      cb_Loan_FtDetail b ON a.LoanGUID = b.LoanGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
         Left join ys_SpecialBusinessUnit    f on b.DeptGUID = f.SpecialUnitGUID
        CROSS JOIN (select ISNULL(ControlMode,2) ControlMode from dbo.fy_ControlModeSetting) g
where a.ApplyState = '审核中'
  and g.ControlMode = 0
  and datepart(year,a.ApplyDate) = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```

### 1.6.8 还款申请

### 1.6.9 薪酬管理

#### 1.6.9.1 汇总

| 表                | 表名               | 说明 |
| ----------------- | ------------------ | ---- |
| fy_Emolument      | 薪酬表             |      |
| fy_EmolumentDtl   | 薪酬费用明细表     |      |
| ys_DeptCostUseDtl | 费用预算使用明细表 |      |



#### 1.6.9.2 fy_Emolument

| 列              | 列名             | 说明 |
| --------------- | ---------------- | ---- |
| EmolumentAmount | 薪酬总额         |      |
| EmolumentCode   | 薪酬单编号       |      |
| EmolumentName   | 薪酬单主题名称   |      |
| EmolumentGUID   | 薪酬GUID（主键） |      |
| DeptGUID        | 经办部门GUID     |      |
| jbDate          | 经办日期         |      |
| jbrGUID         | 经办人GUID       |      |
| jbrName         | 经办人           |      |
| Month           | 月份             |      |
| PayState        | 支付状态         |      |
| Year            | 年份             |      |
| CurrencyGUID    | 币种GUID         |      |
| ApproveState    | 审核状态         |      |
| finishDate      | 审核完成时间     |      |
| Remark          | 备注说明         |      |
| BUGUID          | 公司GUID         |      |

#### 1.6.9.3 fy_EmolumentDtl

| 列                      | 列名                     | 说明 |
| ----------------------- | ------------------------ | ---- |
| AccountingSubject       | 入账科目名称             |      |
| AccountingSubjectGUID   | 入账科目GUID             |      |
| Amount                  | 金额                     |      |
| Brief                   | 费用说明                 |      |
| EmolumentDtlGUID        | 薪酬费用明细GUID（主键） |      |
| EmolumentGUID           | 薪酬GUID（主键）         |      |
| ExcludingTaxApplyAmount | 不含税价                 |      |
| ExpenseDtlName          | 费用类型                 |      |
| InputTaxAmount          | 进项税额                 |      |
| InvoiceType             | 发票类型                 |      |
| IsCanDeductible         | 是否可抵扣               |      |
| OccurDate               | 费用日期                 |      |
| PaymentGUID             | 付款单位GUID             |      |
| PaymentName             | 付款单位                 |      |
| PayState                | 明细数据支付状态         |      |
| TaxRate                 | 税率                     |      |

#### 1.6.9.4 ys_DeptCostUseDtl

| 列                      | 列名                           | 说明 |
| ----------------------- | ------------------------------ | ---- |
| BudgetGUID              | 预算主体GUID                   |      |
| BudgetName              | 预算主体                       |      |
| BusinessGUID            | 业务GUID                       |      |
| BusinessType            | 业务类型，默认为：日常报销     |      |
| ContractGUID            | 合同GUID                       |      |
| CorrespondingAmount     | 冲账对应科目金额               |      |
| CorrespondingAmountList | 冲账对应科目金额List           |      |
| CostFlag                | 预警/强控状态标识，此处默认为0 |      |
| CostGUID                | 科目GUID                       |      |
| DeptCostUseDtlGUID      | 部门费项使用明细GUID           |      |
| DeptGUID                | 责任部门GUID                   |      |
| DeptName                | 责任部门                       |      |
| EntryCostCode           |                                |      |
| EntryCostGUID           | 入账科目                       |      |
| EntryCostName           |                                |      |
| FluentCostFullName      | 冲账对应科目                   |      |
| FluentLoanGUID          | 借款单guid                     |      |
| FtAmount                | 分摊金额（￥）                 |      |
| LoanBalance             | 借款余额                       |      |
| LoanFtDetailGUIDList    | 冲账对应科目GUID               |      |
| Month                   | 月，当前月份                   |      |
| PaymentGUID             | 付款单位GUID                   |      |
| PaymentName             | 付款单位                       |      |
| ProceedingGUID          | 事项GUID                       |      |
| UsedAmount              | 使用金额，新增默认为0          |      |
| Year                    | 年，当前年度                   |      |
| ZrrGUID                 | 费用使用人GUID                 |      |
| ZrrName                 | 费用使用人                     |      |

#### 1.6.9.5 合同口径-已发生

```

declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.EmolumentGUID                                                               薪酬单主键,
       a.ApproveState                                                                薪酬单审核状态,
       a.EmolumentCode                                                               薪酬单编号,
       a.EmolumentName                                                               薪酬单主题,
       a.jbrname                                                                     经办人名称,
       a.jbDate                                                                      经办日期,
       a.Year                                                                        年,
       a.Month                                                                       月,
       a.EmolumentAmount                                                             薪资总额,
       a.DeptGUID                                                                    经办部门标识,
       e.BUName                                                                      经办部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.BUName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       a.Year + '-' + a.Month AS                                                     分摊分摊年月,
       b.BudgetGUID                                                                  分摊预算主体标识,
       g.ProviderName                                                                分摊预算主体名称
from dbo.fy_Emolument                a
         JOIN      ys_DeptCostUseDtl b ON a.EmolumentGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.DeptGUID = e.BUGUID
         Left join myBusinessUnit    f on b.DeptGUID = f.BUGUID
         Left join p_Provider        g on b.BudgetGUID = g.ProviderGUID
where a.ApproveState = '已审核'
  and a.Year = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```



#### 1.6.9.6 合同口径-在途

```

declare @UnitGUID uniqueidentifier ,-- 部门标识
 @CostGUID uniqueidentifier ,-- 科目标识
@Year int -- 年份
set @UnitGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30';
set @CostGUID = 'B51B57F7-7744-E911-AADB-00155D0A1C3E'
set @Year = 2020;
select a.EmolumentGUID                                                               薪酬单主键,
       a.ApproveState                                                                薪酬单审核状态,
       a.EmolumentCode                                                               薪酬单编号,
       a.EmolumentName                                                               薪酬单主题,
       a.jbrname                                                                     经办人名称,
       a.jbDate                                                                      经办日期,
       a.Year                                                                        年,
       a.Month                                                                       月,
       a.EmolumentAmount                                                             薪资总额,
       a.DeptGUID                                                                    经办部门标识,
       e.BUName                                                                      经办部门名称,
       b.DeptGUID                                                                    分摊预算部门标识,
       f.BUName                                                                      分摊预算部门名称,
       b.ProceedingGUID                                                              分摊事项标识,
       CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END 分摊事项名称,
       b.CostGUID                                                                    分摊科目标识,
       d.CostCode                                                                    分摊科目编码,
       d.CostShortName                                                               分摊科目名称,
       b.FtAmount                                                                    分摊金额,
       ZrrGUID                                                                       分摊使用人标识,
       a.Year + '-' + a.Month AS                                                     分摊分摊年月,
       b.BudgetGUID                                                                  分摊预算主体标识,
       g.ProviderName                                                                分摊预算主体名称
from dbo.fy_Emolument                a
         JOIN      ys_DeptCostUseDtl b ON a.EmolumentGUID = b.BusinessGUID
         LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
         LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
         Left JOIN myBusinessUnit    e ON a.DeptGUID = e.BUGUID
         Left join myBusinessUnit    f on b.DeptGUID = f.BUGUID
         Left join p_Provider        g on b.BudgetGUID = g.ProviderGUID
where a.ApproveState = '审核中'
  and a.Year = @Year
  and b.DeptGUID in
      (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END SpecialUnitGUID
       from dbo.ys_SpecialBusinessUnit           A
                LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
       WHERE A.Year = @Year
         AND (A.SpecialUnitGUID = @UnitGUID OR A.BUGUID = @UnitGUID OR A.ParentGUID = @UnitGUID))
  and b.CostGUID = @CostGUID
```

#### 1.6.9.7 支付口径-已发生

```

select emo.EmolumentGUID                                                                                         as guid,
       emo.ApproveState,
       emo.EmolumentCode,
       '<a href="javascript:parent.parent.openxcwin(''' + emo.ApproveState + ''',''' +
       cast(emo.EmolumentGUID as varchar(50)) + ''',' + cast(d.isendcost as varchar(1)) + ')" title="' +
       +convert(varchar(max),emo.EmolumentName) + '">' + convert(varchar(max),emo.EmolumentName) +
       '</a>'                                                                                                    as subject,
       emo.EmolumentAmount,
       emo.jbrName,
       emo.jbDate,
       b.ftamount,
       case when b.proceedingguid = b.deptguid then '日常费用'
            else c.proceedingname end                                                                            as proceedingname,
       d.costshortname,
       e.buname,
       b.proceedingguid,
       b.costguid,
       b.deptguid,
       b.year,
       zrrguid,
       d.costcode,
       b.month                                                                                                   as ftmonth,
       '薪酬发放'                                                                                                    as billtype,
       7                                                                                                         as sortnum,
       (select isnull(sum(payamount),0)
        from dbo.ys_pay
        where businesstype = '薪酬发放'
          and vouchguid = v.vouchguid)                                                                           as sfje,
       emo.jbDate                                                                                                as ftrq,
       v.ShDate                                                                                                  AS shdate
from fy_emolument                    emo
         left join ys_deptcostusedtl b on emo.emolumentguid = b.businessguid and b.businesstype = '薪酬发放'
         left join ys_proceeding     c on b.proceedingguid = c.proceedingguid
         left join ys_deptcost       d on b.costguid = d.deptcostguid
         left join mybusinessunit    e on emo.deptguid = e.buguid
         left join dbo.ys_voucher    v on emo.emolumentguid = v.businessguid and b.paymentguid = v.payproviderguid
where emo.approvestate in ('已审核')
  and (v.approvestate is not null and v.approvestate = '已审核')
  and DeptGUID IN (SELECT SpecialUnitGUID
                   from (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID
                                     ELSE b.SpecialUnitGUID END AS SpecialUnitGUID
                         from dbo.ys_SpecialBusinessUnit           A
                                  LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
                         WHERE A.Year = '2020' AND A.SpecialUnitGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4'
                            OR A.BUGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4'
                            OR A.ParentGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4') C)
  and CostGUID = '357E054D-8B2B-EA11-A13F-00505692B478'
  and (v.ShDate >= '2020-12-01 00:00:00' AND v.ShDate < '2021-01-01 00:00:00')
```



#### 1.6.9.8 支付口径-在途

```
select emo.EmolumentGUID                                                             as guid,
                      emo.ApproveState,
                      emo.EmolumentCode,
                      '<a href="javascript:parent.parent.openxcwin(''' + emo.ApproveState + ''',''' +
                      cast(emo.EmolumentGUID as varchar(50)) + ''',' + cast(d.isendcost as varchar(1)) + ')" title="' +
                      +convert(varchar(max),emo.EmolumentName) + '">' + convert(varchar(max),emo.EmolumentName) +
                      '</a>'                                                                        as subject,
                      emo.EmolumentAmount,
                      emo.jbrName,
                      emo.jbDate,
                      b.ftamount,
                      case when b.proceedingguid = b.deptguid then '日常费用' else c.proceedingname end as proceedingname,
                      d.costshortname,
                      e.buname,
                      b.proceedingguid,
                      b.costguid,
                      b.deptguid,
                      b.year,
                      zrrguid,
                      d.costcode,
                      b.month                                                                       as ftmonth,
                      '薪酬发放'                                                                        as billtype,
                      7                                                                             as sortnum,
                      pay.sumdcamount                                                               as sfje,
                      emo.jbDate                                                                    as ftrq
               from fy_Emolument                     emo
                        left join ys_deptcostusedtl  b on emo.EmolumentGUID = b.businessguid and b.businesstype = '薪酬发放'
                        left join ys_proceeding      c on b.proceedingguid = c.proceedingguid
                        left join ys_deptcost        d on b.costguid = d.deptcostguid
                        left join mybusinessunit     e on emo.DeptGUID = e.buguid
                        left join dbo.ys_Voucher     v
                                  ON b.PaymentGUID = v.PayProviderGUID and emo.EmolumentGUID = v.businessguid
                        left join (select isnull(sum(payamount),0) as sumdcamount, PayGUID, MAX(vouchguid) vouchguid
                                   from dbo.ys_pay
                                   where businesstype = '薪酬发放'
                                   group by PayGUID) pay on pay.VouchGUID = v.VouchGUID

               where (emo.ApproveState IN ('已审核', '审核中') AND (v.ApproveState IS NULL OR v.ApproveState <> '已审核'))
                and b.DeptGUID IN (SELECT SpecialUnitGUID
                         from (SELECT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID
                                           ELSE b.SpecialUnitGUID END AS SpecialUnitGUID
                               from dbo.ys_SpecialBusinessUnit           A
                                        LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
                               WHERE A.Year = '2020' AND A.SpecialUnitGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4'
                                  OR A.BUGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4'
                                  OR A.ParentGUID = 'ea222cf8-0d2d-ea11-a13a-00505692dff4') C)
        and CostGUID = '357E054D-8B2B-EA11-A13F-00505692B478'
        and emo.jbDate >= '2020-12-01 00:00:00'
        AND emo.jbDate < '2021-01-01 00:00:00'
```

### 1.6.10 付款登记-薪酬发放

### 1.6.11 付款登记-日常报销

### 1.6.12 付款登记-借款

### 1.6.13 付款登记-合同付款

### 1.6.14 付款登记-付款单审核

### 1.6.15 付款登记-发票管理

## 1.7 费用执行逻辑

### 1.7.1 申请单

#### 1.7.1.1 列表查询

    ```
    SELECT TOP 20 a.ApplyGUID  ,a.FtBeginDate,
                            a.ApplyTypeGUID ,
                            a.ApproveState ,
                            a.ApplySubject ,
                            a.ApplyTypeName ,
                            a.ApplyAmount ,
                            a.UsedApplyAmount ,
                            a.LoanAmount ,
                            a.ApplyDate ,
                            a.Applier ,
                            a.DeptName ,
                            a.DeptGUID ,
                            CASE WHEN IsInvalid = '是' THEN IsInvalid ELSE '' END AS IsInvalid
    
                        FROM vfy_Apply a
                        WHERE ( (1=1 AND ( 1=1 )) ) AND (  (a.HierarchyCode = 'zb.1' or  a.HierarchyCode like 'zb.1.%')  AND a.HierarchyCode in ( select AA.HierarchyCode from dbo.myBusinessUnit AA inner join ( select HierarchyCode from dbo.myBusinessUnit where  ParentGUID = '38da7886-bc9e-4431-b065-1c02ec79f80f' and BUType = 1 ) BB on (AA.HierarchyCode = BB.HierarchyCode OR AA.HierarchyCode like BB.HierarchyCode + '.%') and AA.BUType = 1 )  and a.ApplierGUID='4230bc6e-69e6-46a9-a39e-b929a06a84e8' )
                         ORDER BY a.ApplyDate DESC,a.ApplyGUID
    ```

#### 1.7.1.2 修改加载

1. 该申请单费用科目明细

   ```
                     SELECT  fy_Apply_FtDetail_Period.FtDetailPeriodGUID ,
                     fy_Apply_FtDetail_Period.DeptGUID ,
                     fy_Apply_FtDetail_Period.DeptName ,
                     fy_Apply_FtDetail_Period.ProceedingGUID ,
                     fy_Apply_FtDetail_Period.ProceedingName ,
                     fy_Apply_FtDetail_Period.CostGUID ,
                     fy_Apply_FtDetail_Period.CostCode ,
                     fy_Apply_FtDetail_Period.CostShortName ,
                     fy_Apply_FtDetail_Period.FtAmount ,
                     fy_Apply_FtDetail_Period.RefAmount ,
                     fy_Apply_FtDetail_Period.ApplyGUID ,
                     fy_Apply_FtDetail_Period.FtYear ,
                     fy_Apply_FtDetail_Period.FtMonth,
                     dbo.fn_ys_GetCostFullName(CostGUID,null) as CostFullName,
                     CAST(fy_Apply_FtDetail_Period.FtYear AS VARCHAR(4))+ '-' + RIGHT('0'+CAST(fy_Apply_FtDetail_Period.FtMonth AS VARCHAR(4)),2) AS YearMonth
                     FROM    dbo.fy_Apply_FtDetail_Period
                     where 1=1 AND ApplyGUID ='ea780b87-3610-11eb-9bf4-1c697a57d7cc'
                     order by  fy_Apply_FtDetail_Period.DeptGUID,
                     fy_Apply_FtDetail_Period.ProceedingGUID,
                     fy_Apply_FtDetail_Period.CostGUID,
                     fy_Apply_FtDetail_Period.FtYear,
                     fy_Apply_FtDetail_Period.FtMonth
   
   ```

2. 付款单位

   ```
             SELECT x.ProjGUID,x.ProviderGUID,z.ProviderName FROM (
             select ProjGUID,NULL AS ProviderGUID from dbo.p_Project a
             where  Level=2 AND EXISTS(select TOP 1 1 from dbo.p_Project b where BUGUID=('38da7886-bc9e-4431-b065-1c02ec79f80f') AND b.ParentCode=a.ProjCode AND b.ProjStatus<>'结案')
             AND ProjGUID NOT IN(select ProjGUID from dbo.fy_Project2ProviderSetting c where BUGUID=('38da7886-bc9e-4431-b065-1c02ec79f80f') AND ( Year=2020))
             UNION ALL
             select ProjGUID,ProviderGUID from fy_Project2ProviderSetting  where BUGUID=('38da7886-bc9e-4431-b065-1c02ec79f80f') AND  ( Year=2020)
             ) x
             LEFT JOIN p_project y ON x.ProjGUID=y.ProjGUID
             LEFT JOIN dbo.p_Provider z ON x.ProviderGUID=z.ProviderGUID
             ORDER BY y.ProjCode
   
   ```

3. 付款审批类型

   ```
   exec sp_executesql N'SELECT ApplicationAmount FROM fy_FKSPType where FKSPTypeGUID=@FKSPTypeGUID and ISApplicationAmountControl=1',N'@FKSPTypeGUID nvarchar(36)',@FKSPTypeGUID=N'4a9b2a75-e215-eb11-a558-00155d0a2516'
   ```

#### 1.7.1.3 提交审批

```
exec sp_executesql N'update [fy_Apply] set  [DeptGUID] = @DeptGUID ,  [DeptName] = @DeptName ,  [ApproveState] = @ApproveState ,  [ApplySubject] = @ApplySubject ,  [ApplyAmount] = @ApplyAmount ,  [Applier] = @Applier ,
[ApplierGUID] = @ApplierGUID ,  [ApplyDate] = @ApplyDate ,  [ApplyTypeGUID] = @ApplyTypeGUID ,  [ApplyType] = @ApplyType ,  [Remark] = @Remark ,  [IsLoan] = @IsLoan ,  [LoanAmount] = @LoanAmount ,  [LoanReason] =
@LoanReason ,  [PayProviderName] = @PayProviderName ,  [ReceiveType] = @ReceiveType ,  [ReceiverName] = @ReceiverName ,  [ReceiveProviderName] = @ReceiveProviderName ,  [IsInvalid] = @IsInvalid ,  [CrossYearAmount] = @CrossYearAmount ,  [FtBeginDate] = @FtBeginDate ,  [FtPeriod] = @FtPeriod ,  [HasBeenUsed] = @HasBeenUsed ,  [UsedApplyAmount] = @UsedApplyAmount ,  [PaymentUnitGUID] = @PaymentUnitGUID ,  [PaymentUnit] = @PaymentUnit where  [ApplyGUID] = @ApplyGUID',
     N'@DeptGUID uniqueidentifier,@DeptName nvarchar(4),@ApproveState nvarchar(3),@ApplySubject nvarchar(3),@ApplyAmount decimal(6,4),@Applier nvarchar(4),@ApplierGUID uniqueidentifier,@ApplyDate datetime,@ApplyTypeGUID uniqueidentifier,@ApplyType nvarchar(8),@Remark nvarchar(3),@IsLoan nvarchar(1),@LoanAmount decimal(4,4),@LoanReason nvarchar(4000),@PayProviderName nvarchar(4000),@ReceiveType nvarchar(3),@ReceiverName nvarchar(4000),@ReceiveProviderName nvarchar(4000),@IsInvalid nvarchar(1),@CrossYearAmount decimal(4,4),@FtBeginDate datetime,@FtPeriod tinyint,@HasBeenUsed bit,@UsedApplyAmount decimal(4,4),@PaymentUnitGUID uniqueidentifier,@PaymentUnit nvarchar(7),@ApplyGUID uniqueidentifier',
     @DeptGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@DeptName=N'测试部门',@ApproveState=N'审核中',@ApplySubject=N'水电费',
     @ApplyAmount=20.0000,@Applier=N'订单系统',@ApplierGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',
     @ApplyDate='2020-12-04 00:00:00',@ApplyTypeGUID='4A9B2A75-E215-EB11-A558-00155D0A2516',@ApplyType=N'节日福利项目开销',
     @Remark=N'水电费',@IsLoan=N'否',@LoanAmount=0.0000,@LoanReason=N'',@PayProviderName=N'',@ReceiveType=N'收款人',
     @ReceiverName=N'',@ReceiveProviderName=N'',@IsInvalid=N'否',@CrossYearAmount=0.0000,
     @FtBeginDate='2020-12-04 00:00:00',@FtPeriod=1,@HasBeenUsed=0,@UsedApplyAmount=0.0000,
     @PaymentUnitGUID='488F2FB9-2E72-E911-B398-00155D0A1C30',@PaymentUnit=N'测试分类001',@ApplyGUID='EA780B87-3610-11EB-9BF4-1C697A57D7CC'
```



	UPDATE ys_YearPlanProceeding2Cost 
	            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 10.0000 ,
	                FactAmount12 = ISNULL(FactAmount12,0) + 10.0000 
	            WHERE DeptGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND ProceedingGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND Year=2020 
	                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
	            
	            UPDATE ys_YearPlanDept2Cost 
	            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 10.0000  ,
	                FactAmount12 = ISNULL(FactAmount12,0) + 10.0000 
	            WHERE DeptGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND Year=2020 
	                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
	            
	            UPDATE ys_YearPlanProceeding2Cost 
	            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 10.0000 ,
	                FactAmount12 = ISNULL(FactAmount12,0) + 10.0000 
	            WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
	                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
	            
	            UPDATE ys_YearPlanDept2Cost 
	            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 10.0000  ,
	                FactAmount12 = ISNULL(FactAmount12,0) + 10.0000 
	            WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
	                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;

#### 1.7.1.4 审批通过

```
exec sp_executesql N'update [fy_Apply] set  [DeptGUID] = @DeptGUID ,  [DeptName] = @DeptName ,  [ApproveState] = @ApproveState ,  [ApplySubject] = @ApplySubject ,  [ApplyAmount] = @ApplyAmount ,  [Applier] = @Applier ,  
[ApplierGUID] = @ApplierGUID ,  [ApplyDate] = @ApplyDate ,  [ApplyTypeGUID] = @ApplyTypeGUID ,  [ApplyType] = @ApplyType ,  [Remark] = @Remark ,  [IsLoan] = @IsLoan ,  [LoanAmount] = @LoanAmount ,  [LoanReason] = 
@LoanReason ,  [PayProviderName] = @PayProviderName ,  [ReceiveType] = @ReceiveType ,  [ReceiverName] = @ReceiverName ,  [ReceiveProviderName] = @ReceiveProviderName ,  [IsInvalid] = @IsInvalid ,  [CrossYearAmount] = @CrossYearAmount ,  [FtBeginDate] = @FtBeginDate ,  [FtPeriod] = @FtPeriod ,  [HasBeenUsed] = @HasBeenUsed ,  [UsedApplyAmount] = @UsedApplyAmount ,  [PaymentUnitGUID] = @PaymentUnitGUID ,  [PaymentUnit] = @PaymentUnit where  [ApplyGUID] = @ApplyGUID',
     N'@DeptGUID uniqueidentifier,@DeptName nvarchar(4),@ApproveState nvarchar(3),@ApplySubject nvarchar(3),@ApplyAmount decimal(6,4),@Applier nvarchar(4),@ApplierGUID uniqueidentifier,@ApplyDate datetime,@ApplyTypeGUID uniqueidentifier,@ApplyType nvarchar(8),@Remark nvarchar(3),@IsLoan nvarchar(1),@LoanAmount decimal(4,4),@LoanReason nvarchar(4000),@PayProviderName nvarchar(4000),@ReceiveType nvarchar(3),@ReceiverName nvarchar(4000),@ReceiveProviderName nvarchar(4000),@IsInvalid nvarchar(1),@CrossYearAmount decimal(4,4),@FtBeginDate datetime,@FtPeriod tinyint,@HasBeenUsed bit,@UsedApplyAmount decimal(4,4),@PaymentUnitGUID uniqueidentifier,@PaymentUnit nvarchar(7),@ApplyGUID uniqueidentifier',
     @DeptGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@DeptName=N'测试部门',@ApproveState=N'已审核',@ApplySubject=N'水电费',
     @ApplyAmount=20.0000,@Applier=N'订单系统',@ApplierGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',
     @ApplyDate='2020-12-04 00:00:00',@ApplyTypeGUID='4A9B2A75-E215-EB11-A558-00155D0A2516',@ApplyType=N'节日福利项目开销',
     @Remark=N'水电费',@IsLoan=N'否',@LoanAmount=0.0000,@LoanReason=N'',@PayProviderName=N'',@ReceiveType=N'收款人',
     @ReceiverName=N'',@ReceiveProviderName=N'',@IsInvalid=N'否',@CrossYearAmount=0.0000,
     @FtBeginDate='2020-12-04 00:00:00',@FtPeriod=1,@HasBeenUsed=0,@UsedApplyAmount=0.0000,
     @PaymentUnitGUID='488F2FB9-2E72-E911-B398-00155D0A1C30',@PaymentUnit=N'测试分类001',@ApplyGUID='EA780B87-3610-11EB-9BF4-1C697A57D7CC'
```

#### 1.7.1.5 审批驳回

```
exec sp_executesql N'SELECT  COUNT(1)
                        FROM    ( 
		                          SELECT  ApplyGUID FROM cb_Contract WHERE   ContractGUID <> @billguid
                                  UNION ALL
                                  SELECT  ApplyGUID FROM cb_Expense WHERE   ExpenseGUID <> @billguid
                                  UNION ALL
                                  SELECT RelateApplyGUID AS ApplyGUID FROM dbo.cb_Loan WHERE LoanGUID<>@billguid
                                ) a
                        WHERE ApplyGUID=@ApplyGUID',N'@ApplyGUID uniqueidentifier,@billguid uniqueidentifier',@ApplyGUID='EA780B87-3610-11EB-9BF4-1C697A57D7CC',@billguid='00000000-0000-0000-0000-000000000000'
```

```
SELECT top 1[ApplyGUID], [DeptGUID], [DeptName], [ApproveState], [ApplySubject], [ApplyAmount], [Applier], [ApplierGUID], [ApplyDate], [ApplyTypeGUID], [ApplyType], [Remark], [IsLoan], [LoanGUID], [LoanAmount], [LoanReason], [PayProviderGUID], [PayProviderName], [ReceiveType], [ReceiverGUID], [ReceiverName], [ReceiveProviderName], [ReceiveProviderGUID], [IsInvalid], [IsCrossYear], [CrossYearAmount], [ApplyCancelState], [IsUseOtherFee], [FtBeginDate], [FtPeriod], [HasBeenUsed], [UsedApplyAmount], [PaymentUnitGUID], [PaymentUnit], [IsRelease]
FROM fy_Apply
WHERE (ApplyGUID ='ea780b87-3610-11eb-9bf4-1c697a57d7cc')
```

```
SELECT [FtDetailGUID],
       [DeptGUID],
       [DeptName],
       [ProceedingGUID],
       [ProceedingName],
       [CostGUID],
       [CostCode],
       [CostShortName],
       [Amount],
       [RefAmount],
       [LoanAmount],
       [ApplyGUID],
       [HasBeenUsed]
FROM fy_Apply_FtDetail
WHERE (ApplyGUID = 'ea780b87-3610-11eb-9bf4-1c697a57d7cc')
```

```
SELECT [FtDetailPeriodGUID],
       [DeptGUID],
       [DeptName],
       [ProceedingGUID],
       [ProceedingName],
       [CostGUID],
       [CostCode],
       [CostShortName],
       [FtAmount],
       [RefAmount],
       [ApplyGUID],
       [FtYear],
       [FtMonth]
FROM fy_Apply_FtDetail_Period
WHERE (ApplyGUID = 'ea780b87-3610-11eb-9bf4-1c697a57d7cc')
```

```
exec sp_executesql
     N'SELECT COUNT(0) AS CNT FROM dbo.fy_YearCarryOver WHERE BizGUID=@BizGUID AND BalanceState=''已结转执行''',
     N'@BizGUID uniqueidentifier',@BizGUID='EA780B87-3610-11EB-9BF4-1C697A57D7CC'
```

```
exec sp_executesql N'update [fy_Apply] set  [DeptGUID] = @DeptGUID ,  [DeptName] = @DeptName ,  [ApproveState] = @ApproveState ,  [ApplySubject] = @ApplySubject ,  [ApplyAmount] = @ApplyAmount ,  [Applier] = @Applier ,
[ApplierGUID] = @ApplierGUID ,  [ApplyDate] = @ApplyDate ,  [ApplyTypeGUID] = @ApplyTypeGUID ,  [ApplyType] = @ApplyType ,  [Remark] = @Remark ,  [IsLoan] = @IsLoan ,  [LoanAmount] = @LoanAmount ,  [LoanReason] =
@LoanReason ,  [PayProviderName] = @PayProviderName ,  [ReceiveType] = @ReceiveType ,  [ReceiverName] = @ReceiverName ,  [ReceiveProviderName] = @ReceiveProviderName ,  [IsInvalid] = @IsInvalid ,  [CrossYearAmount] = @CrossYearAmount ,  [FtBeginDate] = @FtBeginDate ,  [FtPeriod] = @FtPeriod ,  [HasBeenUsed] = @HasBeenUsed ,  [UsedApplyAmount] = @UsedApplyAmount ,  [PaymentUnitGUID] = @PaymentUnitGUID ,  [PaymentUnit] = @PaymentUnit where  [ApplyGUID] = @ApplyGUID',
     N'@DeptGUID uniqueidentifier,@DeptName nvarchar(4),@ApproveState nvarchar(3),@ApplySubject nvarchar(3),@ApplyAmount decimal(6,4),@Applier nvarchar(4),@ApplierGUID uniqueidentifier,@ApplyDate datetime,@ApplyTypeGUID uniqueidentifier,@ApplyType nvarchar(8),@Remark nvarchar(3),@IsLoan nvarchar(1),@LoanAmount decimal(4,4),@LoanReason nvarchar(4000),@PayProviderName nvarchar(4000),@ReceiveType nvarchar(3),@ReceiverName nvarchar(4000),@ReceiveProviderName nvarchar(4000),@IsInvalid nvarchar(1),@CrossYearAmount decimal(4,4),@FtBeginDate datetime,@FtPeriod tinyint,@HasBeenUsed bit,@UsedApplyAmount decimal(4,4),@PaymentUnitGUID uniqueidentifier,@PaymentUnit nvarchar(7),@ApplyGUID uniqueidentifier',
     @DeptGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@DeptName=N'测试部门',@ApproveState=N'未审核',@ApplySubject=N'水电费',
     @ApplyAmount=20.0000,@Applier=N'订单系统',@ApplierGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',
     @ApplyDate='2020-12-04 00:00:00',@ApplyTypeGUID='4A9B2A75-E215-EB11-A558-00155D0A2516',@ApplyType=N'节日福利项目开销',
     @Remark=N'水电费',@IsLoan=N'否',@LoanAmount=0.0000,@LoanReason=N'',@PayProviderName=N'',@ReceiveType=N'收款人',
     @ReceiverName=N'',@ReceiveProviderName=N'',@IsInvalid=N'否',@CrossYearAmount=0.0000,
     @FtBeginDate='2020-12-04 00:00:00',@FtPeriod=1,@HasBeenUsed=0,@UsedApplyAmount=0.0000,
     @PaymentUnitGUID='488F2FB9-2E72-E911-B398-00155D0A1C30',@PaymentUnit=N'测试分类001',@ApplyGUID='EA780B87-3610-11EB-9BF4-1C697A57D7CC'
```

```
UPDATE ys_YearPlanProceeding2Cost 
            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 10.0000 ,
                FactAmount12 = ISNULL(FactAmount12,0) - 10.0000 
            WHERE DeptGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND ProceedingGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND Year=2020 
                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
            
            UPDATE ys_YearPlanDept2Cost 
            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 10.0000  ,
                FactAmount12 = ISNULL(FactAmount12,0) - 10.0000 
            WHERE DeptGUID='036ed2f0-7adf-11ea-8b09-00155d0a1c30' AND Year=2020 
                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
            
            UPDATE ys_YearPlanProceeding2Cost 
            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 10.0000 ,
                FactAmount12 = ISNULL(FactAmount12,0) - 10.0000 
            WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
            
            UPDATE ys_YearPlanDept2Cost 
            SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 10.0000  ,
                FactAmount12 = ISNULL(FactAmount12,0) - 10.0000 
            WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                  AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;            
```



### 1.7.2 合同登记

#### 1.7.2.1 列表查询

1. 合同类型

   ```
   SELECT HtTypeGUID, HtTypeShortName, Typecode, HtTypeCode, HtTypeName
   FROM vcb_HtType
   WHERE (1 = 1)
     AND BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
     AND (IsCostControl = 1 OR HtTypeCode = 'ALL')
   ORDER BY Typecode
   ```

2. 合同列表

   ```
   SELECT TOP 20 ProjectName,
                  ContractGUID,
                  HtTypeCode,
                  vcb_ContractGrid.BUGUID,
                  IsJtContract,
                  ApproveState,
                  CASE WHEN ProjType = '公司库存' THEN '单价合同' ELSE ProjType END  AS ProjType,
                  isUseYgAmount,
                  ApproveStateFlag,
                  JsState,
                  MasterContractGUID,
                  IfDdhs,
                  HtCfStateShow,
                  CfMode,
                  HtClass,
                  ContractCode,
                  '<a href="javascript:void(0);"  >' + ContractName + '</a>' as ContractName,
                  HtAmount,
                  SignDate,
                  YfProviderName,
                  YfCorporation,
                  jbrGUID,
                  ProcessGUID,
                  IsLock,
                  (CASE WHEN IsLock = 1 THEN '已锁定' ELSE '未锁定' END)           AS ShowLock,
                  CurrencyName,
                  HtAmount_Bz,
                  ApplyGUID,
                  ApplySubject,
                  FtBeginDate,
                  FtPeriod,
                  Htproperty,
                  ExcludingTaxHtAmount_Bz,
                  BUName,
                  InputTaxAmount_Bz
   FROM vcb_ContractGrid
            LEFT JOIN myWorkflowProcessEntity b
                      ON vcb_ContractGrid.ContractGUID = b.BusinessGUID AND ISNULL(b.IsHistory,0) = 0 AND
                         (b.BusinessType = '费用合同审批' OR b.BusinessType = '费用非合同审批' OR b.BusinessType = '费用非单独执行合同审批')
   WHERE ((((1 = 1 AND (JbDeptCode = 'zb.1.22' or JbDeptCode like 'zb.1.22.%')) AND 1 = 1) AND (1 = N'1')))
     AND ((9 = 9))
     AND vcb_ContractGrid.BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
     AND IsFyControl = 1
   ORDER BY vcb_ContractGrid.ContractCode DESC, vcb_ContractGrid.ContractGUID
   ```

   

#### 1.7.2.2 修改加载

1. 获取合约规划表

   ```
   SELECT BudgetGUID, TimeStampVer
   FROM cb_Budget
   WHERE BudgetGUID IN
         (SELECT DISTINCT BudgetGUID FROM cb_BudgetUse WHERE ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516')
   ```

   

2. 获取主合同

   ```
   SELECT ContractGUID FROM cb_Contract WHERE MasterContractGUID='3a5133f3-5a38-eb11-a55a-00155d0a2516'
   ```

   

3. 合同付款条件

   ```
   SELECT ''                                                                          as rowid,
          1                                                                           as entity,
          HTFKConditionGUID,
          ContractGUID,
          FKRate,
          FKAmount,
          FKCondition,
          (CASE WHEN FKDate IS NULL THEN '' ELSE Convert(varchar(10),FKDate,120) END) as FKDate,
          FKType,
          FKName
   FROM cb_HTFKCondition
   WHERE ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516'
   ORDER BY FKDate 
   ```

   

4. 币种

   ```
   SELECT CurrencyGUID,CurrencyName,Rate FROM cb_Currency
   ```

   

5. 合同主信息

   ```
   SELECT Contract2CgProcGUID,
          ContractGUID,
          BUGUID,
          HtTypeCode,
          HtKind,
          ContractCode,
          ContractName,
          HtClass,
          SignMode,
          CostProperty,
          DeptGUID,
          Jbr,
          SignDate,
          JfCorporation,
          YfCorporation,
          BfCorporation,
          HtProperty,
          IfDdhs,
          MasterContractGUID,
          TotalAmount,
          BjcbAmount,
          ItemAmount,
          HtAmount,
          ItemDtAmount,
          HtycAmount,
          JsState,
          ZjsAmount,
          JsAmount,
          JsBxAmount,
          JsOtherDeduct,
          JsItemDeduct,
          LocaleAlterAmount,
          DesignAlterAmount,
          OtherAlterAmount,
          BalanceAdjustAmount,
          SumALterAmount,
          SumYfAmount,
          SumScheduleAmount,
          SumFactAmount,
          ConfirmJhfkAmount,
          IfConfirmFkPlan,
          SumPayAmount,
          LandSource,
          LandUseLimit,
          BuildArea,
          LandProperty,
          LandUse,
          LandRemarks,
          BeginDate,
          EndDate,
          WorkPeriod,
          BxAmount,
          BxLimit,
          PerformBail,
          PerformRemarks,
          TechnicRemarks,
          RewardRemarks,
          BreachRemarks,
          TermRemarks,
          ApproveState,
          ApproveDate,
          ApprovedBy,
          CfMode,
          YcfAmount,
          HtCfState,
          AlterCfState,
          FactCfAmount,
          FactCfState,
          PayCfState,
          ItemCfAmount,
          ItemCfState,
          HtycCfAmount,
          HtycCfState,
          FinanceHsxmCode,
          FinanceHsxmName,
          ApproveLog,
          ProcessStatusContract,
          TacticProtocolGUID,
          CgPlanGUID,
          JfProviderGUID,
          YfProviderGUID,
          BfProviderGUID,
          IsJtContract,
          Bz,
          Rate,
          SumScheduleAmount_Bz,
          SumPayAmount_Bz,
          SumAlterAmount_Bz,
          SumYfAmount_Bz,
          JsAmount_Bz,
          ZjsAmount_Bz,
          HtAmount_Bz,
          JsOtherDeduct_Bz,
          JbrGUID,
          CASE WHEN ProjType = '公司库存' THEN '单价合同' ELSE ProjType END AS ProjType,
          JfProviderName,
          YfProviderName,
          BfProviderName,
          ContractCodeFormat,
          UseStockInfo,
          ApproveStateFlag,
          HtCfStateShow,
          UseCostInfo,
          UseCostColor,
          IsLock,
          HtTypeName,
          HtTypeGUID,
          JbDeptName,
          JbDeptCode,
          MasterContractCode,
          MasterContractName,
          BUName,
          CgPlanName,
          TacticProtocolname,
          CurrencyName,
          ProjCode,
          ProjectCode,
          ProjName,
          SchedulePayRate,
          ProjectPlanAffect,
          HsCfState,
          DeptUseInfo,
          ContractBound,
          PayMode,
          QualityRequest,
          BXAssumpsit,
          ''                                                        as BM,
          'HT'                                                      as ContractType,
          '合同登记'                                                    as DocType,
          ''                                                        as ProjGUIDList,
          ProjName                                                  as ProjectNameList,
          ProjCode                                                  as ProjectCodeList,
          isUseYgAmount,
          IsFyControl,
          ApplyGUID,
          ApplySubject,
          InputTaxAmount,
          InputTaxAmount_Bz,
          ExcludingTaxHtAmount,
          ExcludingTaxHtAmount_Bz,
          AverageTaxRate,
          BankName,
          BankAccount,
          IsPerformInvoiceControl,
          FtBeginDate,
          FtPeriod,
          DjhtGUID,
          DjhtName,
          MasterTotalAmount,
          SumMasterTotalAmount,
          EndTime
   FROM vcb_Contract
   WHERE (ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516')        
   ```

   

6. 合同分摊明细

   ```
   SELECT fy_Contract_FtDetail_Period.FtDetailGUID,
          fy_Contract_FtDetail_Period.DeptGUID,
          fy_Contract_FtDetail_Period.DeptName,
          fy_Contract_FtDetail_Period.ProceedingGUID,
          fy_Contract_FtDetail_Period.ProceedingName,
          fy_Contract_FtDetail_Period.CostGUID,
          fy_Contract_FtDetail_Period.CostCode,
          fy_Contract_FtDetail_Period.CostShortName,
          fy_Contract_FtDetail_Period.FtAmount,
          fy_Contract_FtDetail_Period.ContractGUID,
          fy_Contract_FtDetail_Period.FtYear,
          fy_Contract_FtDetail_Period.FtMonth,
          dbo.fn_ys_GetCostFullName(CostGUID,null)                               as CostFullName,
          CAST(fy_Contract_FtDetail_Period.FtYear AS VARCHAR(4)) + '-' +
          RIGHT('0' + CAST(fy_Contract_FtDetail_Period.FtMonth AS VARCHAR(4)),2) AS YearMonth,
          CASE WHEN cb_Contract.ApproveState = '已审核' THEN 0 ELSE 1 END           AS IsEdit
   FROM dbo.fy_Contract_FtDetail_Period
            LEFT JOIN dbo.cb_Contract ON cb_Contract.ContractGUID = fy_Contract_FtDetail_Period.ContractGUID
   where 1 = 1
     AND fy_Contract_FtDetail_Period.ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516'
   order by fy_Contract_FtDetail_Period.DeptGUID, fy_Contract_FtDetail_Period.ProceedingGUID,
            fy_Contract_FtDetail_Period.CostGUID, fy_Contract_FtDetail_Period.FtYear, fy_Contract_FtDetail_Period.FtMonth
           
   ```

   

7. 相关合同

   ```
   SELECT TOP 20 CurrencyName,
                 ContractGUID,
                 ContractCode,
                 ContractName,
                 HtAmount_Bz,
                 HtAmount,
                 SignDate,
                 YfProviderName,
                 YfCorporation
   FROM vcb_Contract
   WHERE ((MasterContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516') OR (ContractGUID = (select top 1 DjhtGUID
                                                                                            from cb_Contract
                                                                                            where ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516')) OR
          (DjhtGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516') AND (9 = 9))
     AND BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
     AND (168 = 168)
   ORDER BY vcb_Contract.ContractCode DESC, vcb_Contract.ContractGUID
   ```

#### 1.7.2.3 提交审批

1. 合同费用预算规划明细表

   ```
   SELECT a.DeptCost2ContractGUID,
          a.BusinessType,
          a.BusinessGUID,
          a.CostGUID,
          ISNULL(b.CostShortName,'')                       AS CostShortName,
          a.ZrrGUID,
          a.ZrrName,
          a.DeptGUID,
          a.DeptName,
          a.BudgetAmount,
          a.UseableAmount,
          b.CostCode,
          dbo.fn_ys_GetCostFullName(b.DeptCostGUID,b.Year) AS CostFullName,
          a.ProceedingName,
          a.ProceedingGUID,
          q.Year
   FROM ys_DeptCost2ContractUseDtl               a
            LEFT JOIN ys_deptcost                b ON a.CostGUID = b.DeptCostGUID
            LEFT JOIN dbo.ys_SpecialBusinessUnit q ON q.SpecialUnitGUID = a.DeptGUID
   WHERE a.ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516'
     AND a.BusinessGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516'
   ```

   

2. 获取费用分摊科目

   ```
   exec sp_executesql N'SELECT  B.DeptName ,
           B.ProceedingName ,
           B.CostShortName
   FROM    ( SELECT  DISTINCT
                       DeptGUID ,
                       ProceedingGUID ,
                       CostGUID
             FROM      dbo.ys_DeptCost2ContractUseDtl
             WHERE     BusinessGUID = @ContractGUID
           ) A
           LEFT JOIN dbo.fy_Apply_FtDetail B ON B.CostGUID = A.CostGUID
                                                AND B.DeptGUID = A.DeptGUID
                                                AND B.ProceedingGUID = A.ProceedingGUID
                                                AND B.ProceedingGUID = A.ProceedingGUID
   WHERE   B.HasBeenUsed = 1
           AND B.ApplyGUID = @ApplyGUID',N'@ApplyGUID uniqueidentifier,@ContractGUID uniqueidentifier',@ApplyGUID='86B972A2-19D8-11EB-9825-54E1AD201170',@ContractGUID='3A5133F3-5A38-EB11-A55A-00155D0A2516'
   ```

3. 合同费用预算规划明细表

   ```
   exec sp_executesql N'--科目级别相等
                               SELECT  A.DeptName,A.ProceedingName,B.CostShortName
                               FROM    ys_DeptCost2ContractUseDtl A
                                       INNER JOIN ( SELECT C.HtAlterGUID AS BusinessGUID ,
                                                           C.DeptGUID ,
                                                           C.ProceedingGUID ,
                                                           C.CostGUID ,
                                                           C.CostShortName ,
                                                           CONVERT(MONEY, SUM(ISNULL(C.FtAmount, 0))) FtAmount
                                                    FROM   fy_HtAlter_FtDetail_Period C
                                                    GROUP BY C.HtAlterGUID ,
                                                           C.DeptGUID ,
                                                           C.ProceedingGUID ,
                                                           C.CostGUID ,
                                                           C.CostShortName
                                                  ) B ON B.BusinessGUID = A.BusinessGUID
                                                         AND B.CostGUID = A.CostGUID
                                                         AND B.DeptGUID = A.DeptGUID
                                                         AND B.ProceedingGUID = A.ProceedingGUID
                               WHERE   A.BudgetAmount <> B.FtAmount AND A.BusinessGUID=@BusinessGUID',N'@BusinessGUID uniqueidentifier',@BusinessGUID='3A5133F3-5A38-EB11-A55A-00155D0A2516'
   ```

   

4. 合约规划使用表

   ```
   exec sp_executesql N'SELECT p.ProjName,
                                                           bu.TaxRateCfAmountName,
                                                           bu.TaxRateCfAmount,
                                                           bu.CfAmount,
                                                           c2t.TaxAmount,
                                                           ISNULL(bo1.ParamValue, ''0'') AS ygzEnableProject,
                                                           ISNULL(bo2.ParamValue, ''0'') AS isContractControl
                                                       FROM cb_BudgetUse bu
                                                           LEFT JOIN
                                                            (
                                                                SELECT TaxRate,
                                                                    SUM(TaxAmount) AS TaxAmount
                                                                FROM cb_Contract2Tax
                                                                WHERE ContractGUID = @ContractGUID
                                                                GROUP BY TaxRate
                                                            ) c2t
                                                               ON c2t.TaxRate = bu.TaxRateCfAmount
                                                           LEFT JOIN p_Project p
                                                               ON bu.ProjectCode = p.ProjCode
                                                           LEFT JOIN myBizParamOption bo1
                                                               ON bo1.ParamName = ''cb_YGZEnableProject''
                                                                  AND p.ProjGUID = bo1.ScopeGUID
                                                           LEFT JOIN myBizParamOption bo2
                                                               ON bo2.ParamName = ''cb_IsContractControl''
                                                                  AND p.ProjGUID = bo2.ScopeGUID
                                                       WHERE bu.RefGUID = @ContractGUID  ',
        N'@ContractGUID uniqueidentifier',@ContractGUID='3A5133F3-5A38-EB11-A55A-00155D0A2516'
   ```

   

5. 费用控制模式

   ```
   SELECT ISNULL((SELECT ISNULL(ControlMode,2) FROM dbo.fy_ControlModeSetting),2)
   ```

6. 更新合同费用预算规划明细

   ```
   UPDATE ys_DeptCost2ContractUseDtl
   SET UseableAmount = BudgetAmount
   WHERE BusinessType = '合同'
     AND BusinessGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516';
   UPDATE cb_Contract
   SET ApproveState='审核中',
       ApproveDate=getdate(),
       ApprovedBy='订单系统',
       IsLock=1
   WHERE ContractGUID = '3a5133f3-5a38-eb11-a55a-00155d0a2516'
   ```

7. 更新费用分摊明细

   ```
   exec sp_executesql N'
                       UPDATE fy_Apply_FtDetail 
                       SET HasBeenUsed = @HasBeenUsedFlag
                       WHERE ApplyGUID = @ApplyGUID
                       AND DeptGUID = @DeptGUID
                       AND ProceedingGUID = @ProceedingGUID
                       AND CostGUID = @CostGUID
                       ',N'@HasBeenUsedFlag int,@ApplyGUID uniqueidentifier,@DeptGUID uniqueidentifier,@ProceedingGUID uniqueidentifier,@CostGUID uniqueidentifier',@HasBeenUsedFlag=1,@ApplyGUID='86B972A2-19D8-11EB-9825-54E1AD201170',@DeptGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',@ProceedingGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',@CostGUID='B71B57F7-7744-E911-AADB-00155D0A1C3E'
   ```

8. 更新申请单被关联状态

   ```
   exec sp_executesql N'
                       UPDATE a
                       SET  a.HasBeenUsed = CASE WHEN (SELECT COUNT(1) FROM fy_Apply_FtDetail
   														WHERE ApplyGUID =  @ApplyGUID
   														AND ISNULL(HasBeenUsed,0) = 0) > 0 THEN 0 
   											 ELSE 1 END
                       FROM dbo.fy_Apply a
                       WHERE a.ApplyGUID = @ApplyGUID
                       ',N'@ApplyGUID uniqueidentifier',@ApplyGUID='86B972A2-19D8-11EB-9825-54E1AD201170'
   ```

9. 更新申请单金额

   ```
   exec sp_executesql N'
                       UPDATE fy_Apply
                       SET UsedApplyAmount = (
   					                    SELECT SUM(BudgetAmount) AS UsedApplyAmount FROM (
   											SELECT mainRef.ApplyGUID,FtDetail.DeptGUID,FtDetail.ProceedingGUID,FtDetail.CostGUID,FtDetail.BudgetAmount FROM cb_Contract mainRef
   											INNER JOIN ys_DeptCost2ContractUseDtl FtDetail ON mainRef.ContractGUID=FtDetail.BusinessGUID AND FtDetail.ContractGUID = mainRef.ContractGUID
   											WHERE mainRef.ApplyGUID=@ApplyGUID AND mainRef.ApproveState<>''未审核''
   											UNION ALL
   											SELECT mainRef.ApplyGUID,FtDetail.DeptGUID,FtDetail.ProceedingGUID,FtDetail.CostGUID,FtDetail.FtAmount AS BudgetAmount FROM cb_Expense mainRef
   											INNER JOIN ys_DeptCostUseDtl FtDetail ON mainRef.ExpenseGUID=FtDetail.BusinessGUID 
   											WHERE mainRef.ApplyGUID=@ApplyGUID AND mainRef.ApplyState<>''未审核''
                                               UNION ALL
   											SELECT  mainRef.RelateApplyGUID , FtDetail.DeptGUID , FtDetail.ProceedingGUID , FtDetail.CostGUID , FtDetail.FtAmount AS BudgetAmount
   											FROM dbo.cb_Loan_FtDetail FtDetail
   											INNER JOIN dbo.cb_Loan mainRef ON mainRef.LoanGUID = FtDetail.LoanGUID
   											WHERE mainRef.RelateApplyGUID = @ApplyGUID AND mainRef.ApplyState<>''未审核''
   										)costAll
   		            )
                       WHERE ApplyGUID = @ApplyGUID
                       ',N'@ApplyGUID uniqueidentifier',@ApplyGUID='86B972A2-19D8-11EB-9825-54E1AD201170'
   ```

10. 预算费用预警情况

    ```
    exec usp_cb_CostControl_Warn @chvControlClass=N'预警',@chvRefType=N'合同',@chvRefGUID=N'3a5133f3-5a38-eb11-a55a-00155d0a2516',@chvBUGUID=N'38da7886-bc9e-4431-b065-1c02ec79f80f',@chvContractGUID=N'',@SendUserName=N'订单系统'
    ```

11. 更新事项年度预算表-部门年度预算表

    ```
    			-- 事项年度预算表
                UPDATE ys_YearPlanProceeding2Cost 
                SET FactAmount10 = ISNULL(FactAmount10,0) + 45.0000 
                WHERE DeptGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                -- 部门年度预算表
                UPDATE ys_YearPlanDept2Cost 
                SET FactAmount10 = ISNULL(FactAmount10,0) + 45.0000 
                WHERE DeptGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
    
                UPDATE ys_YearPlanProceeding2Cost 
                SET FactAmount11 = ISNULL(FactAmount11,0) + 45.0000 
                WHERE DeptGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
                UPDATE ys_YearPlanDept2Cost 
                SET FactAmount11 = ISNULL(FactAmount11,0) + 45.0000 
                WHERE DeptGUID='f2876a7e-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
                UPDATE ys_YearPlanProceeding2Cost 
                SET FactAmount10 = ISNULL(FactAmount10,0) + 5.0000 
                WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b71b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
                UPDATE ys_YearPlanDept2Cost 
                SET FactAmount10 = ISNULL(FactAmount10,0) + 5.0000 
                WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b71b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
                UPDATE ys_YearPlanProceeding2Cost 
                SET FactAmount11 = ISNULL(FactAmount11,0) + 5.0000 
                WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND ProceedingGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b71b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
                UPDATE ys_YearPlanDept2Cost 
                SET FactAmount11 = ISNULL(FactAmount11,0) + 5.0000 
                WHERE DeptGUID='fb489ba6-7ade-11ea-8b09-00155d0a1c30' AND Year=2020 
                      AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID= 'b71b57f7-7744-e911-aadb-00155d0a1c3e' AND Year=2020) ;
                
    ```

#### 1.7.2.4 审批通过

1. 合约规划使用表

   ```
   SELECT CostGUID, BudgetGUID
   FROM cb_Budget
   WHERE BudgetGUID IN
         (SELECT DISTINCT BudgetGUID FROM cb_BudgetUse WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516')
   ORDER BY CostGUID
   ```

2. 更新审批状态

   ```
   UPDATE cb_Contract SET ApproveState='已审核',HtClass=Replace(HtClass,'预计','已定') WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

3. 审批通过

   ```
   exec usp_cb_FtSpPass @RefGUID='8D1BA1BF-BB39-EB11-A55A-00155D0A2516'
   ```

4. 查询供应商税率

   ```
   select Provider2TaxGUID,ProviderGUID,ValueAddedTaxGUID,TaxableCategory,TaxRate,BeginDate,EndDate,Remark,refGUID from p_Provider2TaxTem where refGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

5. 查询供应商

   ```
   select * From p_Provider where ProviderGUID in (SELECT YfProviderGUID as ProviderGUID From cb_Contract where ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516' UNION ALL SELECT BfProviderGUID as ProviderGUID From cb_Contract where ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516')
   ```

#### 1.7.2.5 解锁

1. 查询合同信息

   ```
   SELECT HtClass,
          JsState,
          IsLock,
          ApproveState,
          TotalAmount,
          BjcbAmount,
          ItemAmount,
          HtAmount,
          HtAmount_Bz,
          SignDate,
          HtycAmount,
          JbDeptName,
          Jbr,
          ApproveLog,
          ApprovedBy,
          ApproveDate
   FROM vcb_Contract
   WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

2. 更新合同信息

   ```
   UPDATE cb_Contract
   SET IsLock=0,
       ApprovedBy='',
       ApproveDate=NULL,
       ApproveLog='……2020年12月09日… 新增合同，经办人信息如下：……
   经办部门  ：测试部门                      经 办 人    ：订单系统
   
   
   ……2020年12月09日…订单系统解锁合同，解锁前合同信息如下：……
   
   合同金额  ：5,000.00                      不计成本金额：0.00
   甲供材金额：0.00                          有效签约金额：5,000.00
   签约日期  ：2020-12-09                    
   经办部门  ：测试部门                      经 办 人    ：订单系统
   锁定日期  ：2020-12-09                    锁 定 人    ：订单系统'
   WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

#### 1.7.2.6 审批驳回

1. 合约规划锁定状态表

   ```
   SELECT b.ProjName, a.CheckOutUserName
   FROM cb_ProjectLockBudget     a
            INNER JOIN p_Project b ON a.ProjectGUID = b.ProjGUID
   WHERE a.IfLock = 1
     AND ProjectGUID IN (SELECT ProjGUID FROM cb_ContractProj WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516')
   ```

   

2. 合同信息

   ```
   SELECT MasterContractGUID,IfDdhs,ApproveState,IsLock,JsState FROM cb_Contract WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

3. 跨年结转业务表

   ```
   exec sp_executesql N'SELECT COUNT(0) AS CNT FROM dbo.fy_YearCarryOver WHERE BizGUID=@BizGUID AND BalanceState=''已结转执行''',N'@BizGUID uniqueidentifier',@BizGUID='8D1BA1BF-BB39-EB11-A55A-00155D0A2516'
   ```

   

4. 合同信息

   ```
   SELECT 8 FROM cb_Contract WHERE HtProperty='补充合同' AND MasterContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

5. 合同结算表

   ```
   SELECT 8 FROM cb_HTBalance WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

6. 合同变更表

   ```
   SELECT 8 FROM cb_HtAlter WHERE isnull(InvaildStatus,0)=0 and ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

7. 合同付款申请表

   ```
   SELECT 8 FROM cb_HTFKApply WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

8. 收票单据表

   ```
   SELECT 8 FROM cb_Invoice WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

9. 实付款表

   ```
   SELECT 8 FROM cb_Pay WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

10. 应付款表

    ```
    SELECT 8 FROM cb_Fee WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ```

    

11. 应付进度款表

    ```
    SELECT 8 FROM cb_HTSchedule WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ```

    

12. 合同借阅管理表

    ```
    SELECT 8 FROM cb_HTBorrow WHERE ContractGUID='8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ```

    

13. 库存科目使用表

    ```
    select a.StockCostUseGUID as oid,
           a.StockCostGUID,
           a.CfAmount,
           a.HappenTime,
           b.CostShortName    as CostName,
           b.EntryAmount,
           b.BUGUID,
           b.CostCode
    from cb_StockCostUse             a
             inner join Cb_StockCost b on a.StockCostGUID = b.StockCostGUID
    where a.RefGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ORDER BY b.CostCode
    ```

    

14. 合同费用预算规划明细表

    ```
    SELECT a.DeptCost2ContractGUID,
           a.BusinessType,
           a.BusinessGUID,
           a.CostGUID,
           ISNULL(b.CostShortName,'')                       AS CostShortName,
           a.ZrrGUID,
           a.ZrrName,
           a.DeptGUID,
           a.DeptName,
           a.BudgetAmount,
           a.UseableAmount,
           b.CostCode,
           dbo.fn_ys_GetCostFullName(b.DeptCostGUID,b.Year) AS CostFullName,
           a.ProceedingName,
           a.ProceedingGUID,
           q.Year
    FROM ys_DeptCost2ContractUseDtl               a
             LEFT JOIN ys_deptcost                b ON a.CostGUID = b.DeptCostGUID
             LEFT JOIN dbo.ys_SpecialBusinessUnit q ON q.SpecialUnitGUID = a.DeptGUID
    WHERE a.ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
      AND a.BusinessGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ```

    

15. 审批驳回

    ```
    DECLARE @nowTime as DATETIME
    DECLARE @failureTime as DATETIME
    DECLARE @resGUID as UNIQUEIDENTIFIER
    DECLARE @userName as VARCHAR(20)
    DECLARE @lockInfo as VARCHAR(500)
    SET @nowTime = getdate()
    SET @failureTime = DATEADD(second,60,@nowTime)
    SET @resGUID = 'aac02e1e-c139-eb11-a55a-00155d0a2516'
    SET @userName = '订单系统'
    SET @lockInfo = '合同审批驳回'
    DELETE
    FROM cb_ResLock
    WHERE FailureTime < @nowTime
      AND Res <> '固定数据'
    IF NOT EXISTS(SELECT ResGUID
                  FROM cb_ResLock
                  WHERE ResGUID = 'aac02e1e-c139-eb11-a55a-00155d0a2516'
                    AND Res = 'cb_contract$8d1ba1bf-bb39-eb11-a55a-00155d0a2516')
        BEGIN
            INSERT INTO cb_ResLock(ResGUID, FailureTime, UserName, Res, LockInfo)
            VALUES (@resGUID, @failureTime, @userName, 'cb_contract$8d1ba1bf-bb39-eb11-a55a-00155d0a2516', @lockInfo)
        END
    ```

    

16. 更新合同费用预算规划明细信息

    ```
    UPDATE ys_DeptCost2ContractUseDtl
    SET UseableAmount = 0
    WHERE BusinessType = '合同'
      AND BusinessGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516';
    UPDATE cb_Contract
    SET MasterContractGUID=NULL
    WHERE MasterContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516';
    UPDATE cb_Contract
    SET ApproveState='未审核',
        HtClass=Replace(HtClass,'已定','预计'),
        IsLock=0,
        ApprovedBy='',
        ApproveDate=NULL
    WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516';
    DELETE
    FROM dbo.cb_YgAlterAdjustDtl
    WHERE YgAlterAdjustGUID IN
          (SELECT YgAlterAdjustGUID FROM dbo.cb_YgAlterAdjust WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516');
    DELETE
    FROM cb_YgAlterAdjust
    WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516';
    DELETE
    FROM dbo.cb_YgAlter2Budget
    WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516';
    DELETE cb_ContractYgAlter
    WHERE ContractGUID = '8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
    ```

    

17. 获取合同持续分摊信息

    ```
    exec sp_executesql
         N'SELECT  DeptGUID,ProceedingGUID ,CostGUID ,FtYear ,FtMonth ,FtAmount  FROM fy_Contract_FtDetail_Period WHERE ContractGUID=@BussinessGUID',
         N'@BussinessGUID uniqueidentifier',@BussinessGUID='8D1BA1BF-BB39-EB11-A55A-00155D0A2516'
    ```

    

18. 更新事项年度预算表 和 部门年度预算表

    ```
    UPDATE ys_YearPlanProceeding2Cost
    SET FactAmount12 = ISNULL(FactAmount12,0) - 5000.0000
    WHERE DeptGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30'
      AND ProceedingGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
    
    UPDATE ys_YearPlanDept2Cost
    SET FactAmount12 = ISNULL(FactAmount12,0) - 5000.0000
    WHERE DeptGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'be1b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
                
    ```

    



### 1.7.3 付款计划

#### 1.7.3.1 列表查询

1. 月度资金计划表

   ```
   exec sp_executesql
        N'SELECT  SUM(ISNULL(b.ApproveAmount,0)) AS ApproveAmount	FROM cb_MonthPlan a INNER JOIN cb_MonthPlandtl b ON a.MonthPlanGUID=b.MonthPlanGUID  WHERE a.PlanMonth = CONVERT(varchar(7),getdate(),120) AND a.ApproveState=''已审核'' AND FkPlanType=''新上报'' AND b.ContractGUID = @strContractGUID',
        N'@strContractGUID nvarchar(36)',@strContractGUID=N'8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

2. 合同付款申请表

   ```
   exec sp_executesql
        N'SELECT  SUM(ISNULL(ApplyAmount,0)) AS ApplyAmount FROM cb_HTFKApply WHERE (ApplyState = ''已审核'' OR ApplyState = ''审核中'') AND ContractGUID=@strContractGUID AND ApplyType = ''计划内'' AND ApplyDate >= dateadd(MONTH,datediff(MONTH,0,getdate()),0 ) AND ApplyDate < dateadd(MONTH,datediff(MONTH,0,getdate()) + 1,0 )',
        N'@strContractGUID nvarchar(36)',@strContractGUID=N'8d1ba1bf-bb39-eb11-a55a-00155d0a2516'
   ```

   

3. 合同信息

   ```
   SELECT TOP 20 vcb_ContractGrid.ContractGUID
               , vcb_ContractGrid.JsState
               , vcb_ContractGrid.ContractCode
               , vcb_ContractGrid.ContractName
               , vcb_ContractGrid.SignDate
               , vcb_ContractGrid.HtKind
               , vcb_ContractGrid.HtClass
               , CASE WHEN vcb_ContractGrid.IfConfirmFkPlan = 1 THEN '√' ELSE '' END AS IfConfirmFkPlan
               , vcb_ContractGrid.HtAmount
               , vcb_ContractGrid.SumALterAmount
               , vcb_ContractGrid.SumYfAmount
               , vcb_ContractGrid.SumPayAmount
               , vcb_ContractGrid.ZjsAmount
               , vcb_ContractGrid.JsAmount
               , vcb_ContractGrid.CurrencyName
               , vcb_ContractGrid.HtAmount_Bz
               , vcb_ContractGrid.SumALterAmount_Bz
               , vcb_ContractGrid.ZjsAmount_Bz
               , vcb_ContractGrid.JsAmount_Bz
               , vcb_ContractGrid.SumYfAmount_Bz
               , IsNUll(a.PayAmount,0)                                               AS SumPayAmount_Bz
               , vcb_ContractGrid.YgAlterAmount
               , (CASE WHEN b.BusinessGUID IS NULL THEN 0 ELSE 1 END)                AS ProjectPlanAffect
               , vcb_ContractGrid.YgAlterAmount_Bz
   FROM vcb_ContractGrid
            LEFT JOIN (select distinct BusinessGUID
                       from vjd_Work2Business
                       where Type = '合同' and BeginDateJh != ConfirmedBeginDate) b
                      ON vcb_ContractGrid.ContractGUID = b.BusinessGUID
            LEFT JOIN (select sum(a.PayAmount1) PayAmount, a.ContractGUID, a.ApproveState
                       from dbo.cb_Voucher a
                       where a.ApproveState = '已审核'
                       group by a.ContractGUID, a.ApproveState)                 a
                      ON vcb_ContractGrid.ContractGUID = a.ContractGUID
   WHERE ((((1 = 1 AND (JbDeptCode = 'zb.1.22' or JbDeptCode like 'zb.1.22.%')) AND (1 = N'1')) AND 1 = 1))
     AND ((9 = 9) AND 1 = 1)
     AND BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
     AND IfDdhs = 1
   ORDER BY vcb_ContractGrid.ContractCode DESC, vcb_ContractGrid.ContractGUID
   ```

   

4. 付款计划

   ```
   SELECT IsNUll(c.HTFKApplyGUID,'00000000-0000-0000-0000-000000000000')                               As HTFKApplyGUID
        , cb_HTFKPlan.Bz
        , cb_HTFKPlan.RecordType
        , cb_HTFKPlan.ContractGUID
        , cb_HTFKPlan.HTFKPlanGUID
        , cb_HTFKPlan.JhfkAmount
        , cb_HTFKPlan.Rate
        , cb_HTFKPlan.ApproveState
        , cb_HTFKPlan.FundType
        , cb_HTFKPlan.FundName
        , cb_HTFKPlan.JhfkAmount_Bz
        , cb_HTFKPlan.JhfkDate
        , cb_HTFKPlan.JhfkRemarks
        , b.CurrencyName
        , IsNUll(e.PayAmount,0)                                                                        AS PaidAmount
        , cb_HTFKPlan.BUGUID
        , cb_HTFKPlan.DeptCode
        , cb_HTFKPlan.NoPayPlanAmount
        , case when d.projtype = '无项目' then '' when cb_HTFKPlan.FtMode = 2 then '手动拆分' else '自动拆分' end as FtModeText
        , FtMode
   FROM cb_HTFKPlan
            LEFT JOIN cb_Currency              b On cb_HTFKPlan.Bz = b.CurrencyGUID
            LEFT JOIN cb_HTFKApply             c ON cb_HTFKPlan.HTFKPlanGUID = c.HTFKPlanGUID
            LEFT JOIN cb_Contract              d ON cb_HTFKPlan.ContractGUID = d.ContractGUID
            LEFT JOIN (select sum(PayAmount1) PayAmount, HTFKApplyGUID
                       from dbo.cb_Pay
                       where ApproveState = '已审核'
                       group by HTFKApplyGUID) e on e.HTFKApplyGUID = c.HTFKApplyGUID
   WHERE (1 = 1)
     AND (cb_HTFKPlan.ContractGUID = '777beb0d-7838-eb11-a55a-00155d0a2516')
   ORDER BY cb_HTFKPlan.JhfkDate
   ```

   

### 1.7.4 付款申请

#### 1.7.4.1 列表查询

```
SELECT TOP 20 HTFKApplyGUID
            , cb_HTFKApply.ContractGUID
            , HTFKPlanGUID
            , CASE WHEN PayState = '未支付' THEN ApplyState ELSE PayState END AS OperationState
            , CASE WHEN ApplyClass = 0 THEN '合同' ELSE '非合同' END            AS PayClass
            , ApplyTypeGUID
            , ApplyState
            , Subject
            , ApplyCode
            , mu.BUName                                                    As ApplyDeptName
            , AppliedByName
            , c.ContractName
            , ApplyDate
            , ApplyAmount_Bz
            , ApplyAmount
            , mu.HierarchyCode                                             AS JbDeptCode
            , ProjType
FROM cb_HTFKApply
         INNER JOIN cb_Contract    c ON cb_HTFKApply.ContractGUID = c.ContractGUID AND c.BUGUID = cb_HTFKApply.BUGUID
         LEFT JOIN  myBusinessUnit mu ON mu.BUGUID = cb_HTFKApply.ApplyBUGUID
WHERE ((((((1 = 1 AND (1 = 1)) AND (mu.HierarchyCode = 'zb.1.22' or mu.HierarchyCode like 'zb.1.22.%')) AND
          (1 = N'1')) AND 1 = 1)))
  AND ((9 = 9))
  AND cb_HTFKApply.BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
  AND c.IsFyControl = 1
ORDER BY cb_HTFKApply.ApplyDate DESC, cb_HTFKApply.HTFKApplyGUID
```

#### 1.7.4.2 新增保存

1. 获取合同付款申请

   ```
   SELECT HTFKApplyGUID
   FROM cb_HTFKApply
   WHERE HTFKPlanGUID = '602c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

2. 获取事项年度预算年份

   ```
   SELECT top 1 Year
   FROM ys_YearPlanProceeding2Cost
   WHERE CostGUID = 'be1b57f7-7744-e911-aadb-00155d0a1c3e'
     and proceedingGUID = 'fb489ba6-7ade-11ea-8b09-00155d0a1c30'
   ```

3. 获取合同付款申请

   ```
   SELECT count(1) as sl
   FROM cb_HTFKApply
   WHERE ApplyCode = '1-2020-12-09-0002'
     AND HTFKApplyGUID <> '00000000-0000-0000-0000-000000000000'
     AND BUGUID = '38da7886-bc9e-4431-b065-1c02ec79f80f'
   ```

4. 更新合同付款计划

   ```
   UPDATE cb_HTFKPlan SET RecordType=0,Approvestate='申请中' WHERE HTFKPlanGUID='602c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

   

5. 新增合同付款申请

   ```
   INSERT INTO cb_HTFKApply (HTFKApplyGUID, ContractGUID, HTFKPlanGUID, AppliedBy, ApplyBUGUID, BUGUID, PayProviderName,
                             ReceiveProviderName, DfdkAmount, YfAmount, BalanceAmount, RemainAmount, CurrencyGUID,
                             ApplyState, PayState, ApplyClass, BudgetColor, BudgetInfo, StockInfo, ApplyCodeFormat,
                             ApplyRateInfo, ApplyRateColor, ApplyTypeGUID, ApplyTypeName, ZjPlanControl, Subject,
                             ApplyCode, PayProviderGUID, ApplyType, ReceiveProviderGUID, BankName, BankAccounts,
                             ApplyAmount_Bz, FundType, FundName, DfdkAmount_Bz, BalanceAmount_Bz, YfAmount_Bz, Rate,
                             ApplyAmount, AppliedByName, ApplyDate, YwgsDate, ApplyRemarks)
   VALUES (N'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           '602c0e71-3c39-eb11-a55a-00155d0a2516', '4230bc6e-69e6-46a9-a39e-b929a06a84e8',
           'e777fc1b-f828-42b0-8888-25f6cee41c2b', '38da7886-bc9e-4431-b065-1c02ec79f80f', '987654', 'new001', 0, 1500,
           0.00, 1500, 'f1ae9c30-fe32-4844-a772-23a9bb044d08', '未审核', '未支付', 0, '', '', N'', '$公司代码$1-$日$09-$流水号$0002',
           N'合同付款申请比例(含本次申请)：100 %  (警戒线：80.0000 %)', 'red', NULL, '', '合同', 'liuwz合同1208001第1笔付款', '1-2020-12-09-0002',
           'b029d30b-b0f3-e811-aad4-00155d0a1c3e', '计划内', '4445323d-b535-e911-aad9-00155d0a1c3e', '开户银行01', '1234567890',
           1500.00, '土地合同款', '预付款', 0.00, 0.00, 1500.00, 1.0000, 1500.00, '订单系统', '2020-12-09', '2020-12-09', '')
   ```

   

6. usp_ys_UpdateAdjustState

   ```
   EXEC usp_ys_UpdateAdjustState 'SINGLE','HT','5d2c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

   

7. 更新合同付款申请

   ```
   Update cb_HTFKApply
   set HtDtAmount=1500.00,
       SumApplyAmount=0.00,
       ScheduleConsultAmount=1500.00,
       MonthContractPlanAmount=0.00,
       MonthContractSpAmount=0.00,
       MonthContractApplyAmount=0.00,
       MonthContractRemainAmount=0.00,
       MonthPersonPlanAmount=0.00,
       MonthPersonSpAmount=0.00,
       MonthPersonApplyAmount=0.00,
       MonthPersonRemainAmount=0.00,
       MonthDeptPlanAmount=0.00,
       MonthDeptSpAmount=0.00,
       MonthDeptApplyAmount=0.00,
       MonthDeptRemainAmount=0.00
   where HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

8. 更新费用预算使用明细表

   ```
   DELETE
   FROM cb_DeptCostUseDtl
   WHERE BusinessGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516';
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', 'be1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'fb489ba6-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-六期',
           1000.00, 0, 2020, 12, 0, 'a3f11f76-98f8-e811-aad4-00155d0a1c3e', 'C.02', '差旅费');
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'f2876a7e-7ade-11ea-8b09-00155d0a1c30', 'bf1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'f2876a7e-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-二期', 500.00,
           0, 2020, 12, 0, '1d097cab-98f8-e811-aad4-00155d0a1c3e', 'C.05', '水电物管费')
   ```

   

9. 删除冲账明细

   ```
   DELETE
   FROM cb_LoanBalanceApply
   WHERE RefGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

10. 删除 cb_HTFKApply2Tax

    ```
    DELETE cb_HTFKApply2Tax
    WHERE HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
      AND 1 = 1
    ```

    

11. 回填付款申请合同金额信息

    ```
    UPDATE c
    SET c.InputTaxAmount=ISNULL(tmp.sumInputTaxAmount,0),
        c.InputTaxAmount_Bz = ISNULL(tmp.sumInputTaxAmount_Bz,0),
        c.ExcludingTaxHtAmount = ISNULL(tmp.sumExcludingTaxAmount,0),
        c.ExcludingTaxHtAmount_Bz = ISNULL(tmp.sumExcludingTaxAmount_Bz,0),
        c.AverageTaxRate = ISNULL((CASE WHEN tmp.sumExcludingTaxAmount_Bz = 0 THEN 0
                                        ELSE ROUND(tmp.sumInputTaxAmount_Bz * 100.00 / tmp.sumExcludingTaxAmount_Bz,2) END),
                                  0)
    FROM cb_Contract                                  c
             LEFT JOIN (select a2t.ContractGUID,
                               SUM(a2t.ExcludingApplyAmount)    as sumExcludingTaxAmount,
                               SUM(a2t.ExcludingApplyAmount_Bz) as sumExcludingTaxAmount_Bz,
                               SUM(a2t.InputApplyAmount)        as sumInputTaxAmount,
                               SUM(a2t.InputApplyAmount_Bz)     as sumInputTaxAmount_Bz
                        from cb_HTFKApply2Tax      a2t
                                 JOIN cb_HTFKApply a ON a2t.HTFKApplyGUID = a.HTFKApplyGUID
                        where ISNULL(a.ApplyState,'未审核') <> '未审核'
                          and a2t.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
                        group by a2t.ContractGUID) as tmp ON c.ContractGUID = tmp.ContractGUID
    WHERE c.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
      AND c.ProjType = '公司库存'
    ```

#### 1.7.4.3 修改保存

1. 更新合同付款计划

   ```
   UPDATE cb_HTFKPlan SET RecordType=0,Approvestate='申请中' WHERE HTFKPlanGUID='602c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

2. 更新合同付款申请

   ```
   UPDATE cb_HTFKApply
   SET ContractGUID='5d2c0e71-3c39-eb11-a55a-00155d0a2516',
       HTFKPlanGUID='602c0e71-3c39-eb11-a55a-00155d0a2516',
       AppliedBy='4230bc6e-69e6-46a9-a39e-b929a06a84e8',
       ApplyBUGUID='e777fc1b-f828-42b0-8888-25f6cee41c2b',
       BUGUID='38da7886-bc9e-4431-b065-1c02ec79f80f',
       PayProviderName='987654',
       ReceiveProviderName='new001',
       DfdkAmount=0,
       YfAmount=1500,
       BalanceAmount=0.0000,
       RemainAmount=1500,
       CurrencyGUID='f1ae9c30-fe32-4844-a772-23a9bb044d08',
       ApplyState='未审核',
       PayState='未支付',
       ApplyClass=0,
       BudgetColor='',
       BudgetInfo='',
       StockInfo=N'',
       ApplyCodeFormat='$公司代码$1-$日$09-$流水号$0002',
       ApplyRateInfo=N'合同付款申请比例(含本次申请)：100 %  (警戒线：80.0000 %)',
       ApplyRateColor='red',
       ApplyTypeGUID=NULL,
       ApplyTypeName='',
       ZjPlanControl='合同',
       Subject='liuwz合同1208001第1笔付款',
       ApplyCode='1-2020-12-09-0002',
       PayProviderGUID='b029d30b-b0f3-e811-aad4-00155d0a1c3e',
       ApplyType='计划内',
       ReceiveProviderGUID='4445323d-b535-e911-aad9-00155d0a1c3e',
       BankName='开户银行01',
       BankAccounts='1234567890',
       ApplyAmount_Bz=1500.00,
       FundType='土地合同款',
       FundName='预付款',
       DfdkAmount_Bz=0.00,
       BalanceAmount_Bz=0.00,
       YfAmount_Bz=1500.00,
       Rate=1.0000,
       ApplyAmount=1500.00,
       AppliedByName='订单系统',
       ApplyDate='2020-12-09',
       YwgsDate='2020-12-09',
       ApplyRemarks=''
   WHERE HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

3. usp_ys_UpdateAdjustState 

   ```
   EXEC usp_ys_UpdateAdjustState 'SINGLE','HT','5d2c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

   

4. 更新合同付款申请金额

   ```
   Update cb_HTFKApply set HtDtAmount=1500.00,SumApplyAmount=0.00,ScheduleConsultAmount=1500.00,MonthContractPlanAmount=0.00,MonthContractSpAmount=0.00,MonthContractApplyAmount=0.00,MonthContractRemainAmount=0.00,MonthPersonPlanAmount=0.00,MonthPersonSpAmount=0.00,MonthPersonApplyAmount=0.00,MonthPersonRemainAmount=0.00,MonthDeptPlanAmount=0.00,MonthDeptSpAmount=0.00,MonthDeptApplyAmount=0.00,MonthDeptRemainAmount=0.00 where HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

5. 更新费用预算使用明细表

   ```
   DELETE
   FROM cb_DeptCostUseDtl
   WHERE BusinessGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516';
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', 'be1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'fb489ba6-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-六期',
           1000.00, 0, 2020, 12, 0, 'a3f11f76-98f8-e811-aad4-00155d0a1c3e', 'C.02', '差旅费');
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'f2876a7e-7ade-11ea-8b09-00155d0a1c30', 'bf1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'f2876a7e-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-二期', 500.00,
           0, 2020, 12, 0, '1d097cab-98f8-e811-aad4-00155d0a1c3e', 'C.05', '水电物管费')
   ```

   

6. 删除冲账明细

   ```
   DELETE
   FROM cb_LoanBalanceApply
   WHERE RefGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

7. 删除 cb_HTFKApply2Tax

   ```
   DELETE cb_HTFKApply2Tax  WHERE HTFKApplyGUID='ba6a5d90-c539-eb11-a55a-00155d0a2516' AND 1=1
   ```

   

8. 回填付款申请合同金额信息

   ```
   UPDATE c
   SET c.InputTaxAmount=ISNULL(tmp.sumInputTaxAmount,0),
       c.InputTaxAmount_Bz = ISNULL(tmp.sumInputTaxAmount_Bz,0),
       c.ExcludingTaxHtAmount = ISNULL(tmp.sumExcludingTaxAmount,0),
       c.ExcludingTaxHtAmount_Bz = ISNULL(tmp.sumExcludingTaxAmount_Bz,0),
       c.AverageTaxRate = ISNULL((CASE WHEN tmp.sumExcludingTaxAmount_Bz = 0 THEN 0
                                       ELSE ROUND(tmp.sumInputTaxAmount_Bz * 100.00 / tmp.sumExcludingTaxAmount_Bz,2) END),
                                 0)
   FROM cb_Contract                                  c
            LEFT JOIN (select a2t.ContractGUID,
                              SUM(a2t.ExcludingApplyAmount)    as sumExcludingTaxAmount,
                              SUM(a2t.ExcludingApplyAmount_Bz) as sumExcludingTaxAmount_Bz,
                              SUM(a2t.InputApplyAmount)        as sumInputTaxAmount,
                              SUM(a2t.InputApplyAmount_Bz)     as sumInputTaxAmount_Bz
                       from cb_HTFKApply2Tax      a2t
                                JOIN cb_HTFKApply a ON a2t.HTFKApplyGUID = a.HTFKApplyGUID
                       where ISNULL(a.ApplyState,'未审核') <> '未审核'
                         and a2t.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
                       group by a2t.ContractGUID) as tmp ON c.ContractGUID = tmp.ContractGUID
   WHERE c.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
     AND c.ProjType = '公司库存'
   ```

   

#### 1.7.4.4 提交审批

1. 验证是否有未对冲借款

   ```
   exec sp_executesql
        N' SELECT COUNT(1) FROM vcb_LoanBalanceApply_HTFKApply WHERE RefGUID = @RefGUID AND LoanBalanceApplyGUID NOT IN ( SELECT  LoanBalanceApplyGUID FROM vcb_LoanBalanceApply_HTFKApply  a LEFT JOIN dbo.cb_Loan l ON a.LoanGUID = l.LoanGUID WHERE RefGUID = @RefGUID  AND ( ( l.LoanType = ''普通'' AND a.ApplyDate< @ControlDate ) OR ( l.LoanType = ''备用金'' AND YEAR(a.ApplyDate) <> YEAR(@ApplyDate) ) ) )',
        N'@ApplyDate nvarchar(9),@RefGUID nvarchar(36),@ControlDate nvarchar(10)',@ApplyDate=N'2020/12/9',
        @RefGUID=N'ba6a5d90-c539-eb11-a55a-00155d0a2516',@ControlDate=N'2020-12-01'
   
   exec sp_executesql
        N' SELECT isnull(SUM(CurBalanceAmount_Bz),0) FROM vcb_LoanBalanceApply_HTFKApply a LEFT JOIN dbo.cb_Loan l ON a.LoanGUID=l.LoanGUID  WHERE l.LoanType=''备用金'' AND YEAR(a.ApplyDate)<YEAR(@ApplyDate)  AND RefGUID =@RefGUID',
        N'@ApplyDate nvarchar(9),@RefGUID nvarchar(36)',@ApplyDate=N'2020/12/9',@RefGUID=N'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   
   exec sp_executesql
        N' SELECT isnull(SUM(CurBalanceAmount_Bz),0) FROM  vcb_LoanBalanceApply_HTFKApply a LEFT JOIN dbo.cb_Loan l ON a.LoanGUID=l.LoanGUID  WHERE l.LoanType=''普通'' AND a.ApplyDate<@ApplyDate  AND RefGUID =@RefGUID',
        N'@ApplyDate nvarchar(10),@RefGUID nvarchar(36)',@ApplyDate=N'2020-12-01',@RefGUID=N'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   
   exec sp_executesql
        N' SELECT isnull(SUM(RemainAmount),0)  FROM cb_Loan WHERE LoanType=@LoanType  And (ApplyState=''已审核'' OR ApplyState=''冲账未完成'') AND PayState=''已支付''  AND RemainAmount>0 AND YEAR(ApplyDate)<>YEAR(''2020/12/9'') AND AppliedBy=@AppliedBy AND  LoanType=@LoanType',
        N'@LoanType nvarchar(3),@AppliedBy nvarchar(36)',@LoanType=N'备用金',@AppliedBy=N'4230bc6e-69e6-46a9-a39e-b929a06a84e8'
   
   exec sp_executesql
        N' SELECT isnull(SUM(RemainAmount),0)  FROM cb_Loan WHERE LoanType=@LoanType  And (ApplyState=''已审核'' OR ApplyState=''冲账未完成'') AND PayState=''已支付''  AND RemainAmount>0 AND ApplyDate<''2020-12-01'' AND AppliedBy=@AppliedBy AND  LoanType=@LoanType',
        N'@LoanType nvarchar(2),@AppliedBy nvarchar(36)',@LoanType=N'普通',@AppliedBy=N'4230bc6e-69e6-46a9-a39e-b929a06a84e8'
   ```

   

2. 更新审批状态

   ```
   UPDATE cb_HTFKPlan SET RecordType=0,Approvestate='申请中' WHERE HTFKPlanGUID='602c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

   

3. 更新合同付款申请

   ```
   UPDATE cb_HTFKApply
   SET ContractGUID='5d2c0e71-3c39-eb11-a55a-00155d0a2516',
       HTFKPlanGUID='602c0e71-3c39-eb11-a55a-00155d0a2516',
       AppliedBy='4230bc6e-69e6-46a9-a39e-b929a06a84e8',
       ApplyBUGUID='e777fc1b-f828-42b0-8888-25f6cee41c2b',
       BUGUID='38da7886-bc9e-4431-b065-1c02ec79f80f',
       PayProviderName='987654',
       ReceiveProviderName='new001',
       DfdkAmount=0,
       YfAmount=1500,
       BalanceAmount=0.0000,
       RemainAmount=1500,
       CurrencyGUID='f1ae9c30-fe32-4844-a772-23a9bb044d08',
       ApplyState='未审核',
       PayState='未支付',
       ApplyClass=0,
       BudgetColor='',
       BudgetInfo='',
       StockInfo=N'',
       ApplyCodeFormat='$公司代码$1-$日$09-$流水号$0002',
       ApplyRateInfo=N'合同付款申请比例(含本次申请)：100 %  (警戒线：80.0000 %)',
       ApplyRateColor='red',
       ApplyTypeGUID=NULL,
       ApplyTypeName='',
       ZjPlanControl='合同',
       Subject='liuwz合同1208001第1笔付款',
       ApplyCode='1-2020-12-09-0002',
       PayProviderGUID='b029d30b-b0f3-e811-aad4-00155d0a1c3e',
       ApplyType='计划内',
       ReceiveProviderGUID='4445323d-b535-e911-aad9-00155d0a1c3e',
       BankName='开户银行01',
       BankAccounts='1234567890',
       ApplyAmount_Bz=1500.00,
       FundType='土地合同款',
       FundName='预付款',
       DfdkAmount_Bz=0.00,
       BalanceAmount_Bz=0.00,
       YfAmount_Bz=1500.00,
       Rate=1.0000,
       ApplyAmount=1500.00,
       AppliedByName='订单系统',
       ApplyDate='2020-12-09',
       YwgsDate='2020-12-09',
       ApplyRemarks=''
   WHERE HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

4. usp_ys_UpdateAdjustState

   ```
   EXEC usp_ys_UpdateAdjustState 'SINGLE','HT','5d2c0e71-3c39-eb11-a55a-00155d0a2516'
   ```

   

5. 更新合同付款申请金额

   ```
   Update cb_HTFKApply
   set HtDtAmount=1500.00,
       SumApplyAmount=0.00,
       ScheduleConsultAmount=1500.00,
       MonthContractPlanAmount=0.00,
       MonthContractSpAmount=0.00,
       MonthContractApplyAmount=0.00,
       MonthContractRemainAmount=0.00,
       MonthPersonPlanAmount=0.00,
       MonthPersonSpAmount=0.00,
       MonthPersonApplyAmount=0.00,
       MonthPersonRemainAmount=0.00,
       MonthDeptPlanAmount=0.00,
       MonthDeptSpAmount=0.00,
       MonthDeptApplyAmount=0.00,
       MonthDeptRemainAmount=0.00
   where HTFKApplyGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

6. 删除已关联 费用预算使用明细表

   ```
   DELETE
   FROM cb_DeptCostUseDtl
   WHERE BusinessGUID = 'ba6a5d90-c539-eb11-a55a-00155d0a2516';
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', 'be1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'fb489ba6-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-六期',
           1000.00, 0, 2020, 12, 0, 'a3f11f76-98f8-e811-aad4-00155d0a1c3e', 'C.02', '差旅费');
   INSERT INTO cb_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID, CostGUID,
                                 ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month, CostFlag,
                                 EntryCostGUID, EntryCostCode, EntryCostName)
   VALUES (dbo.SeqNewId(), '付款申请', 'ba6a5d90-c539-eb11-a55a-00155d0a2516', '5d2c0e71-3c39-eb11-a55a-00155d0a2516',
           'f2876a7e-7ade-11ea-8b09-00155d0a1c30', 'bf1b57f7-7744-e911-aadb-00155d0a1c3e',
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'f2876a7e-7ade-11ea-8b09-00155d0a1c30', '2020年-测试项目-二期', 500.00,
           0, 2020, 12, 0, '1d097cab-98f8-e811-aad4-00155d0a1c3e', 'C.05', '水电物管费')
   ```

   

7. 删除冲账明细

   ```
   DELETE FROM cb_LoanBalanceApply WHERE RefGUID ='ba6a5d90-c539-eb11-a55a-00155d0a2516'
   ```

   

8. 删除 cb_HTFKApply2Tax

   ```
   DELETE cb_HTFKApply2Tax  WHERE HTFKApplyGUID='ba6a5d90-c539-eb11-a55a-00155d0a2516' AND 1=1
   ```

   

9. 回填付款申请合同金额信息

   ```
   UPDATE c
   SET c.InputTaxAmount=ISNULL(tmp.sumInputTaxAmount,0),
       c.InputTaxAmount_Bz = ISNULL(tmp.sumInputTaxAmount_Bz,0),
       c.ExcludingTaxHtAmount = ISNULL(tmp.sumExcludingTaxAmount,0),
       c.ExcludingTaxHtAmount_Bz = ISNULL(tmp.sumExcludingTaxAmount_Bz,0),
       c.AverageTaxRate = ISNULL((CASE WHEN tmp.sumExcludingTaxAmount_Bz = 0 THEN 0
                                       ELSE ROUND(tmp.sumInputTaxAmount_Bz * 100.00 / tmp.sumExcludingTaxAmount_Bz,2) END),
                                 0)
   FROM cb_Contract                                  c
            LEFT JOIN (select a2t.ContractGUID,
                              SUM(a2t.ExcludingApplyAmount)    as sumExcludingTaxAmount,
                              SUM(a2t.ExcludingApplyAmount_Bz) as sumExcludingTaxAmount_Bz,
                              SUM(a2t.InputApplyAmount)        as sumInputTaxAmount,
                              SUM(a2t.InputApplyAmount_Bz)     as sumInputTaxAmount_Bz
                       from cb_HTFKApply2Tax      a2t
                                JOIN cb_HTFKApply a ON a2t.HTFKApplyGUID = a.HTFKApplyGUID
                       where ISNULL(a.ApplyState,'未审核') <> '未审核'
                         and a2t.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
                       group by a2t.ContractGUID) as tmp ON c.ContractGUID = tmp.ContractGUID
   WHERE c.ContractGUID = '5d2c0e71-3c39-eb11-a55a-00155d0a2516'
     AND c.ProjType = '公司库存'
   ```


#### 1.7.4.5 审批通过

#### 1.7.4.6 审批驳回

### 1.7.5 执行单

#### 1.7.4.1 列表查询

#### 1.7.4.2 修改-表单初始化

#### 1.7.4.3 提交审批

#### 1.7.4.4 审批通过

#### 1.7.4.5 审批驳回

### 1.7.6 日常报销

#### 1.7.6.1 列表查询

#### 1.7.6.2 新增保存

1. 添加日常报销主数据

   ```
   
   exec sp_executesql N'insert into [cb_Expense]
   ([ExpenseGUID],[Subject],[Theme],[ExpenseCode],[AppliedBy],[AppliedByName],[ApplyBUGUID],[ProjGUID],[CurrencyGUID],[Rate],[BUGUID],[ApplyDate],[ExpenseTypeGUID],[ExpenseTypeName],[PayProviderGUID],[PayProviderName],[IsDeductibleloan],[ExpenseAmount],[ExpenseAmount_Bz],[PayAmount],[PayAmount_Bz],[IsCompanyExpense],[ApplyGuid],[ApplySubject],[ApplyState],[PayState],[TotalInvoiceCount],[TaxableInvoiceCount],[ProviderName],[ProviderGuid],[BudGetGUID],[BudGetName])
   values
   (@ExpenseGUID,@Subject,@Theme,@ExpenseCode,@AppliedBy,@AppliedByName,@ApplyBUGUID,@ProjGUID,@CurrencyGUID,@Rate,@BUGUID,@ApplyDate,@ExpenseTypeGUID,@ExpenseTypeName,@PayProviderGUID,@PayProviderName,@IsDeductibleloan,@ExpenseAmount,@ExpenseAmount_Bz,@PayAmount,@PayAmount_Bz,@IsCompanyExpense,@ApplyGuid,@ApplySubject,@ApplyState,@PayState,@TotalInvoiceCount,@TaxableInvoiceCount,@ProviderName,@ProviderGuid,@BudGetGUID,@BudGetName)',N'@ExpenseGUID
   uniqueidentifier,@Subject nvarchar(15),@Theme nvarchar(15),@ExpenseCode nvarchar(12),@AppliedBy uniqueidentifier,@AppliedByName nvarchar(4),@ApplyBUGUID uniqueidentifier,@ProjGUID uniqueidentifier,@CurrencyGUID uniqueidentifier,@Rate decimal(1,0),@BUGUID uniqueidentifier,@ApplyDate datetime,@ExpenseTypeGUID uniqueidentifier,@ExpenseTypeName nvarchar(6),@PayProviderGUID uniqueidentifier,@PayProviderName nvarchar(7),@IsDeductibleloan bit,@ExpenseAmount decimal(5,0),@ExpenseAmount_Bz decimal(5,0),@PayAmount decimal(5,0),@PayAmount_Bz decimal(5,0),@IsCompanyExpense bit,@ApplyGuid uniqueidentifier,@ApplySubject nvarchar(6),@ApplyState nvarchar(3),@PayState nvarchar(3),@TotalInvoiceCount int,@TaxableInvoiceCount int,@ProviderName nvarchar(4000),@ProviderGuid nvarchar(4000),@BudGetGUID uniqueidentifier,@BudGetName nvarchar(4)',
        @ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297',@Subject=N'liuwz报销单1209001',@Theme=N'liuwz报销单1209001',
        @ExpenseCode=N'BX2020120176',@AppliedBy='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@AppliedByName=N'订单系统',
        @ApplyBUGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@ProjGUID='11111111-1111-1111-1111-111111111111',
        @CurrencyGUID='F1AE9C30-FE32-4844-A772-23A9BB044D08',@Rate=1,@BUGUID='38DA7886-BC9E-4431-B065-1C02EC79F80F',
        @ApplyDate='2020-12-09 00:00:00',@ExpenseTypeGUID='92AA8022-2B5C-E911-AADC-00155D0A1C3E',
        @ExpenseTypeName=N'日常报销01',@PayProviderGUID='488F2FB9-2E72-E911-B398-00155D0A1C30',@PayProviderName=N'测试分类001',
        @IsDeductibleloan=0,@ExpenseAmount=10000,@ExpenseAmount_Bz=10000,@PayAmount=10000,@PayAmount_Bz=10000,
        @IsCompanyExpense=0,@ApplyGuid='355C29CD-296A-11EB-983C-94C691B09297',@ApplySubject=N'测试测试测试',@ApplyState=N'未审核',
        @PayState=N'未支付',@TotalInvoiceCount=0,@TaxableInvoiceCount=0,@ProviderName=N'',@ProviderGuid=N'',
        @BudGetGUID='1313011F-B5B4-E711-94E7-00155D0A210D',@BudGetName=N'供应商X'
   ```

   

2. 清空该报销单据已存在发票信息

   ```
   exec sp_executesql N'
   				delete from cb_InvoiceItemDetail
   				where InvoiceItemGUID in (
   					select InvoiceItemGUID
   					from cb_InvoiceItem
   					where RefGUID in (
   						select ExpenseDtlGUID
   						from cb_ExpenseDtl
   						where ExpenseGUID=@ExpenseGUID
   					)
   				);
   
   				delete from cb_InvoiceItem
   				where RefGUID in (
   					select ExpenseDtlGUID
   					from cb_ExpenseDtl
   					where ExpenseGUID=@ExpenseGUID
   				);
   
   				delete from cb_ExpenseDtl
   				where ExpenseGUID=@ExpenseGUID ;
   			',N'@ExpenseGUID uniqueidentifier',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297'
   ```

   

3. 添加报销发票信息

   ```
   exec sp_executesql
        N'insert into [cb_ExpenseDtl] ([ExpenseDtlGUID],[Amount_Bz],[Brief],[ExpenseDtlName],[ExpenseGUID],[OccurDate],[IsCanDeductible],[InputTaxAmount],[ExcludingTaxApplyAmount],[AccountingSubjectGUID],[AccountingSubject],[InvoiceXml],[InvoiceType],[TaxType],[Invoice_Amount],[Invoice_InputTaxAmount],[Invoice_ExcludingTaxApplyAmount]) values (@ExpenseDtlGUID,@Amount_Bz,@Brief,@ExpenseDtlName,@ExpenseGUID,@OccurDate,@IsCanDeductible,@InputTaxAmount,@ExcludingTaxApplyAmount,@AccountingSubjectGUID,@AccountingSubject,@InvoiceXml,@InvoiceType,@TaxType,@Invoice_Amount,@Invoice_InputTaxAmount,@Invoice_ExcludingTaxApplyAmount)',
        N'@ExpenseDtlGUID uniqueidentifier,@Amount_Bz decimal(4,0),@Brief nvarchar(3),@ExpenseDtlName nvarchar(9),@ExpenseGUID uniqueidentifier,@OccurDate datetime,@IsCanDeductible int,@InputTaxAmount decimal(5,2),@ExcludingTaxApplyAmount decimal(6,2),@AccountingSubjectGUID uniqueidentifier,@AccountingSubject nvarchar(3),@InvoiceXml nvarchar(4000),@InvoiceType nvarchar(7),@TaxType nvarchar(2),@Invoice_Amount decimal(4,0),@Invoice_InputTaxAmount decimal(5,2),@Invoice_ExcludingTaxApplyAmount decimal(6,2)',
        @ExpenseDtlGUID='9174AF7F-39EB-11EB-9832-94C691040297',@Amount_Bz=5000,@Brief=N'xxx',@ExpenseDtlName=N'日常报销-办公用品',
        @ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297',@OccurDate='2020-12-01 00:00:00',@IsCanDeductible=1,
        @InputTaxAmount=145.63,@ExcludingTaxApplyAmount=4854.37,
        @AccountingSubjectGUID='A2F11F76-98F8-E811-AAD4-00155D0A1C3E',@AccountingSubject=N'办公费',@InvoiceXml=N'',
        @InvoiceType=N'增值税专用发票',@TaxType=N'3%',@Invoice_Amount=5000,@Invoice_InputTaxAmount=145.63,
        @Invoice_ExcludingTaxApplyAmount=4854.37
   ```

   ```
   exec sp_executesql
        N'insert into [cb_ExpenseDtl] ([ExpenseDtlGUID],[Amount_Bz],[Brief],[ExpenseDtlName],[ExpenseGUID],[OccurDate],[IsCanDeductible],[InputTaxAmount],[ExcludingTaxApplyAmount],[AccountingSubjectGUID],[AccountingSubject],[InvoiceXml],[InvoiceType],[TaxType],[Invoice_Amount],[Invoice_InputTaxAmount],[Invoice_ExcludingTaxApplyAmount]) values (@ExpenseDtlGUID,@Amount_Bz,@Brief,@ExpenseDtlName,@ExpenseGUID,@OccurDate,@IsCanDeductible,@InputTaxAmount,@ExcludingTaxApplyAmount,@AccountingSubjectGUID,@AccountingSubject,@InvoiceXml,@InvoiceType,@TaxType,@Invoice_Amount,@Invoice_InputTaxAmount,@Invoice_ExcludingTaxApplyAmount)',
        N'@ExpenseDtlGUID uniqueidentifier,@Amount_Bz decimal(4,0),@Brief nvarchar(3),@ExpenseDtlName nvarchar(7),@ExpenseGUID uniqueidentifier,@OccurDate datetime,@IsCanDeductible int,@InputTaxAmount decimal(5,2),@ExcludingTaxApplyAmount decimal(6,2),@AccountingSubjectGUID uniqueidentifier,@AccountingSubject nvarchar(3),@InvoiceXml nvarchar(4000),@InvoiceType nvarchar(7),@TaxType nvarchar(2),@Invoice_Amount decimal(4,0),@Invoice_InputTaxAmount decimal(5,2),@Invoice_ExcludingTaxApplyAmount decimal(6,2)',
        @ExpenseDtlGUID='9174AF80-39EB-11EB-9832-94C691040297',@Amount_Bz=5000,@Brief=N'yyy',@ExpenseDtlName=N'日常报销-交通',
        @ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297',@OccurDate='2020-12-01 00:00:00',@IsCanDeductible=1,
        @InputTaxAmount=145.63,@ExcludingTaxApplyAmount=4854.37,
        @AccountingSubjectGUID='A3F11F76-98F8-E811-AAD4-00155D0A1C3E',@AccountingSubject=N'差旅费',@InvoiceXml=N'',
        @InvoiceType=N'增值税专用发票',@TaxType=N'3%',@Invoice_Amount=5000,@Invoice_InputTaxAmount=145.63,
        @Invoice_ExcludingTaxApplyAmount=4854.37
   ```

4. 清空该报销单据已存在付款信息

   ```
   -- 冲帐明细
   exec sp_executesql N'delete from cb_LoanBalanceApply where RefGUID=@ExpenseGUID ',N'@ExpenseGUID uniqueidentifier',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297'
   -- 费用预算使用明细表
   exec sp_executesql N'delete from ys_DeptCostUseDtl where BusinessGUID=@ExpenseGUID ',N'@ExpenseGUID uniqueidentifier',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297'
   -- 日常报销冲账明细表
   exec sp_executesql N'delete from cb_Expense_FluentDetails where BusinessGUID=@ExpenseGUID ',N'@ExpenseGUID uniqueidentifier',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297'
   ```

   

5. 添加报销单关联费用预算使用明细

   ```
   exec sp_executesql
        N'insert into [ys_DeptCostUseDtl] ([DeptCostUseDtlGUID],[BusinessType],[BusinessGUID],[ProceedingGUID],[CostGUID],[FluentCostFullName],[LoanFtDetailGUIDList],[CorrespondingAmountList],[ZrrGUID],[ZrrName],[DeptGUID],[DeptName],[FtAmount],[Year],[Month],[EntryCostGUID],[EntryCostCode],[EntryCostName]) values (@DeptCostUseDtlGUID,@BusinessType,@BusinessGUID,@ProceedingGUID,@CostGUID,@FluentCostFullName,@LoanFtDetailGUIDList,@CorrespondingAmountList,@ZrrGUID,@ZrrName,@DeptGUID,@DeptName,@FtAmount,@Year,@Month,@EntryCostGUID,@EntryCostCode,@EntryCostName)',
        N'@DeptCostUseDtlGUID uniqueidentifier,@BusinessType nvarchar(4),@BusinessGUID uniqueidentifier,@ProceedingGUID uniqueidentifier,@CostGUID uniqueidentifier,@FluentCostFullName nvarchar(4000),@LoanFtDetailGUIDList nvarchar(4000),@CorrespondingAmountList nvarchar(4000),@ZrrGUID uniqueidentifier,@ZrrName nvarchar(2),@DeptGUID uniqueidentifier,@DeptName nvarchar(19),@FtAmount decimal(4,0),@Year int,@Month tinyint,@EntryCostGUID uniqueidentifier,@EntryCostCode nvarchar(4),@EntryCostName nvarchar(3)',
        @DeptCostUseDtlGUID='9174AF81-39EB-11EB-9832-94C691040297',@BusinessType=N'日常报销',
        @BusinessGUID='9174AF7E-39EB-11EB-9832-94C691040297',@ProceedingGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',
        @CostGUID='BE1B57F7-7744-E911-AADB-00155D0A1C3E',@FluentCostFullName=N'',@LoanFtDetailGUIDList=N'',
        @CorrespondingAmountList=N'',@ZrrGUID='0BB159B2-527C-4D51-B84B-64669F7216C1',@ZrrName=N'11',
        @DeptGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',@DeptName=N'2020年-营销全成本-测试项目-六期',@FtAmount=8000,@Year=2020,
        @Month=12,@EntryCostGUID='A3F11F76-98F8-E811-AAD4-00155D0A1C3E',@EntryCostCode=N'C.02',@EntryCostName=N'差旅费'
        
   exec sp_executesql
        N'insert into [ys_DeptCostUseDtl] ([DeptCostUseDtlGUID],[BusinessType],[BusinessGUID],[ProceedingGUID],[CostGUID],[FluentCostFullName],[LoanFtDetailGUIDList],[CorrespondingAmountList],[ZrrGUID],[ZrrName],[DeptGUID],[DeptName],[FtAmount],[Year],[Month],[EntryCostGUID],[EntryCostCode],[EntryCostName]) values (@DeptCostUseDtlGUID,@BusinessType,@BusinessGUID,@ProceedingGUID,@CostGUID,@FluentCostFullName,@LoanFtDetailGUIDList,@CorrespondingAmountList,@ZrrGUID,@ZrrName,@DeptGUID,@DeptName,@FtAmount,@Year,@Month,@EntryCostGUID,@EntryCostCode,@EntryCostName)',
        N'@DeptCostUseDtlGUID uniqueidentifier,@BusinessType nvarchar(4),@BusinessGUID uniqueidentifier,@ProceedingGUID uniqueidentifier,@CostGUID uniqueidentifier,@FluentCostFullName nvarchar(4000),@LoanFtDetailGUIDList nvarchar(4000),@CorrespondingAmountList nvarchar(4000),@ZrrGUID uniqueidentifier,@ZrrName nvarchar(2),@DeptGUID uniqueidentifier,@DeptName nvarchar(19),@FtAmount decimal(4,0),@Year int,@Month tinyint,@EntryCostGUID uniqueidentifier,@EntryCostCode nvarchar(4),@EntryCostName nvarchar(5)',
        @DeptCostUseDtlGUID='9174AF82-39EB-11EB-9832-94C691040297',@BusinessType=N'日常报销',
        @BusinessGUID='9174AF7E-39EB-11EB-9832-94C691040297',@ProceedingGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',
        @CostGUID='BF1B57F7-7744-E911-AADB-00155D0A1C3E',@FluentCostFullName=N'',@LoanFtDetailGUIDList=N'',
        @CorrespondingAmountList=N'',@ZrrGUID='0BB159B2-527C-4D51-B84B-64669F7216C1',@ZrrName=N'11',
        @DeptGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30',@DeptName=N'2020年-营销全成本-测试项目-六期',@FtAmount=2000,@Year=2020,
        @Month=12,@EntryCostGUID='1D097CAB-98F8-E811-AAD4-00155D0A1C3E',@EntryCostCode=N'C.05',@EntryCostName=N'水电物管费'
   ```

   

6. 清空该报销单据已存在日常报销收款信息

   ```
   exec sp_executesql N'delete from fy_ExpenseReceiverDtl where ExpenseGUID=@ExpenseGUID ',N'@ExpenseGUID uniqueidentifier',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297'
   ```

   

7. 插入日常报销收款信息

   ```
   exec sp_executesql
        N'insert into [fy_ExpenseReceiverDtl] ([ExpenseReceiverGUID],[ExpenseGUID],[ReceiverGUID],[ReceiverName],[ReceiverBankName],[ReceiverBankAccounts],[ReceiveType],[ReceiveAmount]) values (@ExpenseReceiverGUID,@ExpenseGUID,@ReceiverGUID,@ReceiverName,@ReceiverBankName,@ReceiverBankAccounts,@ReceiveType,@ReceiveAmount)',
        N'@ExpenseReceiverGUID uniqueidentifier,@ExpenseGUID uniqueidentifier,@ReceiverGUID uniqueidentifier,@ReceiverName nvarchar(4),@ReceiverBankName nvarchar(4),@ReceiverBankAccounts nvarchar(4),@ReceiveType nvarchar(4000),@ReceiveAmount decimal(5,0)',
        @ExpenseReceiverGUID='9174AF83-39EB-11EB-9832-94C691040297',@ExpenseGUID='9174AF7E-39EB-11EB-9832-94C691040297',
        @ReceiverGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@ReceiverName=N'订单系统',@ReceiverBankName=N'xxxx',
        @ReceiverBankAccounts=N'xxxx',@ReceiveType=N'',@ReceiveAmount=10000
   ```

#### 1.7.6.3 修改加载

1. 报销主要信息

   ```
   SELECT top 1[ExpenseGUID], [Subject], [Theme], [ExpenseCode], [AppliedBy], [AppliedByName], [ApplyBUGUID], [ProjGUID], [CurrencyGUID], [Rate], [BUGUID], [ApplyDate], [ExpenseTypeGUID], [ExpenseTypeName], [PayProviderGUID], [PayProviderName], [IsDeductibleloan], [Remarks], [ExpenseAmount], [ExpenseAmount_Bz], [BalanceAmount], [BalanceAmount_Bz], [PayAmount], [PayAmount_Bz], [IsCompanyExpense], [ApplyGuid], [ApplySubject], [ApplyState], [PayState], [TotalInvoiceCount], [TaxableInvoiceCount], [ProviderName], [ProviderGuid], [IsCopyData], [BudGetGUID], [BudGetName]
   FROM cb_Expense
   WHERE (ExpenseGUID ='9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

2. 日常报销明细信息

   ```
   SELECT [ExpenseDtlGUID],
          [Amount_Bz],
          [Brief],
          [ExpenseDtlName],
          [ExpenseGUID],
          [OccurDate],
          [IsCanDeductible],
          [InputTaxAmount],
          [ExcludingTaxApplyAmount],
          [AccountingSubjectGUID],
          [AccountingSubject],
          [InvoiceXml],
          [InvoiceType],
          [TaxType],
          [Invoice_Amount],
          [Invoice_InputTaxAmount],
          [Invoice_ExcludingTaxApplyAmount]
   FROM cb_ExpenseDtl
   WHERE (ExpenseGUID = '9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

3. 冲帐明细

   ```
   SELECT [LoanBalanceApplyGUID],
          [LoanGUID],
          [RefGUID],
          [RefType],
          [BalanceAmount_Bz],
          [CurBalanceAmount_Bz],
          [LoanAmount_Bz],
          [RemainAmount_Bz]
   FROM cb_LoanBalanceApply
   WHERE (RefGUID = '9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

4. 附件信息

   ```
   SELECT [DocGUID],
          [FkGUID],
          [DocType],
          [DocName],
          [FileName],
          [Location],
          [CreateOn],
          [CreateBy]
   FROM p_Documents
   WHERE (FkGUID = '9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

5. 分摊信息

   ```
   SELECT [DeptCostUseDtlGUID],
          [BusinessType],
          [BusinessGUID],
          [ProceedingGUID],
          [CostGUID],
          [FluentCostFullName],
          [LoanFtDetailGUIDList],
          [CorrespondingAmountList],
          [FluentLoanGUID],
          [LoanBalance],
          [CorrespondingAmount],
          [ZrrGUID],
          [ZrrName],
          [DeptGUID],
          [DeptName],
          [FtAmount],
          [UsedAmount],
          [Year],
          [Month],
          [EntryCostGUID],
          [EntryCostCode],
          [EntryCostName],
          [PaymentName],
          [PaymentGUID],
          [BudgetName],
          [BudgetGUID]
   FROM ys_DeptCostUseDtl
   WHERE (BusinessGUID = '9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

6. 收款信息

   ```
   SELECT [ExpenseReceiverGUID],
          [ExpenseGUID],
          [ReceiverGUID],
          [ReceiverName],
          [ReceiverBankName],
          [ReceiverBankAccounts],
          [ReceiveType],
          [ReceiveAmount]
   FROM fy_ExpenseReceiverDtl
   WHERE (ExpenseGUID = '9174af7e-39eb-11eb-9832-94c691040297')
   ```

   

7. 付款申请信息

   ```
   exec sp_executesql N'SELECT ApplyAmount FROM fy_Apply WHERE ApplyGUID = @ApplyGUID',N'@ApplyGUID uniqueidentifier',@ApplyGUID='355C29CD-296A-11EB-983C-94C691B09297'
   ```

   

8. 收票单据明细

   ```
   SELECT *
   FROM cb_InvoiceItem
   WHERE RefGUID = '9174af7f-39eb-11eb-9832-94c691040297'
   ```

   

9. 分摊明细科目事项

   ```
   
   exec sp_executesql N'SELECT  year ,
                                   SpecialUnitGUID AS value ,
                                   ''日常费用'' name
                           FROM    dbo.ys_SpecialBusinessUnit
                           WHERE   SpecialUnitGUID = @DeptGUID
                           UNION ALL
                           SELECT DISTINCT
                                   a.year ,
                                   a.ProceedingGUID value,
                                   a.ProceedingName name
                           FROM    vys_Proceeding a
                           WHERE   a.IsDisabled = 0
                                   AND a.ApproveState = ''已审核''
                                   AND a.DeptGUID = @DeptGUID
                                   AND a.IsDisabled = 0',N'@DeptGUID uniqueidentifier',@DeptGUID='FB489BA6-7ADE-11EA-8B09-00155D0A1C30'
   ```

   

10. 报销信息关联文档

    ```
    SELECT [DocGUID],[FkGUID],[DocType],[DocName],[FileName],[Location],[CreateOn],[CreateBy] FROM p_Documents WHERE (FkGUID ='9174af7e-39eb-11eb-9832-94c691040297')
    ```

    

#### 1.7.6.3 提交审批

#### 1.7.6.4 审批通过

#### 1.7.6.5 审批驳回

### 1.7.7 借款申请

#### 1.7.7.1 列表查询

```
SELECT TOP 20 vcb_Loan_Simple.LoanGUID,
              vcb_Loan_Simple.LoanCode,
              vcb_Loan_Simple.ApplyState,
              vcb_Loan_Simple.Subject,
              vcb_Loan_Simple.LoanAmount,
              vcb_Loan_Simple.BalanceAmount,
              vcb_Loan_Simple.RemainAmount,
              vcb_Loan_Simple.ApplyDeptName,
              vcb_Loan_Simple.AppliedByName,
              vcb_Loan_Simple.ApplyDate,
              vcb_Loan_Simple.AppliedBy
FROM vcb_Loan_Simple
WHERE ((1 = 1 AND (1 = 1)))
  AND (1 = 1)
  AND vcb_Loan_Simple.BUGUID = ('38da7886-bc9e-4431-b065-1c02ec79f80f')
  AND vcb_Loan_Simple.ApplyState IN ('未审核', '审核中')
ORDER BY vcb_Loan_Simple.ApplyDate DESC, vcb_Loan_Simple.LoanGUID
```



#### 1.7.7.2 新增保存

1. 费用付款类型表-最低借款金额控制

   ```
   exec sp_executesql N'SELECT LoanAmount FROM fy_FKSPType where FKSPTypeGUID=@FKSPTypeGUID and ISLoanAmountControl=1',
        N'@FKSPTypeGUID nvarchar(36)',@FKSPTypeGUID=N'1a9c0043-0ee7-e811-aacb-00155d0a1c3e'
   ```

2. 获取申请单信息

   ```
   exec sp_executesql N'SELECT * FROM dbo.fy_Apply WHERE ApplyGUID =@ApplyGUID',N'@ApplyGUID nvarchar(36)',@ApplyGUID=N'23c8a30f-14d2-11eb-9825-54e1ad201170'
   ```

3. 删除已存在借款单

   ```
   exec sp_executesql N'DELETE FROM cb_Loan WHERE LoanGUID = @LoanGUID',N'@LoanGUID uniqueidentifier',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

4. 删除已存在借款单分摊明细

   ```
   exec sp_executesql N'DELETE FROM cb_Loan_FtDetail WHERE LoanGUID = @LoanGUID',N'@LoanGUID uniqueidentifier',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

5. 插入借款单信息

   ```
   exec sp_executesql N'insert into [cb_Loan] 
   ([LoanGUID],[BUGUID],[Subject],[LoanCode],[ApplyState],[AppliedBy],[AppliedByName],[ApplyBUGUID],[ApplyDate],[PayProviderGUID],[PayProviderName],[CurrencyGUID],[LoanAmount_Bz],[LoanAmount],[BalanceAmount_Bz],[BalanceAmount],[RemainAmount_Bz],[RemainAmount],[PayState],[LoanTypeGUID],[LoanTypeName],[Rate],[LoanType],[ReceiverName],[ReceiveType],[RelateApplyGUID]) 
   values (@LoanGUID,@BUGUID,@Subject,@LoanCode,@ApplyState,@AppliedBy,@AppliedByName,@ApplyBUGUID,@ApplyDate,@PayProviderGUID,@PayProviderName,@CurrencyGUID,@LoanAmount_Bz,@LoanAmount,@BalanceAmount_Bz,@BalanceAmount,@RemainAmount_Bz,@RemainAmount,@PayState,@LoanTypeGUID,@LoanTypeName,@Rate,@LoanType,@ReceiverName,@ReceiveType,@RelateApplyGUID)',
        N'@LoanGUID uniqueidentifier,@BUGUID uniqueidentifier,@Subject nvarchar(15),@LoanCode nvarchar(13),@ApplyState nvarchar(3),@AppliedBy uniqueidentifier,@AppliedByName nvarchar(4),@ApplyBUGUID uniqueidentifier,@ApplyDate datetime,@PayProviderGUID uniqueidentifier,@PayProviderName nvarchar(2),@CurrencyGUID uniqueidentifier,@LoanAmount_Bz decimal(6,2),@LoanAmount decimal(6,2),@BalanceAmount_Bz decimal(2,2),@BalanceAmount decimal(1,0),@RemainAmount_Bz decimal(6,2),@RemainAmount decimal(6,2),@PayState nvarchar(3),@LoanTypeGUID uniqueidentifier,@LoanTypeName nvarchar(5),@Rate decimal(5,4),@LoanType nvarchar(2),@ReceiverName nvarchar(4),@ReceiveType nvarchar(3),@RelateApplyGUID uniqueidentifier',
        @LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE',@BUGUID='38DA7886-BC9E-4431-B065-1C02EC79F80F',
        @Subject=N'liuwz借款单1209001',@LoanCode=N'LJK2020120003',@ApplyState=N'未审核',
        @AppliedBy='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@AppliedByName=N'订单系统',
        @ApplyBUGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@ApplyDate='2020-12-09 00:00:00',
        @PayProviderGUID='7BF41540-FDE6-E811-AACB-00155D0A1C3E',@PayProviderName=N'新力',
        @CurrencyGUID='F1AE9C30-FE32-4844-A772-23A9BB044D08',@LoanAmount_Bz=1000.00,@LoanAmount=1000.00,
        @BalanceAmount_Bz=0.00,@BalanceAmount=0,@RemainAmount_Bz=1000.00,@RemainAmount=1000.00,@PayState=N'未支付',
        @LoanTypeGUID='1A9C0043-0EE7-E811-AACB-00155D0A1C3E',@LoanTypeName=N'借款类型1',@Rate=1.0000,@LoanType=N'普通',
        @ReceiverName=N'订单系统',@ReceiveType=N'收款人',@RelateApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170'
   ```

6. 插入借款单分摊明细信息

   ```
   exec sp_executesql
        N'insert into [cb_Loan_FtDetail] ([FtDetailGUID],[DeptGUID],[DeptName],[ProceedingGUID],[ProceedingName],[CostGUID],[CostCode],[CostShortName],[FtAmount],[LoanGUID]) values (@FtDetailGUID,@DeptGUID,@DeptName,@ProceedingGUID,@ProceedingName,@CostGUID,@CostCode,@CostShortName,@FtAmount,@LoanGUID)',
        N'@FtDetailGUID uniqueidentifier,@DeptGUID uniqueidentifier,@DeptName nvarchar(19),@ProceedingGUID uniqueidentifier,@ProceedingName nvarchar(4),@CostGUID uniqueidentifier,@CostCode nvarchar(7),@CostShortName nvarchar(3),@FtAmount decimal(4,0),@LoanGUID uniqueidentifier',
        @FtDetailGUID='21806A07-CF39-EB11-A55A-00155D0A2516',@DeptGUID='F2876A7E-7ADE-11EA-8B09-00155D0A1C30',
        @DeptName=N'2020年-营销全成本-测试项目-二期',@ProceedingGUID='F2876A7E-7ADE-11EA-8B09-00155D0A1C30',@ProceedingName=N'日常费用',
        @CostGUID='B51B57F7-7744-E911-AADB-00155D0A1C3E',@CostCode=N'C.01.01',@CostShortName=N'办公费',@FtAmount=1000,
        @LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

#### 1.7.7.3 审核

1. 获取借款单状态

   ```
   SELECT ISNULL(ApplyState,'未审核') FROM vcb_Loan WHERE LoanGUID='c16176f2-66e7-4a91-ac36-3c5dd6e880ce'
   ```

2. 获取借款单信息

   ```
   SELECT top 1[BUGUID], [AppliedBy], [ApplyBUGUID], [ApplyState], [PayState], [LoanAmount], [BalanceAmount], [PayProviderName], [ReceiveProviderName], [LoanTypeName], [ReceiverGUID], [Subject], [LoanCode], [AppliedByName], [ApplyDate], [LoanTypeGUID], [PayProviderGUID], [ReceiveType], [ReceiveProviderGUID], [BankName], [BankAccounts], [ReceiverName], [ReceiverBankName], [ReceiverBankAccounts], [LoanAmount_Bz], [BalanceAmount_Bz], [RemainAmount_Bz], [CurrencyGUID], [Rate], [RemainAmount], [LoanType], [RelateApplyGUID], [Remarks], [LoanGUID], [PayMode], [IsAccount], [IfLocked], [IfCqbyj], [ProjGUID], [FinishDateTime], [ApproveBy]
   FROM cb_Loan
   WHERE (LoanGUID ='c16176f2-66e7-4a91-ac36-3c5dd6e880ce')
   ```

3. 获取借款单分摊明细信息

   ```
   SELECT [CostCode],
          [CostGUID],
          [CostShortName],
          [DeptGUID],
          [DeptName],
          [FtAmount],
          [FtDetailGUID],
          [LoanGUID],
          [ProceedingGUID],
          [ProceedingName],
          [IsUsed],
          [BalanceAmount]
   FROM cb_Loan_FtDetail
   WHERE (LoanGUID = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce')
   ```

4. 获取借款单关联申请单信息

   ```
   SELECT top 1[ApplyGUID], [DeptGUID], [DeptName], [ApproveState], [ApplySubject], [ApplyAmount], [Applier], [ApplierGUID], [ApplyDate], [ApplyTypeGUID], [ApplyType], [Remark], [IsLoan], [LoanGUID], [LoanAmount], [LoanReason], [PayProviderGUID], [PayProviderName], [ReceiveType], [ReceiverGUID], [ReceiverName], [ReceiveProviderName], [ReceiveProviderGUID], [IsInvalid], [IsCrossYear], [CrossYearAmount], [ApplyCancelState], [IsUseOtherFee], [FtBeginDate], [FtPeriod], [HasBeenUsed], [UsedApplyAmount], [PaymentUnitGUID], [PaymentUnit], [IsRelease]
   FROM fy_Apply
   WHERE (ApplyGUID ='23c8a30f-14d2-11eb-9825-54e1ad201170')
   ```

5. 获取借款单关联申请单科目分摊表

   ```
   SELECT [FtDetailGUID],
          [DeptGUID],
          [DeptName],
          [ProceedingGUID],
          [ProceedingName],
          [CostGUID],
          [CostCode],
          [CostShortName],
          [Amount],
          [RefAmount],
          [LoanAmount],
          [ApplyGUID],
          [HasBeenUsed]
   FROM fy_Apply_FtDetail
   WHERE (ApplyGUID = '23c8a30f-14d2-11eb-9825-54e1ad201170')
   ```

6. 申请单分摊明细在分摊周期上的分摊信息

   ```
   SELECT [FtDetailPeriodGUID],
          [DeptGUID],
          [DeptName],
          [ProceedingGUID],
          [ProceedingName],
          [CostGUID],
          [CostCode],
          [CostShortName],
          [FtAmount],
          [RefAmount],
          [ApplyGUID],
          [FtYear],
          [FtMonth]
   FROM fy_Apply_FtDetail_Period
   WHERE (ApplyGUID = '23c8a30f-14d2-11eb-9825-54e1ad201170')
   ```

   

7. usp_fy_ValidWarnControl

   ```
   exec usp_fy_ValidWarnControl @BusinessGUID=N'c16176f2-66e7-4a91-ac36-3c5dd6e880ce',@xmldoc=N'',@IsSendMsg=1,@RefType=N'借款单',@BlRelatedApplyGuid=N'00000000-0000-0000-0000-000000000000'
   ```

8. 费用预警强控错误信息表

   ```
   exec sp_executesql N'SELECT MsgInfo FROM ys_DeptWarnControlErrorInfo WHERE ErrorType=''强控'' AND BusinessGUID=@BusinessGUID',N'@BusinessGUID nvarchar(36)',@BusinessGUID=N'c16176f2-66e7-4a91-ac36-3c5dd6e880ce'
   ```

9. 更新借款单信息

   ```
   exec sp_executesql N'update [cb_Loan] set  [BUGUID] = @BUGUID ,  [Subject] = @Subject ,  [LoanCode] = @LoanCode ,  [ApplyState] = @ApplyState ,  [AppliedBy] = @AppliedBy ,  [AppliedByName] = @AppliedByName ,  [ApplyBUGUID] = @ApplyBUGUID ,  [ApplyDate] = 
   @ApplyDate ,  [PayProviderGUID] = @PayProviderGUID ,  [PayProviderName] = @PayProviderName ,  [CurrencyGUID] = @CurrencyGUID ,  [LoanAmount_Bz] = @LoanAmount_Bz ,  [LoanAmount] = @LoanAmount ,  [BalanceAmount_Bz] = @BalanceAmount_Bz ,  [BalanceAmount] = 
   @BalanceAmount ,  [RemainAmount_Bz] = @RemainAmount_Bz ,  [RemainAmount] = @RemainAmount ,  [IsAccount] = @IsAccount ,  [IfLocked] = @IfLocked ,  [PayState] = @PayState ,  [LoanTypeGUID] = @LoanTypeGUID ,  [IfCqbyj] = @IfCqbyj ,  [LoanTypeName] = @LoanTypeName 
   ,  [Rate] = @Rate ,  [LoanType] = @LoanType ,  [ReceiverName] = @ReceiverName ,  [ReceiveType] = @ReceiveType ,  [RelateApplyGUID] = @RelateApplyGUID where  [LoanGUID] = @LoanGUID',
        N'@BUGUID uniqueidentifier,@Subject nvarchar(15),@LoanCode nvarchar(13),@ApplyState nvarchar(3),@AppliedBy uniqueidentifier,@AppliedByName nvarchar(4),@ApplyBUGUID uniqueidentifier,@ApplyDate datetime,@PayProviderGUID uniqueidentifier,@PayProviderName nvarchar(2),@CurrencyGUID uniqueidentifier,@LoanAmount_Bz decimal(8,4),@LoanAmount decimal(8,4),@BalanceAmount_Bz decimal(4,4),@BalanceAmount decimal(4,4),@RemainAmount_Bz decimal(8,4),@RemainAmount decimal(8,4),@IsAccount tinyint,@IfLocked tinyint,@PayState nvarchar(3),@LoanTypeGUID uniqueidentifier,@IfCqbyj tinyint,@LoanTypeName nvarchar(5),@Rate decimal(5,4),@LoanType nvarchar(2),@ReceiverName nvarchar(4),@ReceiveType nvarchar(3),@RelateApplyGUID uniqueidentifier,@LoanGUID uniqueidentifier',
        @BUGUID='38DA7886-BC9E-4431-B065-1C02EC79F80F',@Subject=N'liuwz借款单1209001',@LoanCode=N'LJK2020120003',
        @ApplyState=N'审核中',@AppliedBy='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@AppliedByName=N'订单系统',
        @ApplyBUGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@ApplyDate='2020-12-09 00:00:00',
        @PayProviderGUID='7BF41540-FDE6-E811-AACB-00155D0A1C3E',@PayProviderName=N'新力',
        @CurrencyGUID='F1AE9C30-FE32-4844-A772-23A9BB044D08',@LoanAmount_Bz=1000.0000,@LoanAmount=1000.0000,
        @BalanceAmount_Bz=0.0000,@BalanceAmount=0.0000,@RemainAmount_Bz=1000.0000,@RemainAmount=1000.0000,@IsAccount=0,
        @IfLocked=0,@PayState=N'未支付',@LoanTypeGUID='1A9C0043-0EE7-E811-AACB-00155D0A1C3E',@IfCqbyj=0,
        @LoanTypeName=N'借款类型1',@Rate=1.0000,@LoanType=N'普通',@ReceiverName=N'订单系统',@ReceiveType=N'收款人',
        @RelateApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

   

10. 更新借款单关联申请单科目分摊表

    ```
    exec sp_executesql N'
                        UPDATE fy_Apply_FtDetail 
                        SET HasBeenUsed = @HasBeenUsedFlag
                        WHERE ApplyGUID = @ApplyGUID',N'@HasBeenUsedFlag int,@ApplyGUID uniqueidentifier',@HasBeenUsedFlag=1,@ApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170'
    ```

    

11. 更新借款单关联申请单状态

    ```
    exec sp_executesql N'
                        UPDATE a
                        SET  a.HasBeenUsed = CASE WHEN (SELECT COUNT(1) FROM fy_Apply_FtDetail
    														WHERE ApplyGUID =  @ApplyGUID
    														AND ISNULL(HasBeenUsed,0) = 0) > 0 THEN 0 
    											 ELSE 1 END
                        FROM dbo.fy_Apply a
                        WHERE a.ApplyGUID = @ApplyGUID
                        ',N'@ApplyGUID uniqueidentifier',@ApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170'
    ```

    ```
    exec sp_executesql N'
                        UPDATE fy_Apply
                        SET UsedApplyAmount = (
    					                    SELECT SUM(BudgetAmount) AS UsedApplyAmount FROM (
    											SELECT mainRef.ApplyGUID,FtDetail.DeptGUID,FtDetail.ProceedingGUID,FtDetail.CostGUID,FtDetail.BudgetAmount FROM cb_Contract mainRef
    											INNER JOIN ys_DeptCost2ContractUseDtl FtDetail ON mainRef.ContractGUID=FtDetail.BusinessGUID AND FtDetail.ContractGUID = mainRef.ContractGUID
    											WHERE mainRef.ApplyGUID=@ApplyGUID AND mainRef.ApproveState<>''未审核''
    											UNION ALL
    											SELECT mainRef.ApplyGUID,FtDetail.DeptGUID,FtDetail.ProceedingGUID,FtDetail.CostGUID,FtDetail.FtAmount AS BudgetAmount FROM cb_Expense mainRef
    											INNER JOIN ys_DeptCostUseDtl FtDetail ON mainRef.ExpenseGUID=FtDetail.BusinessGUID 
    											WHERE mainRef.ApplyGUID=@ApplyGUID AND mainRef.ApplyState<>''未审核''
                                                UNION ALL
    											SELECT  mainRef.RelateApplyGUID , FtDetail.DeptGUID , FtDetail.ProceedingGUID , FtDetail.CostGUID , FtDetail.FtAmount AS BudgetAmount
    											FROM dbo.cb_Loan_FtDetail FtDetail
    											INNER JOIN dbo.cb_Loan mainRef ON mainRef.LoanGUID = FtDetail.LoanGUID
    											WHERE mainRef.RelateApplyGUID = @ApplyGUID AND mainRef.ApplyState<>''未审核''
    										)costAll
    		            )
                        WHERE ApplyGUID = @ApplyGUID
                        ',N'@ApplyGUID uniqueidentifier',@ApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170'
    ```

    

12. 更新事项年度预算表和部门年度预算表

    ```
    UPDATE ys_YearPlanProceeding2Cost
    SET OccupiedAmount10 = ISNULL(OccupiedAmount10,0) - 1000.0000,
        FactAmount10     = ISNULL(FactAmount10,0) - 1000.0000
    WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND ProceedingGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
    
    UPDATE ys_YearPlanDept2Cost
    SET OccupiedAmount10 = ISNULL(OccupiedAmount10,0) - 1000.0000,
        FactAmount10     = ISNULL(FactAmount10,0) - 1000.0000
    WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
                
    ```

    ```
    UPDATE ys_YearPlanProceeding2Cost
    SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 1000.0000,
        FactAmount12     = ISNULL(FactAmount12,0) + 1000.0000,
        PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) + 1000.0000
    WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND ProceedingGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
    
    UPDATE ys_YearPlanDept2Cost
    SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 1000.0000,
        FactAmount12     = ISNULL(FactAmount12,0) + 1000.0000,
        PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) + 1000.0000
    WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
      AND Year = 2020
      AND CostGUID IN
          (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
                
    ```

    

13. 跟新借款单信息

    ```
    exec sp_executesql N'update [cb_Loan] set  [BUGUID] = @BUGUID ,  [Subject] = @Subject ,  [LoanCode] = @LoanCode ,  [ApplyState] = @ApplyState ,  [AppliedBy] = @AppliedBy ,  [AppliedByName] = @AppliedByName ,  [ApplyBUGUID] = @ApplyBUGUID ,  [ApplyDate] = 
    @ApplyDate ,  [PayProviderGUID] = @PayProviderGUID ,  [PayProviderName] = @PayProviderName ,  [CurrencyGUID] = @CurrencyGUID ,  [LoanAmount_Bz] = @LoanAmount_Bz ,  [LoanAmount] = @LoanAmount ,  [BalanceAmount_Bz] = @BalanceAmount_Bz ,  [BalanceAmount] = 
    @BalanceAmount ,  [RemainAmount_Bz] = @RemainAmount_Bz ,  [RemainAmount] = @RemainAmount ,  [IsAccount] = @IsAccount ,  [IfLocked] = @IfLocked ,  [PayState] = @PayState ,  [LoanTypeGUID] = @LoanTypeGUID ,  [IfCqbyj] = @IfCqbyj ,  [LoanTypeName] = @LoanTypeName 
    ,  [Rate] = @Rate ,  [LoanType] = @LoanType ,  [ReceiverName] = @ReceiverName ,  [ReceiveType] = @ReceiveType ,  [RelateApplyGUID] = @RelateApplyGUID where  [LoanGUID] = @LoanGUID',
         N'@BUGUID uniqueidentifier,@Subject nvarchar(15),@LoanCode nvarchar(13),@ApplyState nvarchar(3),@AppliedBy uniqueidentifier,@AppliedByName nvarchar(4),@ApplyBUGUID uniqueidentifier,@ApplyDate datetime,@PayProviderGUID uniqueidentifier,@PayProviderName nvarchar(2),@CurrencyGUID uniqueidentifier,@LoanAmount_Bz decimal(8,4),@LoanAmount decimal(8,4),@BalanceAmount_Bz decimal(4,4),@BalanceAmount decimal(4,4),@RemainAmount_Bz decimal(8,4),@RemainAmount decimal(8,4),@IsAccount tinyint,@IfLocked tinyint,@PayState nvarchar(3),@LoanTypeGUID uniqueidentifier,@IfCqbyj tinyint,@LoanTypeName nvarchar(5),@Rate decimal(5,4),@LoanType nvarchar(2),@ReceiverName nvarchar(4),@ReceiveType nvarchar(3),@RelateApplyGUID uniqueidentifier,@LoanGUID uniqueidentifier',
         @BUGUID='38DA7886-BC9E-4431-B065-1C02EC79F80F',@Subject=N'liuwz借款单1209001',@LoanCode=N'LJK2020120003',
         @ApplyState=N'已审核',@AppliedBy='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@AppliedByName=N'订单系统',
         @ApplyBUGUID='E777FC1B-F828-42B0-8888-25F6CEE41C2B',@ApplyDate='2020-12-09 00:00:00',
         @PayProviderGUID='7BF41540-FDE6-E811-AACB-00155D0A1C3E',@PayProviderName=N'新力',
         @CurrencyGUID='F1AE9C30-FE32-4844-A772-23A9BB044D08',@LoanAmount_Bz=1000.0000,@LoanAmount=1000.0000,
         @BalanceAmount_Bz=0.0000,@BalanceAmount=0.0000,@RemainAmount_Bz=1000.0000,@RemainAmount=1000.0000,@IsAccount=0,
         @IfLocked=0,@PayState=N'未支付',@LoanTypeGUID='1A9C0043-0EE7-E811-AACB-00155D0A1C3E',@IfCqbyj=0,
         @LoanTypeName=N'借款类型1',@Rate=1.0000,@LoanType=N'普通',@ReceiverName=N'订单系统',@ReceiveType=N'收款人',
         @RelateApplyGUID='23C8A30F-14D2-11EB-9825-54E1AD201170',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
    ```

    

14. 新增借款单科目比例表

    ```
    INSERT INTO dbo.cb_loan_kmBL(loan_kmBLGUID, loanGUID, costCode, costGUID, ftAmount, costPercent, DeptGUID)
    SELECT NEWID(),
           ft.LoanGUID,
           ft.CostCode,
           ft.CostGUID,
           ft.FtAmount,
           ROUND(CASE WHEN ISNULL(l.LoanAmount_Bz,0) = 0 THEN 0 ELSE ft.FtAmount / l.LoanAmount_Bz END,4),
           ft.DeptGUID
    FROM dbo.cb_Loan_FtDetail      ft
             LEFT JOIN dbo.cb_Loan l ON ft.LoanGUID = l.LoanGUID
    WHERE ft.LoanGUID = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce';
    SELECT ROW_NUMBER() over ( partition BY loanGUID ORDER by costCode) as rownum, *
    into #temp_cb_loan_kmBL
    FROM dbo.cb_loan_kmBL
    where loanguid = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce';
    
    UPDATE t1
    SET t1.costPercent = ISNULL(t2.per,t1.costPercent)
    FROM cb_loan_kmBL                        t1
             LEFT JOIN #temp_cb_loan_kmBL    temp ON t1.loan_kmBLGUID = temp.loan_kmBLGUID
             LEFT JOIN (SELECT 1 - SUM(costPercent) AS per, loanGUID
                        FROM #temp_cb_loan_kmBL t
                        WHERE t.rownum > 1
                        GROUP BY t.loanGUID) t2 ON t1.loanGUID = t2.loanGUID
    WHERE temp.rownum = 1
      and temp.loanguid = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce';
    ```

### 1.7.8 还款申请

#### 1.7.4.1 列表查询

1. 借款申请列表

   ```
   SELECT TOP 20 vcb_Loan_Simple.LoanGUID,
                       vcb_Loan_Simple.LoanCode,
                       vcb_Loan_Simple.ApplyState,
                       vcb_Loan_Simple.Subject,
                       vcb_Loan_Simple.LoanAmount,
                       vcb_Loan_Simple.BalanceAmount,
                       vcb_Loan_Simple.RemainAmount,
                       vcb_Loan_Simple.ApplyDeptName,
                       vcb_Loan_Simple.AppliedByName,
                       vcb_Loan_Simple.ApplyDate,
                       vcb_Loan_Simple.AppliedBy,
                       vcb_Loan_Simple.PayState
                       FROM vcb_Loan_Simple
                       WHERE ((1=1 AND ( 1=1 ))) AND (1=1 and AppliedBy='4230bc6e-69e6-46a9-a39e-b929a06a84e8') AND vcb_Loan_Simple.BUGUID=('38da7886-bc9e-4431-b065-1c02ec79f80f')
                       ORDER BY vcb_Loan_Simple.ApplyDate DESC,vcb_Loan_Simple.LoanGUID
   ```

   

2. 借款还款列表

   ```
   SELECT TOP 20 *
             FROM vcb_LoanBalanceAndLoanReturn
             WHERE (LoanGUID='c16176f2-66e7-4a91-ac36-3c5dd6e880ce') and RefType!='日常报销'
             ORDER BY case when RefType='直接还款' then 0  when RefType='日常报销' then 1 else 2 end, OccurDate DESC
           ,vcb_LoanBalanceAndLoanReturn.LoanBalanceApplyGUID
   ```

   

#### 1.7.4.2 新增保存

1. 获取借款信息-金额

   ```
   SELECT BalanceAmount_Bz as BalanceAmount ,RemainAmount_Bz as RemainAmount FROM cb_Loan WHERE LoanGUID='c16176f2-66e7-4a91-ac36-3c5dd6e880ce'
   ```

2. 更新还款信息

   ```
   UPDATE cb_LoanReturn
   SET LoanGUID='c16176f2-66e7-4a91-ac36-3c5dd6e880ce',
       ReturnedGUID='4230bc6e-69e6-46a9-a39e-b929a06a84e8',
       ApproveState=N'未审核',
       FKDJApproveState='未审核',
       PaymentUnitGUID='488f2fb9-2e72-e911-b398-00155d0a1c30',
       ReturnCode='HK2020120001',
       ReturnedBy='订单系统',
       ReturnDate='2020-12-09',
       ReturnAmount=1000.00,
       PayMode='现金',
       PaymentUnit='测试分类001',
       BankName='',
       Remarks=''
   WHERE LoanReturnGUID = 'a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

3. 更新还款文档信息

   ```
   exec sp_executesql N'update  p_Documents set FkGUID=@LoanReturnGUID WHERE FkGUID=@FkGUID',
        N'@LoanReturnGUID nvarchar(36),@FkGUID nvarchar(36)',@LoanReturnGUID=N'a1bba97f-e539-eb11-a55a-00155d0a2516',
        @FkGUID=N'a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

4. 删除还款分摊明细

   ```
   DELETE FROM cb_LoanReturn_FtDetail WHERE LoanReturnGUID='a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

5. 新增还款分摊明细

   ```
   INSERT INTO cb_LoanReturn_FtDetail (LoanReturnFtGUID, LoanReturnGUID, LoanGUID, DeptGUID, CostGUID, LoanFtDetailGUID,
                                       LoanReturnFtAmount, RepaidAmount)
   values ('ea67748d-e539-eb11-a55a-00155d0a2516', 'a1bba97f-e539-eb11-a55a-00155d0a2516',
           'c16176f2-66e7-4a91-ac36-3c5dd6e880ce', 'f2876a7e-7ade-11ea-8b09-00155d0a1c30',
           'b51b57f7-7744-e911-aadb-00155d0a1c3e', '21806a07-cf39-eb11-a55a-00155d0a2516', '1000', '0')
   ```

   

#### 1.7.4.3 修改加载

1. 获取还款信息

   ```
   SELECT LoanReturnGUID,
          LoanGUID,
          ReturnedGUID,
          ApproveState,
          ReturnCode,
          ReturnedBy,
          ReturnDate,
          ReturnAmount,
          PayMode,
          Remarks,
          FKDJApproveState,
          PaymentUnit,
          PaymentUnitGUID,
          BankName
   FROM cb_LoanReturn
   WHERE (LoanReturnGUID = 'a1bba97f-e539-eb11-a55a-00155d0a2516')
   ```

   

2. 借款科目分摊信息

   ```
   SELECT LF.FtDetailGUID,
          LF.LoanGUID,
          LF.DeptGUID,
          LF.DeptName,
          LF.CostGUID,
          LF.CostCode,
          LF.CostShortName,
          LF.FtAmount,
          ISNULL(LF.BalanceAmount,0)       AS                                                 BalanceAmount,
          CASE WHEN TLF.RepaidAmount IS NULL THEN ISNULL(LRF.LoanReturnFtAmount,0)
               ELSE ISNULL(TLF.RepaidAmount,0) END                                            RepaidAmount,
          ISNULL(TLF.LoanReturnFtAmount,0) AS                                                 ThisLoanReturnFtAmount,
          TLF.LoanReturnFtGUID,
          CASE WHEN TLF.RepaidAmount IS NULL THEN LF.FtAmount - ISNULL(LF.BalanceAmount,0) -
                                                  ISNULL(LRF.LoanReturnFtAmount,0)
               ELSE LF.FtAmount - ISNULL(LF.BalanceAmount,0) - ISNULL(TLF.RepaidAmount,0) END LoanAmountB,
          CASE WHEN TLF.RepaidAmount IS NULL THEN ISNULL(
                      LF.FtAmount - ISNULL(LF.BalanceAmount,0) - ISNULL(LRF.LoanReturnFtAmount,0) -
                      ISNULL(TLF.LoanReturnFtAmount,0),0)
               ELSE ISNULL(LF.FtAmount - ISNULL(LF.BalanceAmount,0) - ISNULL(TLF.RepaidAmount,0) -
                           ISNULL(TLF.LoanReturnFtAmount,0),0) END                            LoanAmountC
   FROM (SELECT CASE WHEN FtDetailGUID IS NULL THEN '00000000-0000-0000-0000-000000000000'
                     ELSE FtDetailGUID END                                                               FtDetailGUID,
                a.LoanGUID,
                CASE WHEN DeptGUID IS NULL THEN '00000000-0000-0000-0000-000000000000' ELSE DeptGUID END DeptGUID,
                DeptName,
                CASE WHEN CostGUID IS NULL THEN '00000000-0000-0000-0000-000000000000' ELSE CostGUID END CostGUID,
                CostCode,
                CostShortName,
                CASE WHEN SUM(ISNULL(B.FtAmount,0)) = 0 THEN SUM(A.LoanAmount) ELSE SUM(B.FtAmount) END  FtAmount,
                (select SUM(a.BalanceAmount)
                 from (select SUM(a.CorrespondingAmount) BalanceAmount
                       from cb_Expense_FluentDetails a
                                left join cb_Expense c on a.BusinessGUID = c.ExpenseGUID
                       where a.LoanFtDetailGUID = b.FtDetailGUID
                         and c.ApplyState != '未审核'
                       union all
                       select SUM(CurBalanceAmount_Bz) BalanceAmount
                       from cb_LoanBalanceApply      n
                                left join cb_Expense m on n.RefGUID = m.ExpenseGUID
                       where LoanGUID = a.LoanGUID
                         and m.ApplyState != '未审核') a) AS                                                BalanceAmount
         FROM cb_Loan                        a
                  left join cb_Loan_FtDetail b on a.LoanGUID = b.LoanGUID
         WHERE a.LoanGUID = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce'
         GROUP BY FtDetailGUID, a.LoanGUID, DeptGUID, DeptName, CostGUID, CostCode, CostShortName) LF
            LEFT JOIN (SELECT LoanFtDetailGUID,
                              a.LoanGUID,
                              DeptGUID,
                              CostGUID,
                              SUM(LoanReturnFtAmount) AS LoanReturnFtAmount
                       FROM cb_LoanReturn_FtDetail       a
                                inner join cb_LoanReturn b on a.LoanReturnGUID = b.LoanReturnGUID
                       WHERE b.ApproveState in ('审核中', '已审核')
                         and a.LoanReturnGUID <> 'a1bba97f-e539-eb11-a55a-00155d0a2516'
                         and a.LoanGUID = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce'
                       GROUP BY LoanFtDetailGUID, a.LoanGUID, DeptGUID, CostGUID)                  LRF
                      ON LF.LoanGUID = LRF.LoanGUID AND LF.DeptGUID = LRF.DeptGUID AND LF.CostGUID = LRF.CostGUID AND
                         LF.FtDetailGUID = LRF.LoanFtDetailGUID
            LEFT JOIN cb_LoanReturn_FtDetail                                                       TLF
                      ON TLF.LoanGUID = LF.LoanGUID AND TLF.DeptGUID = LF.DeptGUID AND TLF.CostGUID = LF.CostGUID AND
                         LoanReturnGUID = 'a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

3. 还款冲账明细

   ```
   SELECT TOP 20 *
   FROM vcb_LoanBalanceAndLoanReturn
   WHERE (LoanGUID = 'c16176f2-66e7-4a91-ac36-3c5dd6e880ce')
   ORDER BY case when RefType = '直接还款' then 0 when RefType = '日常报销' then 1 else 2 end, OccurDate DESC
          , vcb_LoanBalanceAndLoanReturn.LoanBalanceApplyGUID
   ```

   

#### 1.7.4.4 修改保存

1. 更新还款信息   

   ```
   UPDATE cb_LoanReturn
   SET LoanGUID='c16176f2-66e7-4a91-ac36-3c5dd6e880ce',
       ReturnedGUID='4230bc6e-69e6-46a9-a39e-b929a06a84e8',
       ApproveState=N'未审核',
       FKDJApproveState='未审核',
       PaymentUnitGUID='488f2fb9-2e72-e911-b398-00155d0a1c30',
       ReturnCode='HK2020120001',
       ReturnedBy='订单系统',
       ReturnDate='2020-12-09',
       ReturnAmount=1000.00,
       PayMode='现金',
       PaymentUnit='测试分类001',
       BankName='',
       Remarks=''
   WHERE LoanReturnGUID = 'a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

2. 删除还款科目分摊明细

   ```
   DELETE FROM cb_LoanReturn_FtDetail WHERE LoanReturnGUID='a1bba97f-e539-eb11-a55a-00155d0a2516'
   ```

   

3. 新增还款科目分摊明细

   ```
   INSERT INTO cb_LoanReturn_FtDetail (LoanReturnFtGUID, LoanReturnGUID, LoanGUID, DeptGUID, CostGUID, LoanFtDetailGUID,
                                       LoanReturnFtAmount, RepaidAmount)
   values ('9a223e47-e739-eb11-a55a-00155d0a2516', 'a1bba97f-e539-eb11-a55a-00155d0a2516',
           'c16176f2-66e7-4a91-ac36-3c5dd6e880ce', 'f2876a7e-7ade-11ea-8b09-00155d0a1c30',
           'b51b57f7-7744-e911-aadb-00155d0a1c3e', '21806a07-cf39-eb11-a55a-00155d0a2516', '1000', '0')
   ```

#### 1.7.4.5 提交审批

1. 对冲借款分摊金额

   ```
   exec sp_executesql N'UPDATE  cb_Loan_FtDetail
                                       SET     BalanceAmount = ISNULL(A.BalanceAmount, 0) + ISNULL(LoanReturnFtAmount,0)
                                       FROM    cb_Loan_FtDetail A
                                               LEFT JOIN cb_LoanReturn_FtDetail B ON A.FtDetailGUID = B.LoanFtDetailGUID
                                       WHERE   B.LoanReturnFtGUID = @LoanReturnFtGUID',N'@LoanReturnFtGUID uniqueidentifier',@LoanReturnFtGUID='30C0BBDF-E739-EB11-A55A-00155D0A2516'
   ```

   

2. 对冲借款信息

   ```
   exec sp_executesql N'UPDATE  A
                                       SET     A.BalanceAmount = ISNULL(BalanceAmount,0) + ISNULL(B.LoanReturnFtAmount,0),
                                               A.BalanceAmount_Bz = ISNULL(BalanceAmount_Bz,0) + ISNULL(B.LoanReturnFtAmount,0)
                                       FROM dbo.cb_Loan A
                                       OUTER APPLY( SELECT  SUM(ISNULL(LoanReturnFtAmount,0)) AS LoanReturnFtAmount
                                                    FROM    cb_LoanReturn_FtDetail
                                                    WHERE   LoanGUID = A.LoanGUID AND LoanReturnFtGUID = @LoanReturnFtGUID
                                                   ) B
                                       WHERE   A.LoanGUID IN(SELECT LoanGUID FROM cb_LoanReturn_FtDetail WHERE LoanReturnFtGUID = @LoanReturnFtGUID)',N'@LoanReturnFtGUID uniqueidentifier',@LoanReturnFtGUID='30C0BBDF-E739-EB11-A55A-00155D0A2516'
   ```

   

3. 更新事项年度预算表和部门年度预算表

   ```
   UPDATE ys_YearPlanProceeding2Cost
   SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 1000.0000,
       FactAmount12     = ISNULL(FactAmount12,0) - 1000.0000,
       PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) - 1000.0000
   WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND ProceedingGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND Year = 2020
     AND CostGUID IN
         (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
   
   UPDATE ys_YearPlanDept2Cost
   SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) - 1000.0000,
       FactAmount12     = ISNULL(FactAmount12,0) - 1000.0000,
       PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) - 1000.0000
   WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND Year = 2020
     AND CostGUID IN
         (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
               
   ```

   

4. 更新借款信息

   ```
   exec sp_executesql N'UPDATE  a
                           SET     a.BalanceAmount_Bz = b.SumCurBalanceAmount,
                                   a.RemainAmount_Bz = a.LoanAmount_Bz - b.SumCurBalanceAmount
                           FROM    cb_Loan a
                                   OUTER APPLY(SELECT    ISNULL(SUM(CurBalanceAmount_Bz), 0) AS SumCurBalanceAmount
                                                 FROM      vcb_LoanBalanceAndLoanReturn
                                                 WHERE     RefType IN(''日常报销'', ''合同付款申请'', ''直接还款'')
                                                           AND ApplyState IN(''已审核'', ''审核中'', '''')
                                                           AND LoanGUID = a.LoanGUID
                                               ) b
                           WHERE   LoanGUID = @LoanGUID;
                           UPDATE cb_Loan SET BalanceAmount = BalanceAmount_Bz * Rate, RemainAmount = RemainAmount_Bz * Rate WHERE LoanGUID = @LoanGUID;
                           UPDATE cb_Loan set ApplyState = (case when RemainAmount_Bz = 0 then ''冲账已完成'' when BalanceAmount_Bz> 0 then ''冲账未完成'' else ''已审核'' end) WHERE LoanGUID = @LoanGUID;',N'@LoanGUID uniqueidentifier',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

   

#### 1.7.4.4 审批通过

1. 更新还款信息

   ```
   exec sp_executesql
        N'update [cb_LoanReturn] set  [LoanGUID] = @LoanGUID ,  [ReturnCode] = @ReturnCode ,  [ReturnedBy] = @ReturnedBy ,  [ReturnDate] = @ReturnDate ,  [ReturnAmount] = @ReturnAmount ,  [Remarks] = @Remarks ,  [PayMode] = @PayMode ,  [IsGenerateFail] = @IsGenerateFail ,  [ReturnedGUID] = @ReturnedGUID ,  [ApproveState] = @ApproveState ,  [ApproveDate] = @ApproveDate ,  [ApproveBy] = @ApproveBy where  [LoanReturnGUID] = @LoanReturnGUID',
        N'@LoanGUID uniqueidentifier,@ReturnCode nvarchar(12),@ReturnedBy nvarchar(4),@ReturnDate datetime,@ReturnAmount decimal(8,4),@Remarks nvarchar(4000),@PayMode nvarchar(2),@IsGenerateFail tinyint,@ReturnedGUID uniqueidentifier,@ApproveState nvarchar(3),@ApproveDate datetime,@ApproveBy uniqueidentifier,@LoanReturnGUID uniqueidentifier',
        @LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE',@ReturnCode=N'HK2020120001',@ReturnedBy=N'订单系统',
        @ReturnDate='2020-12-09 00:00:00',@ReturnAmount=1000.0000,@Remarks=N'',@PayMode=N'现金',@IsGenerateFail=0,
        @ReturnedGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@ApproveState=N'已审核',@ApproveDate='2020-12-09 14:41:21.330',
        @ApproveBy='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@LoanReturnGUID='A1BBA97F-E539-EB11-A55A-00155D0A2516'
   ```

   

#### 1.7.4.5 审批驳回

1. 更新还款基础信息

   ```
   exec sp_executesql
        N'update [cb_LoanReturn] set  [LoanGUID] = @LoanGUID ,  [ReturnCode] = @ReturnCode ,  [ReturnedBy] = @ReturnedBy ,  [ReturnDate] = @ReturnDate ,  [ReturnAmount] = @ReturnAmount ,  [Remarks] = @Remarks ,  [PayMode] = @PayMode ,  [IsGenerateFail] = @IsGenerateFail ,  [ReturnedGUID] = @ReturnedGUID ,  [ApproveState] = @ApproveState where  [LoanReturnGUID] = @LoanReturnGUID',
        N'@LoanGUID uniqueidentifier,@ReturnCode nvarchar(12),@ReturnedBy nvarchar(4),@ReturnDate datetime,@ReturnAmount decimal(8,4),@Remarks nvarchar(4000),@PayMode nvarchar(2),@IsGenerateFail tinyint,@ReturnedGUID uniqueidentifier,@ApproveState nvarchar(3),@LoanReturnGUID uniqueidentifier',
        @LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE',@ReturnCode=N'HK2020120001',@ReturnedBy=N'订单系统',
        @ReturnDate='2020-12-09 00:00:00',@ReturnAmount=1000.0000,@Remarks=N'',@PayMode=N'现金',@IsGenerateFail=0,
        @ReturnedGUID='4230BC6E-69E6-46A9-A39E-B929A06A84E8',@ApproveState=N'未审核',@LoanReturnGUID='A1BBA97F-E539-EB11-A55A-00155D0A2516'
   ```

   

2. 更新还款分摊明细

   ```
   exec sp_executesql N'UPDATE  cb_Loan_FtDetail
                                       SET     BalanceAmount = ISNULL(A.BalanceAmount, 0) - ISNULL(LoanReturnFtAmount,0)
                                       FROM    cb_Loan_FtDetail A
                                               LEFT JOIN cb_LoanReturn_FtDetail B ON A.FtDetailGUID = B.LoanFtDetailGUID
                                       WHERE   B.LoanReturnFtGUID = @LoanReturnFtGUID',
        N'@LoanReturnFtGUID uniqueidentifier',@LoanReturnFtGUID='30C0BBDF-E739-EB11-A55A-00155D0A2516'
   ```

   

3. 更新还款金额信息

   ```
   exec sp_executesql N'UPDATE  A
                                       SET     A.BalanceAmount = ISNULL(BalanceAmount,0) - ISNULL(B.LoanReturnFtAmount,0),
                                               A.BalanceAmount_Bz = ISNULL(BalanceAmount_Bz,0) - ISNULL(B.LoanReturnFtAmount,0)
                                       FROM dbo.cb_Loan A
                                       OUTER APPLY( SELECT  SUM(ISNULL(LoanReturnFtAmount,0)) AS LoanReturnFtAmount
                                                    FROM    cb_LoanReturn_FtDetail
                                                    WHERE   LoanGUID = A.LoanGUID AND LoanReturnFtGUID = @LoanReturnFtGUID
                                                   ) B
                                       WHERE   A.LoanGUID IN(SELECT LoanGUID FROM cb_LoanReturn_FtDetail WHERE LoanReturnFtGUID = @LoanReturnFtGUID)',N'@LoanReturnFtGUID uniqueidentifier',@LoanReturnFtGUID='30C0BBDF-E739-EB11-A55A-00155D0A2516'
   ```

   

4. 更新事项年度预算表和部门年度预算表

   ```
   UPDATE ys_YearPlanProceeding2Cost
   SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 1000.0000,
       FactAmount12     = ISNULL(FactAmount12,0) + 1000.0000,
       PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) + 1000.0000
   WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND ProceedingGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND Year = 2020
     AND CostGUID IN
         (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
   
   UPDATE ys_YearPlanDept2Cost
   SET OccupiedAmount12 = ISNULL(OccupiedAmount12,0) + 1000.0000,
       FactAmount12     = ISNULL(FactAmount12,0) + 1000.0000,
       PayYsYfsAmount12 = ISNULL(PayYsYfsAmount12,0) + 1000.0000
   WHERE DeptGUID = 'f2876a7e-7ade-11ea-8b09-00155d0a1c30'
     AND Year = 2020
     AND CostGUID IN
         (select CostGUID from ys_EndCost2Cost where EndCostGUID = 'b51b57f7-7744-e911-aadb-00155d0a1c3e' AND Year = 2020);
               
   ```

   

5. 更新还款信息

   ```
   exec sp_executesql N'UPDATE  a
                           SET     a.BalanceAmount_Bz = b.SumCurBalanceAmount,
                                   a.RemainAmount_Bz = a.LoanAmount_Bz - b.SumCurBalanceAmount
                           FROM    cb_Loan a
                                   OUTER APPLY(SELECT    ISNULL(SUM(CurBalanceAmount_Bz), 0) AS SumCurBalanceAmount
                                                 FROM      vcb_LoanBalanceAndLoanReturn
                                                 WHERE     RefType IN(''日常报销'', ''合同付款申请'', ''直接还款'')
                                                           AND ApplyState IN(''已审核'', ''审核中'', '''')
                                                           AND LoanGUID = a.LoanGUID
                                               ) b
                           WHERE   LoanGUID = @LoanGUID;
                           UPDATE cb_Loan SET BalanceAmount = BalanceAmount_Bz * Rate, RemainAmount = RemainAmount_Bz * Rate WHERE LoanGUID = @LoanGUID;
                           UPDATE cb_Loan set ApplyState = (case when RemainAmount_Bz = 0 then ''冲账已完成'' when BalanceAmount_Bz> 0 then ''冲账未完成'' else ''已审核'' end) WHERE LoanGUID = @LoanGUID;',N'@LoanGUID uniqueidentifier',@LoanGUID='C16176F2-66E7-4A91-AC36-3C5DD6E880CE'
   ```

   

### 1.7.9 薪酬管理

#### 1.7.9.1 列表查询

```
SELECT TOP 20 fy_Emolument.EmolumentGUID,
              fy_Emolument.ApproveState,
              fy_Emolument.EmolumentCode,
              fy_Emolument.EmolumentName,
              fy_Emolument.EmolumentAmount,
              fy_Emolument.jbDate,
              fy_Emolument.jbrName,
              b.BUName,
              myWorkflowProcessEntity.ProcessGUID
FROM dbo.fy_Emolument
         left join dbo.myBusinessUnit b on fy_Emolument.DeptGUID = b.BUGUID
         left join myWorkflowProcessEntity ON fy_Emolument.EmolumentGUID = myWorkflowProcessEntity.BusinessGUID AND
                                              myWorkflowProcessEntity.IsHistory = 0
WHERE ((1 = 1 AND (1 = 1)))
  AND ((HierarchyCode = 'zb.1.22' or HierarchyCode like 'zb.1.22.%'))
  AND (fy_Emolument.BUGUID = '38da7886-bc9e-4431-b065-1c02ec79f80f')
ORDER BY fy_Emolument.EmolumentCode DESC, fy_Emolument.EmolumentGUID
```



#### 1.7.9.2 新增-保存

1. 插入薪酬主数据

   ```
   INSERT INTO dbo.fy_Emolument(EmolumentGUID, EmolumentCode, EmolumentName, EmolumentAmount, jbrGUID, jbrName, DeptGUID,
                                jbDate, ApproveState, Year, Month, Remark, PayState, BUGUID, CurrencyGUID)
   VALUES ('1e484c73-160d-4e07-8b8f-c638ce4eed40', 'XC2020120058', 'liuwz薪酬单1214002', 100.00,
           '4230bc6e-69e6-46a9-a39e-b929a06a84e8', '订单系统', 'e777fc1b-f828-42b0-8888-25f6cee41c2b', '2020/12/14 0:00:00',
           '未审核', '2020', '12', '', '未支付', '38da7886-bc9e-4431-b065-1c02ec79f80f', 'f1ae9c30-fe32-4844-a772-23a9bb044d08');
   ```

   

2. 插入薪酬明细数据

   ```
   INSERT INTO dbo.fy_EmolumentDtl(EmolumentDtlGUID, EmolumentGUID, OccurDate, ExpenseDtlName, Brief, InvoiceType, Amount,
                                   IsCanDeductible, TaxRate, InputTaxAmount, ExcludingTaxApplyAmount,
                                   AccountingSubjectGUID, AccountingSubject, PaymentName, PaymentGUID, PayState)
   VALUES ('89e82f8a-670b-484a-b977-5c041ec2f38f', '1e484c73-160d-4e07-8b8f-c638ce4eed40', '2020/12/1 0:00:00', '日常报销-交通',
           'xx', '增值税专用发票', 100.00, 1, '3%', 2.91, 97.09, 'a3f11f76-98f8-e811-aad4-00155d0a1c3e', '差旅费',
           (SELECT top 1 ProviderName FROM dbo.p_Provider WHERE ProviderGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'),
           '7bf41540-fde6-e811-aacb-00155d0a1c3e', '未支付');
   ```

   

3. 插入薪酬明细科目分摊数据

   ```
   INSERT INTO dbo.ys_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID,
                                     CostGUID, ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month,
                                     CostFlag, EntryCostGUID, EntryCostName, EntryCostCode, LoanFtDetailGUIDList,
                                     CorrespondingAmountList, CorrespondingAmount, LoanBalance, FluentLoanGUID,
                                     PaymentName, PaymentGUID, BudgetName, BudgetGUID)
   VALUES ('e5edd413-a00c-46c0-9878-dfa7074cc542', '薪酬发放', '1e484c73-160d-4e07-8b8f-c638ce4eed40', NULL,
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', 'b51b57f7-7744-e911-aadb-00155d0a1c3e', NULL, '',
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', '2020年-营销全成本-测试项目-六期', '100', '100', 2020, 12, 0,
           'b51b57f7-7744-e911-aadb-00155d0a1c3e', '管理科目-办公费', 'C.01.01', NULL, NULL, NULL, NULL, NULL,
           (SELECT top 1 ProviderName FROM dbo.p_Provider WHERE ProviderGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'),
           '7bf41540-fde6-e811-aacb-00155d0a1c3e', '987654', 'b029d30b-b0f3-e811-aad4-00155d0a1c3e');
   ```

   

#### 1.7.9.3 修改-加载

1. 获取薪酬主信息

   ```
   SELECT fy_Emolument.EmolumentGUID,
          fy_Emolument.ApproveState,
          fy_Emolument.EmolumentCode,
          fy_Emolument.DeptGUID,
          fy_Emolument.Year,
          fy_Emolument.Month,
          fy_Emolument.Remark,
          fy_Emolument.EmolumentName,
          fy_Emolument.EmolumentAmount,
          fy_Emolument.jbDate,
          fy_Emolument.jbrName,
          fy_Emolument.jbrGUID,
          b.BUName DeptName,
          fy_Emolument.BUGUID,
          myWorkflowProcessEntity.ProcessGUID
   FROM dbo.fy_Emolument
            left join dbo.myBusinessUnit b on fy_Emolument.DeptGUID = b.BUGUID
            left join myWorkflowProcessEntity ON fy_Emolument.EmolumentGUID = myWorkflowProcessEntity.BusinessGUID AND
                                                 myWorkflowProcessEntity.IsHistory = 0
   WHERE (EmolumentGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586')
     AND (2 = 2)
                       
   ```

   

2. 获取薪酬单明细信息

   ```
   SELECT ROW_NUMBER() OVER (ORDER BY dbo.fy_EmolumentDtl.EmolumentGUID ASC) AS rowid,
          Convert(varchar(10),OccurDate,121)                                 AS OccurDate,
          EmolumentDtlGUID,
          Brief,
          InvoiceType,
          IsCanDeductible,
          TaxRate                                                            AS TaxType,
          InputTaxAmount,
          ExcludingTaxApplyAmount,
          AccountingSubjectGUID,
          AccountingSubject,
          PaymentName,
          PaymentGUID,
          ExpenseDtlName,
          Amount
   FROM dbo.fy_EmolumentDtl
   WHERE EmolumentGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ORDER BY OccurDate; 
   ```

   

3. 查询薪酬明细关联日常报销信息

   ```
   select ii.InvoiceItemGUID,
          ii.ContractGUID,
          ii.BUGUID,
          ii.ReceiveProviderGUID,
          ii.ReceiveUnitName,
          ii.PayProviderGUID,
          ii.PayProviderName,
          ii.VouchType,
          ii.Invotype,
          ii.InvoNO,
          ii.FundType,
          ii.FundName,
          ii.YwType,
          ii.InvoiceAmount,
          ii.PrevVoucherBalance,
          ii.AfterVoucherBalance,
          ii.Jbr,
          ii.JbDate,
          ii.ApproveState,
          ii.Shr,
          ii.ShDate,
          ii.IsEnterVoucher,
          ii.FinanceRegisterDate,
          ii.FinanceExportDate,
          ii.IsGenerateFail,
          ii.FailReason,
          ii.InvoiceType,
          ii.InputTaxAmount,
          ii.ExcludingTaxInvoiceAmount,
          ii.InvoiceDate,
          ii.RefGUID,
          ii.Code,
          ii.BuyerCompanyBankNNum,
          ii.SellerCompanyBankNNum
   from cb_InvoiceItem              ii
            left join cb_ExpenseDtl dtl on dtl.ExpenseDtlGUID = ii.RefGUID
   where ii.RefGUID = 'c0e298f1-37fe-45ac-adf9-950230542902'
   ```

   

4. 加载费用预算使用明细信息

   ```
   SELECT DeptCostUseDtlGUID,
          a.DeptGuid,
          BusinessGuid,
          CostGUID,
          EntryCostCode,
          EntryCostName,
          DeptName,
          ProceedingGUID,
          EntryCostName,
          FtAmount,
          PaymentName,
          PaymentGUID,
          b.text AS Sxmc,
          BudgetName,
          BudgetGUID
   FROM ys_DeptCostUseDtl                                                                                            a
            LEFT JOIN (Select distinct value, [text], [Order], DeptGUID from vys_GetProceeding where IsDisabled = 0) b
                      ON a.DeptGUID = b.DeptGUID AND a.ProceedingGUID = b.value
   WHERE 1 = 1
     AND BusinessGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586';
   ```

   

5. 薪酬文档信息

   ```
   SELECT DocName,
          Replace(Location,'\','/') + FileName                                                                FileName,
          Url,
          UserName,
          CASE WHEN CreateOn IS NOT NULL AND CreateOn <> '' THEN CONVERT(char(20),CreateOn,20) ELSE '' END AS CreateOn
   FROM ep_Documents
   WHERE FkGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
     and DocType = '薪酬发放'
   ORDER BY CreateOn DESC
   ```

   

#### 1.7.9.4 修改-保存

1. 更新薪酬主信息

   ```
   UPDATE dbo.fy_Emolument
   set EmolumentCode   = 'XC2020120056',
       EmolumentName   = 'liuwz薪酬单1214001',
       EmolumentAmount = '1100.00',
       jbDate          = '2020/12/14 0:00:00',
       Year            = '2020',
       Month           = '12',
       Remark          = 'xxxxxxxx'
   WHERE EmolumentGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586';
   ```

   

2. 删除薪酬单明细信息

   ```
   DELETE fy_EmolumentDtl
   WHERE EmolumentGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586';
   ```

   

3. 删除费用预算使用明细信息

   ```
   DELETE ys_DeptCostUseDtl
   WHERE BusinessGUID = 'd47912e8-0e77-4b23-9bcb-aadda3ab5586';
   ```

   

4. 重新插入薪酬明细信息

   ```
   INSERT INTO dbo.fy_EmolumentDtl(EmolumentDtlGUID, EmolumentGUID, OccurDate, ExpenseDtlName, Brief, InvoiceType, Amount,
                                   IsCanDeductible, TaxRate, InputTaxAmount, ExcludingTaxApplyAmount,
                                   AccountingSubjectGUID, AccountingSubject, PaymentName, PaymentGUID, PayState)
   VALUES ('365e6a39-aa2b-4ff3-89e3-101ef6f5fad5', 'd47912e8-0e77-4b23-9bcb-aadda3ab5586', '2020/12/1 0:00:00', '节日福利',
           'xxxx', '增值税专用发票', 1100.00, 0, '3%', 32.04, 1067.96, 'a2f11f76-98f8-e811-aad4-00155d0a1c3e', '办公费',
           (SELECT top 1 ProviderName FROM dbo.p_Provider WHERE ProviderGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'),
           '7bf41540-fde6-e811-aacb-00155d0a1c3e', '未支付');
   ```

   

5. 重新插入费用预算使用明细

   ```
   INSERT INTO dbo.ys_DeptCostUseDtl(DeptCostUseDtlGUID, BusinessType, BusinessGUID, ContractGUID, ProceedingGUID,
                                     CostGUID, ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, Year, Month,
                                     CostFlag, EntryCostGUID, EntryCostName, EntryCostCode, LoanFtDetailGUIDList,
                                     CorrespondingAmountList, CorrespondingAmount, LoanBalance, FluentLoanGUID,
                                     PaymentName, PaymentGUID, BudgetName, BudgetGUID)
   VALUES ('a22cfcb0-8f79-46e4-8e68-e395abdede4a', '薪酬发放', 'd47912e8-0e77-4b23-9bcb-aadda3ab5586', NULL,
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', 'b51b57f7-7744-e911-aadb-00155d0a1c3e', NULL, '',
           'fb489ba6-7ade-11ea-8b09-00155d0a1c30', '2020年-营销全成本-测试项目-六期', '1100', '1100', 2020, 12, 0,
           'b51b57f7-7744-e911-aadb-00155d0a1c3e', '管理科目-办公费', 'C.01.01', NULL, NULL, NULL, NULL, NULL,
           (SELECT top 1 ProviderName FROM dbo.p_Provider WHERE ProviderGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'),
           '7bf41540-fde6-e811-aacb-00155d0a1c3e', '987654', 'b029d30b-b0f3-e811-aad4-00155d0a1c3e');
   ```

   

#### 1.7.9.5 提交审批

1. usp_fy_ValidWarnControl

   ```
   exec usp_fy_ValidWarnControl @BusinessGUID='D47912E8-0E77-4B23-9BCB-AADDA3AB5586',@xmldoc=N'',@IsSendMsg=0,
        @RefType=N'薪酬发放',@BlRelatedApplyGuid=N''
   ```

   

2. 获取 费用预警强控错误信息表

   ```
   exec sp_executesql
        N'SELECT COUNT(1) FROM ys_DeptWarnControlErrorInfo WHERE ErrorType=''强控'' AND BusinessGUID=@BusinessGUID',
        N'@BusinessGUID uniqueidentifier',@BusinessGUID='D47912E8-0E77-4B23-9BCB-AADDA3AB5586'
   ```

   

3. usp_Ys_DoDeptCostUseDtl

   ```
   exec usp_Ys_DoDeptCostUseDtl @BusinessGUID= 'd47912e8-0e77-4b23-9bcb-aadda3ab5586',@BusinessType='XCFF',@Type='PASS',
        @Flag='XCFF';
   ```

   + 更新占用金额为分摊金额

     ```
     -- 审核通过
     SET @Operater = '+'
     UPDATE ys_DeptCostUseDtl SET UsedAmount = FtAmount WHERE BusinessGUID = @BusinessGUID
     ```

     ```
     -- 审核不通过
     SET @Operater = '-'
     UPDATE ys_DeptCostUseDtl SET UsedAmount = 0 WHERE BusinessGUID = @BusinessGUID
     ```

   + 将当前薪酬单分摊信息写入临时表中

     ```
     INSERT INTO #MyTemp_Data_FYYS_Proceed (ProceedingGUID, DeptCostGUID, DeptGUID, FtAmount, Year)
     SELECT ProceedingGUID, CostGUID, DeptGUID, FtAmount, b.Year
     FROM ys_DeptCostUseDtl         a
              LEFT JOIN ys_DeptCost b ON b.DeptCostGUID = a.CostGUID
     WHERE BusinessGUID = @BusinessGUID
     ```

     

   + 获取当前单据发生时间

     ```
     SELECT @ApplyYear = fy_Emolument.Year, @Month = fy_Emolument.Month
             FROM fy_Emolument
             WHERE EmolumentGUID = @BusinessGUID
     ```

   + 循环每一条分摊明细数据

     ```
     While @intRow <= @intCount Begin
             SELECT @DeptCostGUID = DeptCostGUID,
                    @ProceedingGUID = ProceedingGUID,
                    @Year = year,
                    @DeptGUID = DeptGUID,
                    @FtAmount = FtAmount
             FROM #MyTemp_Data_FYYS_Proceed
             WHERE ID = @intRow
     ```

   + 设置分摊金额

     ```
     SET @FtAmount = cast(@Operater + CONVERT(varchar(30),@FtAmount) as money)
     ```

   + 执行 usp_Ys_UpdateYearPlanCost 开始同步科目

     ```
     EXEC usp_Ys_UpdateYearPlanCost '已发生',@DeptGUID,@ProceedingGUID,@DeptCostGUID,@Year,@Month1,@FtAmount
     ```

     ```
     IF @Type = '预算'
     	Set @UpdateFieldName = 'PlanAmount'
     ELSE IF @Type = '调整'
         Set @UpdateFieldName = 'AdjustAmount'
     ELSE IF @Type = '已发生'
         Set @UpdateFieldName = 'FactAmount'
     ELSE IF @Type = '已支付'
     
     --3. 更新事项科目的金额(科目关系表包含有末级和非末级科目)
         SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                       CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                       ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' +
                       CONVERT(varchar(4),@Year) +
                       ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                       CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
         EXECUTE (@strSQL)
         --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
         SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                        CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                        ''' AND Year=' + CONVERT(varchar(4),@Year) +
                        ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                        CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
         EXECUTE (@strSQL1)
     ```

     

   + 执行

     ```
     EXEC usp_Ys_UpdateYearPlanCostByPay '已发生',@DeptGUID,@ProceedingGUID,@DeptCostGUID,@Year,@Month1,
     ```

     ```
     IF @Type = '预算' 
     	Set @UpdateFieldName = 'PayYsAmount'  
     ELSE IF @Type = '调整' 
     	Set @UpdateFieldName = 'PayYsAdjAmount'  
     ELSE IF @Type = '已发生' 
     	Set @UpdateFieldName = 'PayYsYfsAmount' 
     ELSE IF @Type = '已支付' 
     	Set @UpdateFieldName = 'PayYsZtAmount' 
     
     --3. 更新事项科目的金额(科目关系表包含有末级和非末级科目)
         SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' + CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) + ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' + CONVERT(varchar(4),@Year) + ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' + CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
         EXECUTE (@strSQL)
     --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
         SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' + CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) + ''' AND Year=' + CONVERT(varchar(4),@Year) + ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' + CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'   
         EXECUTE (@strSQL1)
     ```

     

4. usp_Ys_InDeptCostUsedInfoForSH 

   ```
   exec usp_Ys_InDeptCostUsedInfoForSH @BusinessGUID= 'd47912e8-0e77-4b23-9bcb-aadda3ab5586',@BusinessType='XCFF',
        @Type='PASS';
   ```

   + 删除分摊费项实际使用审核信息

     ```
     DELETE
     FROM ys_DeptCostUsedInfoForSH
     WHERE BusinessGUID = @BusinessGUID 
     ```

   + 将部门费用分摊信息插入到临时表中

     ```
                     INSERT INTO #ys_DeptCostUseDtl (DeptCostUseDtlGUID, BusinessType, BusinessGUID, ProceedingGUID,
                                                     CostGUID,
                                                     CostShortName, IsYsControl, ControlCycle, ControlRule,
                                                     ControlCostShortName,
                                                     ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, CostFlag,
                                                     ProceedingName, year, Month)
                     SELECT DeptCostUseDtlGUID,
                            BusinessType,
                            BusinessGUID,
                            a.ProceedingGUID,
                            a.CostGUID,
                            c.CostShortName,
                            CASE WHEN c.IsYsControl = 1 THEN '是' ELSE '否' END,
                            c.ControlCycle,
                            c.ControlRule,
                            (SELECT TOP 1 costShortName
                             FROM ys_deptcost
                             WHERE DeptCostGUID IN (SELECT costguid FROM ys_EndCost2Cost WHERE EndCostGUID = a.CostGUID)
                             ORDER BY CostLevel DESC)                                                     AS ControlCostShortName,
                            ZrrGUID,
                            ZrrName,
                            a.DeptGUID,
                            DeptName,
                            FtAmount,
                            UsedAmount,
                            CostFlag,
                            case when a.ProceedingGUID = a.DeptGUID then '日常费用' else b.ProceedingName end as ProceedingName,
                            CASE WHEN c.Year < a.Year THEN c.Year ELSE a.Year END                         AS year,
                            CASE WHEN c.Year < a.Year THEN 12 ELSE a.Month END                            AS Month
                     FROM ys_DeptCostUseDtl            a
                              inner JOIN ys_Proceeding b
                                         ON b.ProceedingGUID = a.ProceedingGUID AND a.BusinessGUID = @BusinessGUID
                              INNER JOIN ys_DeptCost   c ON c.DeptCostGUID = a.CostGUID
     
                     --日常费用事项表中无事项，需要特殊处理
                     INSERT INTO #ys_DeptCostUseDtl (DeptCostUseDtlGUID, BusinessType, BusinessGUID, ProceedingGUID,
                                                     CostGUID,
                                                     CostShortName, IsYsControl, ControlCycle, ControlRule,
                                                     ControlCostShortName,
                                                     ZrrGUID, ZrrName, DeptGUID, DeptName, FtAmount, UsedAmount, CostFlag,
                                                     ProceedingName, year, Month)
                     SELECT DeptCostUseDtlGUID,
                            BusinessType,
                            BusinessGUID,
                            a.ProceedingGUID,
                            a.CostGUID,
                            c.CostShortName,
                            CASE WHEN c.IsYsControl = 1 THEN '是' ELSE '否' END,
                            c.ControlCycle,
                            c.ControlRule,
                            (SELECT TOP 1 costShortName
                             FROM ys_deptcost
                             WHERE DeptCostGUID IN (SELECT costguid FROM ys_EndCost2Cost WHERE EndCostGUID = a.CostGUID)
                             ORDER BY CostLevel DESC)                             AS ControlCostShortName,
                            ZrrGUID,
                            ZrrName,
                            a.DeptGUID,
                            DeptName,
                            FtAmount,
                            UsedAmount,
                            CostFlag,
                            '日常费用'                                                as ProceedingName,
                            CASE WHEN c.Year < a.Year THEN c.Year ELSE a.Year END AS year,
                            CASE WHEN c.Year < a.Year THEN 12 ELSE a.Month END    AS Month
                     FROM ys_DeptCostUseDtl          a
                              INNER JOIN ys_DeptCost c ON c.DeptCostGUID = a.CostGUID
                     WHERE a.BusinessGUID = @BusinessGUID
                       and a.ProceedingGUID = a.deptGUID
     ```

   + 保存分摊费项实际使用审核临时信息

     ```
     SELECT identity(int,1,1)    as id,
                    dbo.SeqNewId()       as DeptCostUsedInfoGUID,
                    a.businessType,
                    a.BusinessGUID,
                    @RefType             AS RefType,
                    a.DeptCostUseDtlGUID as RefGUID,
                    a.ZrrGUID,
                    a.ZrrName,
                    a.DeptGUID,
                    a.DeptName,
                    a.CostShortName,
                    a.IsYsControl,
                    a.ControlCycle,
                    a.ControlRule,
                    a.ControlCostShortName,
                    a.ProceedingName,
                    a.CostGUID,
                    a.ProceedingGUID,
                    cast(0.00 as money)  as SumPlanAmount,
                    cast(0.00 as money)  as YearPlanAmount,
                    cast(0.00 as money)  as SumFactAmount,
                    cast(0.00 as money)  as FactRate,
                    cast(0.00 as money)  as Ye,
                    cast(0.00 as money)  as FactRateYear,
                    cast(0.00 as money)  as YearFactAmount,
                    cast(0.00 as money)  as QnYe,
                    @ApplyAmount         as ApplyAmount,
                    a.Year,
                    a.Month
             into #DeptCostUsedInfoForSH
             FROM #ys_DeptCostUseDtl a
     ```

     

   + 轮询分摊费项实际使用审核临时信息

     ```
     while @idx <= @cnt BEGIN
                 select @year = YEAR, @CostGUID = CostGUID, @DeptGUID = DeptGUID, @ProceedingGUID = ProceedingGUID
                 from #DeptCostUsedInfoForSH
                 where id = @idx
                 SELECT @CostName = dbo.fn_ys_GetCostFullName(@CostGUID,@year) + '(' + CostCode + ')'
                 FROM dbo.ys_DeptCost
                 WHERE DeptCostGUID = @CostGUID
                 EXEC usp_Ys_getExpenseCostAmoutDtl @DeptGUID,@CostGUID,@ProceedingGUID,@Year,@ApplyDate,@LjYsAmount OUT,
                      @QnPlanAmount OUT,@LjFactAmount OUT,@QnFactAmount OUT
     
                 UPDATE #DeptCostUsedInfoForSH
                 SET SumPlanAmount=@LjYsAmount,
                     YearPlanAmount=@QnPlanAmount,
                     SumFactAmount=@LjFactAmount,
                     YearFactAmount=@QnFactAmount,
                     CostShortName=@CostName
                 WHERE id = @idx
     
                 -- --如果是跨年事项，更新去年12月的数据
                 --IF @ApplyYear <> @Year
                 -- SET @Month = 12
     
                 --select @strSQL = 'update a
                 --set a.SumPlanAmount='+dbo.fn_ys_GetSumAmountSql(@BUGUID,'累计预算',@Month)+'+'+dbo.fn_ys_GetSumAmountSql(@BUGUID,'累计调整',@Month)+',
                 -- a.YearPlanAmount='+dbo.fn_ys_GetSumAmountSql(@BUGUID,'全年预算',@Month)+'+'+dbo.fn_ys_GetSumAmountSql(@BUGUID,'全年调整',@Month)+',
                 -- a.SumFactAmount='+dbo.fn_ys_GetSumAmountSql(@BUGUID,'累计已发生',@Month)+'
                 --from #DeptCostUsedInfoForSH a left join ys_YearPlanDept2Cost b on b.DeptGUID = a.DeptGUID and b.CostGUID = a.CostGUID and b.Year=a.Year
                 --where a.id = '+cast(@idx as varchar(10))
                 --exec(@strSQL)
     
                 set @idx = @idx + 1
             END
     ```

     

   + 获取计划数据信息

     ```
     EXEC usp_Ys_getExpenseCostAmoutDtl @DeptGUID,@CostGUID,@ProceedingGUID,@Year,@ApplyDate,@LjYsAmount OUT,
                      @QnPlanAmount OUT,@LjFactAmount OUT,@QnFactAmount OUT
     -- @LjYsAmount 累计预算金额
     -- @QnPlanAmount 全年预算,
     -- @LjFactAmount 累计已发生
     -- @QnFactAmount 全年已发生金额
     ```

     

   + 更新比例值

     ```
     update #DeptCostUsedInfoForSH
     	set FactRate=case when SumPlanAmount = 0 then 0 else Round((SumFactAmount + 0.000000) / SumPlanAmount,4) end,
     	Ye=SumPlanAmount - SumFactAmount,
     	FactRateYear=case when YearPlanAmount = 0 then 0
     	else Round((YearFactAmount + 0.000000) / YearPlanAmount,4) end,
     	QnYe=YearPlanAmount - YearFactAmount
     ```

     

   + 将临时表信息更新到数据库中

     ```
     INSERT INTO ys_DeptCostUsedInfoForSH ( DeptCostUsedInfoGUID
                                                  , BusinessType
                                                  , BusinessGUID
                                                  , RefType
                                                  , RefGUID
                                                  , ZrrGUID
                                                  , ZrrName
                                                  , DeptGUID
                                                  , DeptName
                                                  , CostShortName
                                                  , ControlCostShortName
                                                  , ProceedingName
                                                  , SumPlanAmount
                                                  , YearPlanAmount
                                                  , SumFactAmount
                                                  , FactRate
                                                  , Ye
                                                  , FactRateYear
                                                  , ApplyAmount
                                                  , IsYsControl
                                                  , ControlCycle
                                                  , ControlRule
                                                  , YearFactAmount
                                                  , QnYe)
             select DeptCostUsedInfoGUID
                  , BusinessType
                  , BusinessGUID
                  , RefType
                  , RefGUID
                  , ZrrGUID
                  , ZrrName
                  , DeptGUID
                  , DeptName
                  , CostShortName
                  , ControlCostShortName
                  , ProceedingName
                  , isnull(SumPlanAmount,0)
                  , isnull(YearPlanAmount,0)
                  , isnull(SumFactAmount,0)
                  , isnull(FactRate,0)
                  , isnull(Ye,0)
                  , isnull(FactRateYear,0)
                  , isnull(ApplyAmount,0)
                  , IsYsControl
                  , ControlCycle
                  , ControlRule
                  , ISNULL(YearFactAmount,0)
                  , ISNULL(QnYe,0)
             from #DeptCostUsedInfoForSH
     ```

     

5. 更新薪酬信息审核状态

   ```
   exec sp_executesql N'UPDATE  dbo.fy_Emolument SET ApproveState =''审核中'' WHERE EmolumentGUID = @Oid ',N'@Oid nvarchar(36)',@Oid=N'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ```

   

#### 1.7.9.6 审批通过

1. 更新薪酬信息审核状态

   ```
   exec sp_executesql N' UPDATE  dbo.fy_Emolument SET ApproveState =''已审核'',finishDate =@Data WHERE EmolumentGUID = @Oid ',
        N'@Data datetime,@Oid nvarchar(36)',@Data='2020-12-14 10:09:21.357',@Oid=N'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ```

   

#### 1.7.9.7 审批驳回

1. 获取薪酬单审核状态

   ```
   exec sp_executesql N'SELECT ApproveState FROM dbo.fy_Emolument WHERE EmolumentGUID = @Oid ',N'@Oid nvarchar(36)',@Oid=N'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ```

   

2. 获取薪酬支付状态

   ```
   exec sp_executesql N'SELECT PayState  FROM dbo.fy_EmolumentDtl  WHERE EmolumentGUID = @Oid ',N'@Oid nvarchar(36)',@Oid=N'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ```

   

3. usp_Ys_DoDeptCostUseDtl

   ```
   exec usp_Ys_DoDeptCostUseDtl @BusinessGUID= 'd47912e8-0e77-4b23-9bcb-aadda3ab5586',@BusinessType='XCFF',@Type='NASS',
        @Flag='XCFF';
   ```

   + 将部门费用分摊信息金额更新为0

     ```
     SET @Operater = '-'
     UPDATE ys_DeptCostUseDtl SET UsedAmount = 0 WHERE BusinessGUID = @BusinessGUID
     ```

4. usp_Ys_InDeptCostUsedInfoForSH

   ```
   exec usp_Ys_InDeptCostUsedInfoForSH @BusinessGUID= 'd47912e8-0e77-4b23-9bcb-aadda3ab5586',@BusinessType='XCFF',
        @Type='NASS';
   ```

   

5. 更新薪酬信息审核状态

   ```
   exec sp_executesql N' UPDATE  dbo.fy_Emolument SET ApproveState =''未审核'' WHERE EmolumentGUID = @Oid',N'@Oid nvarchar(36)',@Oid=N'd47912e8-0e77-4b23-9bcb-aadda3ab5586'
   ```

   
   
#### 1.7.9.8 薪酬管理表结构分析

| 表                         | 中文                         | 说明                                                         |
| -------------------------- | ---------------------------- | ------------------------------------------------------------ |
| fy_Emolument               | 薪酬主信息表                 | declare @EmolumentGUID uniqueidentifier = '1E484C73-160D-4E07-8B8F-C638CE4EED40'<br>select * from dbo.fy_Emolument where EmolumentGUID = @EmolumentGUID; |
| fy_EmolumentDtl            | 薪酬分摊明细表               | select * from dbo.fy_EmolumentDtl where EmolumentGUID = @EmolumentGUID; |
| ys_DeptCostUseDtl          | 费用预算使用明细表           | select * from ys_DeptCostUseDtl where BusinessGUID = @EmolumentGUID and BusinessType = '薪酬发放'; |
| ep_Documents               |                              |                                                              |
| ys_YearPlanProceeding2Cost | 事项年度科目预算表           | 已发生状态则会更新                                           |
| ys_YearPlanDept2Cost       | 部门年度科目预算表           | 已发生状态则会更新                                           |
| ys_DeptCostUsedInfoForSH   | 分摊费项实际使用明细审核信息 | select * from ys_DeptCostUsedInfoForSH where BusinessType = '薪酬发放' and BusinessGUID = @EmolumentGUID |

### 1.7.10 付款登记-薪酬发放

#### 1.7.10.1 列表查询

1. 薪酬发放列表

   ```
   SELECT TOP 20 *
   FROM (select deptguid,
                d.amount                                        as emolumentamount,
                emolumentcode,
                a.emolumentguid,
                emolumentname,
                jbdate,
                jbrguid,
                jbrname,
                [month],
                a.finishdate,
                ApproveState,
                case d.paystate when '已支付' then '√' else '' end as paystate_text,
                remark,
                [year],
                b.buname,
                hierarchycode                                   as applydeptcode,
                c.processguid,
                d.paystate,
                d.paymentguid,
                d.PaymentName
         from fy_emolument                                                                        a
                  left join  dbo.mybusinessunit                                                   b on a.deptguid = b.buguid
                  left join  myworkflowprocessentity                                              c
                             on a.emolumentguid = c.businessguid and isnull(c.ishistory,0) = 0
                  inner join (select emolumentguid, paymentguid, paystate, paymentname, amount
                              from fy_emolumentdtl
                              group by emolumentguid, paymentguid, paystate, paymentname, amount) d
                             on a.emolumentguid = d.emolumentguid) AS tab
   WHERE ((1 = 1 AND (ApplyDeptCode = 'zb.1' or ApplyDeptCode like 'zb.1.%')))
     AND ApproveState = '已审核'
   ORDER BY jbDate DESC, EmolumentGUID
   ```

   

#### 1.7.10.2 付款-加载

1. 薪酬单金额

   ```
   -- 关联v_EmolumentForVoucher表会出现多条，所以Amount重新获取
   select SUM(Amount) from  dbo.fy_emolumentdtl WHERE EmolumentGUID='d4c3a68e-a3fc-4694-9029-794a5c6fa3b1' AND PaymentGUID='7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```

   

2. 获取该薪酬单及其明细付款单位关联的付款单信息

   ```
    SELECT EmolumentCode,
           EmolumentName,
           jbrName,
           jbDate,
           EmolumentAmount,
           Amount,
           b.ApproveState,
           c.PayState,
           Kpr,
           KpDate,
           FinanceRegisterDate,
           IsEnterVoucher,
           VouchGUID,
           PaymentName
    FROM fy_Emolument                  a
             LEFT JOIN ys_Voucher      b ON a.EmolumentGUID = b.BusinessGUID
             LEFT JOIN fy_EmolumentDtl c ON a.EmolumentGUID = c.EmolumentGUID AND b.VouchGUID = c.ToVouchGUID
    WHERE a.EmolumentGUID = 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1'
      AND b.PayProviderGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```

   ```
   SELECT EmolumentCode,
           EmolumentName,
           PaymentName,
           jbrName,
           jbDate,
           ApproveState,
           EmolumentAmount,
           Amount,
           b.PayState
    FROM fy_Emolument                      a
             LEFT JOIN dbo.fy_EmolumentDtl b ON a.EmolumentGUID = b.EmolumentGUID
    WHERE a.EmolumentGUID = 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1'
      AND PaymentGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```

   

3. 款项明细

   ```
   
    SELECT top 1 ''             As rowid,
                 dbo.SeqNewId() as payguid,
                 0              as entity,
                 ''             as RecordType,
                 ''             as LoanGUID,
                 b.CurrencyName As Currency,
                 Amount         as DcAmount,
                 Amount         as PayAmount_Bz,
                 Amount         as PayAmount,
                 b.Rate,
                 '银行'           as PayMode,
                 ''             as PayBankName,
                 ''             as FinanceJsMode,
                 ''             as FinanceJsCode,
                 ''             as LoanSubject
    FROM fy_Emolument                                        a
             left join cb_currency                           b on a.CurrencyGUID = b.CurrencyGUID
             LEFT JOIN (SELECT ISNULL(SUM(DcAmount),0)   AS sumDcAmount,
                               ISNULL(SUM(PayAmount1),0) as sumPayAmount,
                               ISNULL(SUM(PayAmount),0)  as sumPayAmount_Bz,
                               BusinessGUID,
                               BusinessType
                        FROM ys_Pay
                        GROUP BY BusinessGUID, BusinessType) c
                       ON a.EmolumentGUID = c.BusinessGUID AND c.BusinessType = '薪酬发放'
             LEFT JOIN (SELECT EmolumentGUID, SUM(Amount) AS Amount, PaymentGUID
                        FROM fy_EmolumentDtl
                        GROUP BY PaymentGUID, EmolumentGUID) d ON a.EmolumentGUID = d.EmolumentGUID
    WHERE a.EmolumentGUID = 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1'
      AND Amount > 0
      AND d.PaymentGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```

   

4. 薪酬单明细

   ```
   select ''                                 as rowid,
           1                                  as entity,
           EmolumentDtlGUID,
           EmolumentGUID,
           Brief,
           Convert(varchar(10),OccurDate,121) as OccurDate,
           Amount                             as Amount_Bz,
           isnull(IsCanDeductible,0)          as IsCanDeductible,
           isnull(InputTaxAmount,0)           as InputTaxAmount,
           ExcludingTaxApplyAmount,
           AccountingSubjectGUID,
           AccountingSubject,
           isnull(ii.counts,0)                as ViewInvoice,
           ISNULL(InvoiceType,'')             as InvoiceType,
           ExcludingTaxApplyAmount,
           ExpenseDtlName,
           TaxRate                            AS TaxType,
           ToVouchGUID,
           ToPayGUID
    from fy_EmolumentDtl                                                                                    dtl
             left join (select RefGUID, count(InvoiceItemGUID) counts from cb_InvoiceItem group by RefGUID) ii
                       on ii.RefGUID = dtl.EmolumentDtlGUID
    where 1 = 1
      and EmolumentGUID = 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1'
      and PaymentGUID = '7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```

   

5. 发票信息

   ```
   select ii.InvoiceItemGUID,
           ii.ContractGUID,
           ii.BUGUID,
           ii.ReceiveProviderGUID,
           ii.ReceiveUnitName,
           ii.PayProviderGUID,
           ii.PayProviderName,
           ii.VouchType,
           ii.Invotype,
           ii.InvoNO,
           ii.FundType,
           ii.FundName,
           ii.YwType,
           ii.InvoiceAmount,
           ii.PrevVoucherBalance,
           ii.AfterVoucherBalance,
           ii.Jbr,
           ii.JbDate,
           ii.ApproveState,
           ii.Shr,
           ii.ShDate,
           ii.IsEnterVoucher,
           ii.FinanceRegisterDate,
           ii.FinanceExportDate,
           ii.IsGenerateFail,
           ii.FailReason,
           ii.InvoiceType,
           ii.InputTaxAmount,
           ii.ExcludingTaxInvoiceAmount,
           ii.InvoiceDate,
           ii.RefGUID,
           ii.Code,
           ii.BuyerCompanyBankNNum,
           ii.SellerCompanyBankNNum
    from cb_InvoiceItem              ii
             left join cb_ExpenseDtl dtl on dtl.ExpenseDtlGUID = ii.RefGUID
    where ii.RefGUID = 'a92eca8d-c600-445b-b6c9-577188022af7'
   ```

   

#### 1.7.10.3 付款-保存

1. 获取付款信息

   ```
   select * from ys_voucher where BusinessGUID='1e484c73-160d-4e07-8b8f-c638ce4eed40' and PayProviderGUID='7bf41540-fde6-e811-aacb-00155d0a1c3e'
   ```
   
2. 获取支付信息

   ```
   exec sp_executesql N'select top 1 1 from ys_Pay where PayGUID=@PayGUID;',N'@PayGUID uniqueidentifier',@PayGUID='E8AB6377-6A43-EB11-A55A-00155D0A2516'
   ```

   

3. 更新薪酬单金额

   ```
   update fy_Emolument
   set
       EmolumentAmount='100'
   where
       EmolumentGUID = '1e484c73-160d-4e07-8b8f-c638ce4eed40';
   ```

4. 插入票据信息

   ```
   INSERT INTO ys_voucher(VouchGUID, BusinessGUID, vouchType, vouchStatus, Kpr, KpDate, ApproveState, ReceiveUnitName
   ,                      ReceiveBankName, ReceiveBankAccounts, Bz, Rate, BusinessType, PayProviderGUID, PayProviderName
   ,                      InvoiceAmount, Invotype, IsEnterVoucher, FinanceRegisterDate, shdate)
   SELECT TOP 1
       VouchGUID='7eb190b4-4a3e-422e-9d00-0425519e9441'
        , EmolumentGUID
        , '付款单' AS vouchType
        , ''    as vouchStatus
        , Kpr='订单系统'
        , KpDate='2020-12-21'
        , '未审核' AS ApproveState
        , ReceiveUnitName
        , ReceiveBankName
        , ReceiveBankAccounts
        , Bz
        , Rate
        , BusinessType='薪酬发放'
        , PayProviderGUID='7bf41540-fde6-e811-aacb-00155d0a1c3e'
        , PayProviderName
        , 0.00  as InvoiceAmount
        , '无发票' as Invotype
        , '是'
        , FinanceRegisterDate
        , getdate()
   FROM v_EmolumentForVoucher
   WHERE
       EmolumentGUID = '1e484c73-160d-4e07-8b8f-c638ce4eed40';
   ```

   

5. 插入支付款项信息

   ```
   INSERT INTO ys_Pay
       ( VouchGUID, PayGUID, LoanGUID, RecordType, BusinessType, Num, PayDate, PayAmount1, PayAmount, DcAmount, PayMode
       , Currency, Rate, PayBankName, FinanceJsMode, FinanceJsCode, HTFKApplyGUID, BusinessGUID)
   VALUES
       ( '7eb190b4-4a3e-422e-9d00-0425519e9441', 'e8ab6377-6a43-eb11-a55a-00155d0a2516', null, null, '薪酬发放', 1
       , '2020-12-21', 100.00, 100.00, '100.00', '银行', '人民币', 1.0000, '1234123', '', 'xxxxx'
       , '1e484c73-160d-4e07-8b8f-c638ce4eed40', '1e484c73-160d-4e07-8b8f-c638ce4eed40');
   update dbo.fy_EmolumentDtl
   set
       OccurDate='2020/12/1 0:00:00'
     , ExpenseDtlName='日常报销-交通'
     , Brief='xx'
     , InvoiceType='增值税专用发票'
     , Amount='100.00'
     , IsCanDeductible='1'
     , TaxRate='3%'
     , InputTaxAmount='2.91'
     , ExcludingTaxApplyAmount='97.09'
     , AccountingSubjectGUID='a3f11f76-98f8-e811-aad4-00155d0a1c3e'
     , AccountingSubject='差旅费'
     , PayState='已支付'
     , ToPayGUID='ccc9986b-8027-4d9c-ac4a-4d02b16d15dd'
     , ToVouchGUID='7eb190b4-4a3e-422e-9d00-0425519e9441'
   WHERE
       EmolumentDtlGUID = '89e82f8a-670b-484a-b977-5c041ec2f38f';
   ```

   

6. 获取付款明细开票日期

   ```
   SELECT top 1 convert(varchar(10),kpDate,112) FROM ys_voucher WHERE VouchGUID = '7eb190b4-4a3e-422e-9d00-0425519e9441'
   ```

7. 获取该支付款项实付总金额

   ```
   exec sp_executesql N' SELECT SUM(ISNULL(PayAmount1,0)) AS SumDcAmount FROM dbo.ys_Pay  WHERE BusinessGUID=@BusinessGUID AND BusinessType=''日常报销'' AND VouchGUID=@VouchGUID ',N'@BusinessGUID nvarchar(36),@VouchGUID nvarchar(36)',@BusinessGUID=N'1e484c73-160d-4e07-8b8f-c638ce4eed40',@VouchGUID=N'7eb190b4-4a3e-422e-9d00-0425519e9441'
   ```

   

8. 更新年度预算和部门科目预算占用信息

   ```
   exec usp_Ys_UpdateYearPlanCost '已支付','fb489ba6-7ade-11ea-8b09-00155d0a1c30','fb489ba6-7ade-11ea-8b09-00155d0a1c30',
        'b51b57f7-7744-e911-aadb-00155d0a1c3e',2020,12,0.0000000000;
   ```

   ```
   CREATE Proc dbo.usp_Ys_UpdateYearPlanCost(@Type varchar(10), --更新类型:包括预算、调整、已发生、已支付
                                             @DeptGUID uniqueidentifier, --部门GUID:是针对哪个部门的更新
                                             @ProceedingGUID uniqueidentifier, --事项GUID：是针对哪个事项的更新
                                             @CostGUID uniqueidentifier, --科目GUID：更新的科目
                                             @Year int, --年度：更新哪个年度的数据
                                             @Month int, --月份：更新哪个月份的数据
                                             @Amount money --差额值：发生的差额值(要减去金额请传递负数)
   ) As
   BEGIN
       --1.定义临时变量
       DECLARE @UpdateFieldName varchar(20) --要更新的字段名称
       DECLARE @strSQL varchar(1500) --储存动态SQL
       DECLARE @strSQL1 varchar(1500)
       --储存动态SQL
       --2.确定要更新的字段名
       --2.1 根据更新类型确定要更新的字段
       IF @Type = '预算'
           Set @UpdateFieldName = 'PlanAmount'
       ELSE
           IF @Type = '调整'
               Set @UpdateFieldName = 'AdjustAmount'
           ELSE
               IF @Type = '已发生'
                   Set @UpdateFieldName = 'FactAmount'
               ELSE
                   IF @Type = '已支付' Set @UpdateFieldName = 'PayAmount' ELSE return -1
   
       --2.2 根据更新月份确定要更新的字段 
       Set @UpdateFieldName = @UpdateFieldName + CONVERT(varchar(2),@Month)
   
       --3. 更新事项科目的金额(科目关系表包含有末级和非末级科目)
       SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                     CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                     ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' +
                     CONVERT(varchar(4),@Year) +
                     ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                     CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL)
       --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
       SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                      CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                      ''' AND Year=' + CONVERT(varchar(4),@Year) +
                      ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                      CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL1)
       return 1
   
   END
   
   GO
   ```

   

9. 插入费用分摊科目信息

   ```
   exec sp_executesql
        N'INSERT INTO ys_CostFkFt(FtCostGUID,VouchGUID,ProceedingGUID ,CostGUID,YearMonth,PayAmount,FtRate,FtAmount) SELECT dbo.SeqNewID(),@VouchGUID,ProceedingGUID,CostGUID,CASE WHEN b.year<>@strKpYear THEN CONVERT(VARCHAR(4),b.Year)+''-12'' ELSE CONVERT(VARCHAR(4),b.Year)+''-''+@strMonth END AS YearMonth,@payAmount as PayAmount,a.FtAmount/CAST(c.SumFtAmount AS DECIMAL(27,13)) as FtRate,@payAmount*a.FtAmount/CAST(c.SumFtAmount AS DECIMAL(27,13)) as FtAmount  FROM ys_DeptCostUseDtl a LEFT JOIN ys_DeptCost b ON b.DeptCostGUID = a.CostGUID INNER JOIN (  	SELECT SUM(ISNULL(FtAmount,0))   AS SumFtAmount,  			BusinessGUID  	FROM ys_DeptCostUseDtl  	GROUP BY BusinessGUID  ) c ON  a.BusinessGUID=c.BusinessGUID  WHERE a.BusinessGUID =@strApplyGUID ',
        N'@VouchGUID nvarchar(36),@strKpYear nvarchar(4),@strMonth nvarchar(2),@payAmount decimal(1,0),@strApplyGUID nvarchar(36)',
        @VouchGUID=N'7eb190b4-4a3e-422e-9d00-0425519e9441',@strKpYear=N'2020',@strMonth=N'12',@payAmount=0,@strApplyGUID=N'1e484c73-160d-4e07-8b8f-c638ce4eed40'
   ```

#### 1.7.10.4 支付驳回

1. 获取该薪酬明细的支付状态

   ```
   exec sp_executesql N'SELECT PayState  FROM dbo.fy_EmolumentDtl  WHERE EmolumentGUID = @Oid ',N'@Oid nvarchar(36)',@Oid=N'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1'
   ```

2. exec usp_Ys_DoDeptCostUseDtl

   ```
   exec usp_Ys_DoDeptCostUseDtl @BusinessGUID= 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1',@BusinessType='XCFF' , @Type='NASS',@Flag='XCFF';  
   ```

   ```
   -- 将部门科目事项明细该笔薪酬单已使用金额更新为0
   SET @Operater = '-'
   UPDATE ys_DeptCostUseDtl SET UsedAmount = 0 WHERE BusinessGUID = @BusinessGUID
   
   SET @FtAmount = cast(@Operater + CONVERT(varchar(30),@FtAmount) as money)
   --开始同步科目
   EXEC usp_Ys_UpdateYearPlanCost '已发生',@DeptGUID,@ProceedingGUID,@DeptCostGUID,@Year,@Month1,@FtAmount
   	IF @BusinessType = 'RCBX' OR @BusinessType = 'XCFF'
       	BEGIN
           	EXEC usp_Ys_UpdateYearPlanCostByPay '已发生',@DeptGUID,@ProceedingGUID,@DeptCostGUID,@Year,@Month1,@FtAmount
   		END	
   ```

3. EXEC usp_Ys_UpdateYearPlanCost

   ```
   CREATE Proc dbo.usp_Ys_UpdateYearPlanCost(@Type varchar(10), --更新类型:包括预算、调整、已发生、已支付
                                             @DeptGUID uniqueidentifier, --部门GUID:是针对哪个部门的更新
                                             @ProceedingGUID uniqueidentifier, --事项GUID：是针对哪个事项的更新
                                             @CostGUID uniqueidentifier, --科目GUID：更新的科目
                                             @Year int, --年度：更新哪个年度的数据
                                             @Month int, --月份：更新哪个月份的数据
                                             @Amount money --差额值：发生的差额值(要减去金额请传递负数)
   ) As
   BEGIN
       --1.定义临时变量
       DECLARE @UpdateFieldName varchar(20) --要更新的字段名称
       DECLARE @strSQL varchar(1500) --储存动态SQL
       DECLARE @strSQL1 varchar(1500)
       --储存动态SQL
       --2.确定要更新的字段名
       --2.1 根据更新类型确定要更新的字段
       IF @Type = '预算'
           Set @UpdateFieldName = 'PlanAmount'
       ELSE
           IF @Type = '调整'
               Set @UpdateFieldName = 'AdjustAmount'
           ELSE
               IF @Type = '已发生'
                   Set @UpdateFieldName = 'FactAmount'
               ELSE
                   IF @Type = '已支付' Set @UpdateFieldName = 'PayAmount' ELSE return -1
   
       --2.2 根据更新月份确定要更新的字段 
       Set @UpdateFieldName = @UpdateFieldName + CONVERT(varchar(2),@Month)
   
       --3. 更新事项科目的金额(科目关系表包含有末级和非末级科目)
   
       SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                     CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                     ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' +
                     CONVERT(varchar(4),@Year) +
                     ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                     CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL)
       --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
       SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                      CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                      ''' AND Year=' + CONVERT(varchar(4),@Year) +
                      ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                      CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL1)
       return 1
   END
   go
   ```

   

4. EXEC usp_Ys_UpdateYearPlanCost

   ```
   IF @Type = '预算'
           Set @UpdateFieldName = 'PlanAmount'
       ELSE
           IF @Type = '调整'
               Set @UpdateFieldName = 'AdjustAmount'
           ELSE
               IF @Type = '已发生'
                   Set @UpdateFieldName = 'FactAmount'
               ELSE
                   IF @Type = '已支付' Set @UpdateFieldName = 'PayAmount' ELSE return -1
   
   -- 更新年度事项科目预算金额
   SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                     CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                     ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' +
                     CONVERT(varchar(4),@Year) +
                     ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                     CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
   EXECUTE (@strSQL)
   --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
   SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                      CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                      ''' AND Year=' + CONVERT(varchar(4),@Year) +
                      ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                      CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL1)
   ```

5. EXEC usp_Ys_UpdateYearPlanCostByPay

   ```
   create Proc dbo.usp_Ys_UpdateYearPlanCostByPay(@Type varchar(10), --更新类型:包括预算、调整、已发生、已支付
                                                  @DeptGUID uniqueidentifier, --部门GUID:是针对哪个部门的更新
                                                  @ProceedingGUID uniqueidentifier, --事项GUID：是针对哪个事项的更新
                                                  @CostGUID uniqueidentifier, --科目GUID：更新的科目
                                                  @Year int, --年度：更新哪个年度的数据
                                                  @Month int, --月份：更新哪个月份的数据
                                                  @Amount money --差额值：发生的差额值(要减去金额请传递负数)
   ) As
   BEGIN
       --1.定义临时变量
       DECLARE @UpdateFieldName varchar(20) --要更新的字段名称
       DECLARE @strSQL varchar(1500) --储存动态SQL
       DECLARE @strSQL1 varchar(1500)
       --储存动态SQL
       --2.确定要更新的字段名
       --2.1 根据更新类型确定要更新的字段
       IF @Type = '预算'
           Set @UpdateFieldName = 'PayYsAmount'
       ELSE
           IF @Type = '调整'
               Set @UpdateFieldName = 'PayYsAdjAmount'
           ELSE
               IF @Type = '已发生'
                   Set @UpdateFieldName = 'PayYsYfsAmount'
               ELSE
                   IF @Type = '已支付' Set @UpdateFieldName = 'PayYsZtAmount' ELSE return -1
   
       --2.2 根据更新月份确定要更新的字段 
       Set @UpdateFieldName = @UpdateFieldName + CONVERT(varchar(2),@Month)
   
       --3. 更新事项科目的金额(科目关系表包含有末级和非末级科目)
   
       SET @strSQL = 'UPDATE ys_YearPlanProceeding2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                     CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                     ''' AND ProceedingGUID=''' + CONVERT(varchar(50),@ProceedingGUID) + ''' AND Year=' +
                     CONVERT(varchar(4),@Year) +
                     ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                     CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL)
       --4. 更新部门科目的金额(科目关系表包含有末级和非末级科目)
       SET @strSQL1 = 'UPDATE ys_YearPlanDept2Cost SET ' + @UpdateFieldName + '=' + @UpdateFieldName + '+' +
                      CONVERT(varchar(30),@Amount) + ' WHERE DeptGUID=''' + CONVERT(varchar(50),@DeptGUID) +
                      ''' AND Year=' + CONVERT(varchar(4),@Year) +
                      ' AND CostGUID IN (select CostGUID from ys_EndCost2Cost where EndCostGUID=''' +
                      CONVERT(varchar(50),@CostGUID) + ''' and Year=' + CONVERT(varchar(4),@Year) + ')'
       EXECUTE (@strSQL1)
       return 1
   
   END
   go
   ```

   

6. 11

   ```
   exec usp_Ys_InDeptCostUsedInfoForSH @BusinessGUID= 'd4c3a68e-a3fc-4694-9029-794a5c6fa3b1', @BusinessType='XCFF', @Type='NASS';
   
   
   ```



### 1.7.11 付款登记-日常报销

### 1.7.12 付款登记-借款

### 1.7.13 付款登记-合同付款

### 1.7.14 付款登记-付款单审核

### 1.7.15 付款登记-发票管理


## 1.8 部门费用分析日志表结构

| 字段名                   | 字段中文         | 字段说明                                                     |
| ------------------------ | ---------------- | ------------------------------------------------------------ |
| LogId                    | LogId            | 主键标识                                                     |
| TranscationId            | 事务标识         | 一个操作内可能含有多个Log,用此字段来标识是否是一个事务内操作 |
| BizAction                | 业务操作行为     | 提交审批、归档、驳回、作废等等业务操作，标识该               |
| BizType                  | 业务类型         | 申请单、合同、合同结算、报销、借款等等                       |
| BizRefGUID               | 业务标识         | 申请单、合同、合同结算、报销、借款等等主键标识               |
| BizDeptGUID              | 责任部门GUID     |                                                              |
| BizFtDetailGUID          | 业务分摊明细标识 |                                                              |
| BizFtCostGUID            | 科目GUID         |                                                              |
| BizAmount                | 分摊金额         |                                                              |
| BizFtYear                | 分摊年份         |                                                              |
| BizFtMonth               | 分摊月份         |                                                              |
| TranscationTime          | 事务发生时间     |                                                              |
| BizSelType               | 费用发生类型     | 调整  实际 占用 支付 预算                                    |



## 1.9 费用执行分析

### 1.9.1 业务审批代码

|          | 业务类                                                  | 发起 | 驳回 | 归档 | 作废 |
| -------- | ------------------------------------------------------- | ---- | ---- | ---- | ---- |
| 申请单   | Mysoft.Fygl.Services.ApplyServices.ApplyService         |      |      |      |      |
| 合同     | Fygl/HTDL/Contract_XMLHTTP.aspx.vb                      |      |      |      |      |
| 合同结算 | Fygl/HTZX/HtBalance_XMLHTTP.aspx.vb                     |      |      |      |      |
| 付款计划 |                                                         |      |      |      |      |
| 付款申请 | Fygl/HTFK/HTFK_XMLHTTP.aspx.vb                          |      |      |      |      |
| 执行单   | Mysoft.Fygl.Services.ExecutionServices.ExecutionService |      |      |      |      |
| 日常报销 | Fygl/FKSP/Expense_XMLHTTP.aspx.vb                       |      |      |      |      |
| 借款申请 | Mysoft.Fygl.Services/LoanServices/LoanApplyService.cs   |      |      |      |      |
| 还款申请 | Mysoft.Fygl.Services/LoanServices/LoanReturnService.cs  |      |      |      |      |
| 薪酬管理 | Fygl/FKSP/Salar_Edit_XMLHTTP.aspx.vb                    |      |      |      |      |

### 1.9.2 存储过程

```
exec usp_Ys_CompanyExpenseAnalyse_CostWithHTAndZFNew @BUGUID='4A44B460-A180-442B-8E32-00914BCE4F0A',@Year=2020,@Unit=N'元',@type=N'HT',@DeptGUID='3E2E1625-AD2B-EA11-A13F-00505692B478',@StartMonth=1,@EndMonth=12
```

### 1.9.3 数据不一致（合同口径）

> 当我们发现某个组织机构下，某个科目下，某个月份里 已发生、在途费用与业务数据不一致的情况下，可以采用以下步骤进去分析

#### 1.9.3.1 根据@BUGUID 和 @DeptGUID 获取 组织机构

```
SELECT DISTINCT CASE WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID ELSE b.SpecialUnitGUID END AS SpecialUnitGUID
FROM ys_SpecialBusinessUnit          a
    LEFT JOIN ys_SpecialBusinessUnit b ON a.SpecialUnitGUID = b.ParentGUID
WHERE
      a.Year = 2020
  AND (a.ParentGUID = '3E2E1625-AD2B-EA11-A13F-00505692B478' OR a.BUGUID = '3E2E1625-AD2B-EA11-A13F-00505692B478' OR
       a.SpecialUnitGUID = '3E2E1625-AD2B-EA11-A13F-00505692B478')
```



#### 1.9.3.2 根据1中获取的组织机构和CostGUID 获取 预算情况

```
SELECT ys_YearPlanProceeding2Cost.CostGUID
     , (PlanAmount1 + PlanAmount2 + PlanAmount3 + PlanAmount4 + PlanAmount5 + PlanAmount6 + PlanAmount7 + PlanAmount8 +
        PlanAmount9 + PlanAmount10 + PlanAmount11 + PlanAmount12 + AdjustAmount1 + AdjustAmount2 + AdjustAmount3 +
        AdjustAmount4 + AdjustAmount5 + AdjustAmount6 + AdjustAmount7 + AdjustAmount8 + AdjustAmount9 + AdjustAmount10 +
        AdjustAmount11 + AdjustAmount12)                          AS planamount
     , (FactAmount1 + FactAmount2 + FactAmount3 + FactAmount4 + FactAmount5 + FactAmount6 + FactAmount7 + FactAmount8 +
        FactAmount9 + FactAmount10 + FactAmount11 + FactAmount12) AS factamount
     , 0                                                          AS ZTFY
     , (FactAmount1)                                              AS m1
     , (FactAmount2)                                              AS m2
     , (FactAmount3)                                              AS m3
     , (FactAmount4)                                              AS m4
     , (FactAmount5)                                              AS m5
     , (FactAmount6)                                              AS m6
     , (FactAmount7)                                              AS m7
     , (FactAmount8)                                              AS m8
     , (FactAmount9)                                              AS m9
     , (FactAmount10)                                             AS m10
     , (FactAmount11)                                             AS m11
     , (FactAmount12)                                             AS m12
     , Year
FROM ys_YearPlanProceeding2Cost
WHERE
      DeptGUID = '3E2E1625-AD2B-EA11-A13F-00505692B478'
  and CostGUID = 'CA7E054D-8B2B-EA11-A13F-00505692B478'
  AND Year = 2020
```

#### 1.9.3.3 获取当前CostGUID和1中获取的组织机构获取业务明细数据（在途数据）

```

declare @Year int = 2020
select *
from (
    --借款单
    SELECT '借款单'                                            AS category
         , ISNULL(a.FtAmount,0) - ISNULL(a.BalanceAmount,0) AS FtAmount
         , a.DeptGUID                                       AS DeptGUID
         , a.CostGUID                                       AS CostGUID
         , DATEPART(MONTH,ISNULL(b.ApplyDate,GETDATE()))    AS FTRQ
    FROM cb_Loan_FtDetail                                                                       a
        INNER JOIN dbo.cb_Loan                                                                  b ON a.LoanGUID = b.LoanGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) c
    WHERE (b.ApplyState = '审核中') AND c.ControlMode IN (0) AND DATEPART(YEAR,ISNULL(b.ApplyDate,GETDATE())) = @Year
    UNION ALL

    --已关联审核通过的付款申请的借款单,科目的分摊金额应该不再占用已发生，按科目分摊金额占总借款金额的比例释放
    SELECT '已关联审核通过的付款申请的借款单'
         , ISNULL(lba.CurBalanceAmount_Bz,0) * ISNULL(bl.costPercent,0) AS FtAmount
         , bl.DeptGUID
         , bl.costGUID
         , DATEPART(MONTH,ISNULL(loan.ApplyDate,GETDATE()))             AS FTRQ
    FROM dbo.cb_LoanBalanceApply                                                                lba
        LEFT JOIN dbo.cb_HTFKApply                                                              fk ON lba.RefGUID = fk.HTFKApplyGUID
        LEFT JOIN cb_loan_kmBL                                                                  bl ON lba.LoanGUID = bl.loanGUID
        LEFT JOIN dbo.cb_Loan                                                                   loan ON lba.LoanGUID = loan.LoanGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) c
    WHERE fk.ApplyState = '已审核' AND c.ControlMode IN (0) AND DATEPART(YEAR,ISNULL(loan.ApplyDate,GETDATE())) = @Year
    UNION ALL
    --申请单(被业务数据关联，并且已生效：业务单据审批通过)
    SELECT '申请单(被业务数据关联，并且已生效：业务单据审批通过)'
         , a.FtAmount                     AS FtAmount
         , a.DeptGUID                     AS DeptGUID
         , a.CostGUID                     AS CostGUID
         , CONVERT(VARCHAR(10),a.FtMonth) AS FTRQ
    FROM dbo.fy_Apply_FtDetail_Period                                                           a
        INNER JOIN dbo.fy_Apply_FtDetail                                                        b
        ON a.ApplyGUID = b.ApplyGUID AND a.DeptGUID = b.DeptGUID AND a.ProceedingGUID = b.ProceedingGUID AND
           a.CostGUID = b.CostGUID
        INNER JOIN dbo.fy_Apply                                                                 c ON a.ApplyGUID = c.ApplyGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) d
    WHERE
          ISNULL(b.HasBeenUsed,0) = 0
      AND c.ApproveState IN ('已审核', '审核中')
      AND IsInvalid = '否'
      AND d.ControlMode = 0
      AND a.FtYear = @Year
      AND NOT EXISTS(SELECT 1
                     FROM (
                         -- 排除已归档合同信息
                         SELECT ApplyGUID
                         FROM dbo.cb_Contract
                         WHERE ApplyGUID IS NOT NULL AND ISNULL(ApproveState,'未审核') <> '未审核'
                         UNION ALL
                         -- 排除已归档日常报销
                         SELECT ApplyGUID
                         FROM cb_Expense
                         WHERE ApplyGUID IS NOT NULL AND ISNULL(ApplyState,'未审核') <> '未审核'
                         UNION ALL
                         -- 排除已归档借款单
                         SELECT RelateApplyGUID
                         FROM dbo.cb_Loan
                         WHERE RelateApplyGUID IS NOT NULL AND ISNULL(ApplyState,'未审核') <> '未审核'
                         UNION ALL
                         --取审批驳回，作废执行单 关联的立项单(即排除已审核、已验收、审核中的执行单关联的立项单)
                         SELECT ApplyGUID
                         FROM dbo.ys_fy_ExecutionInfo
                         WHERE a.ApplyGUID = ApplyGUID AND ApproverState IN ('已审核', '已验收', '审核中')) t
                     WHERE t.ApplyGUID = a.ApplyGUID)
    UNION ALL
    --合同
    SELECT '合同'
         , a.FtAmount                     AS FtAmount
         , a.DeptGUID                     AS DeptGUID
         , a.CostGUID                     AS CostGUID
         , CONVERT(VARCHAR(10),a.FtMonth) AS FTRQ
    FROM dbo.fy_Contract_FtDetail_Period                                                        a
        INNER JOIN dbo.vcb_Contract                                                             b ON a.ContractGUID = b.ContractGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) c
    WHERE b.ApproveState IN ('审核中') AND b.ProjType <> '公司库存' AND c.ControlMode IN (0, 1) AND a.FtYear = @Year
    UNION ALL
    --合同结算
    SELECT '合同结算'
         , a.FtAmount                     AS FtAmount
         , a.DeptGUID                     AS DeptGUID
         , a.CostGUID                     AS CostGUID
         , CONVERT(VARCHAR(10),a.FtMonth) AS FTRQ
    FROM dbo.fy_HTBalance_FtDetail_Period                                                       a
        INNER JOIN dbo.cb_HTBalance                                                             b ON a.HTBalanceGUID = b.HTBalanceGUID
        INNER JOIN dbo.cb_Contract                                                              c ON b.ContractGUID = c.ContractGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) d
    WHERE b.ApproveState IN ('审核中') AND d.ControlMode IN (0, 1) AND a.FtYear = @Year
    UNION ALL

    ---日常报销
    SELECT '日常报销'
         , b.FtAmount               AS FtAmount
         , b.DeptGUID               AS DeptGUID
         , b.CostGUID               AS CostGUID
         , DATEPART(MM,a.ApplyDate) AS FTRQ
    FROM cb_Expense                       a
        LEFT JOIN ys_DeptCostUseDtl       b ON a.ExpenseGUID = b.BusinessGUID AND b.BusinessType = '日常报销'
        LEFT JOIN ys_Proceeding           c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost             d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit          e ON a.ApplyBUGUID = e.BUGUID
        LEFT JOIN (SELECT ISNULL(SUM(PayAmount),0) AS sumDcAmount, BusinessGUID
                   FROM dbo.ys_Pay
                   WHERE BusinessType = '日常报销'
                   GROUP BY BusinessGUID) pay ON pay.BusinessGUID = a.ExpenseGUID
    WHERE a.ApplyState IN ('审核中') AND a.ExpenseTypeName <> '工程水电费代付'
    UNION ALL

    ---薪酬发放
    SELECT '薪酬发放', b.FtAmount AS FtAmount, b.DeptGUID AS DeptGUID, b.CostGUID AS CostGUID, a.Month AS FTRQ
    FROM dbo.fy_Emolument                 a
        LEFT JOIN ys_DeptCostUseDtl       b ON a.EmolumentGUID = b.BusinessGUID AND b.BusinessType = '薪酬发放'
        LEFT JOIN ys_Proceeding           c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost             d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit          e ON a.BUGUID = e.BUGUID
        LEFT JOIN (SELECT ISNULL(SUM(PayAmount),0) AS sumDcAmount, BusinessGUID
                   FROM dbo.ys_Pay
                   WHERE BusinessType = '薪酬发放'
                   GROUP BY BusinessGUID) pay ON pay.BusinessGUID = a.EmolumentGUID
    WHERE a.ApproveState IN ('审核中')
    UNION ALL
    --- 执行单 取审核中数据
    SELECT '执行单 取审核中数据'
         , a.Amount                              AS FtAmount
         , a.DeptGUID                            AS DeptGUID
         , a.DeptCostGUID                        AS CostGUID
         , DATEPART(MONTH,b.BussinessBelongDate) AS FTRQ
    FROM dbo.ys_fy_ExecutionDetails                                                             a
        JOIN dbo.ys_fy_ExecutionInfo                                                            b ON a.ExecutionGUID = b.ExecutionGUID
        CROSS JOIN (SELECT ISNULL(ControlMode,2) AS ControlMode FROM dbo.fy_ControlModeSetting) c
    WHERE b.ApproverState IN ('审核中') AND c.ControlMode IN (0, 1) AND DATEPART(YEAR,BussinessBelongDate) = @Year) tmp
where
      tmp.CostGUID = 'CA7E054D-8B2B-EA11-A13F-00505692B478'
  and tmp.DeptGUID = '3E2E1625-AD2B-EA11-A13F-00505692B478'
```



#### 1.9.3.4 将3中的结果与当月在途明细进行比较

```
select GUID
     , ApplyState
     , ExpenseCode
     , Subject
     , ExpenseAmount
     , AppliedByName
     , ApplyDate
     , FtAmount
     , ProceedingName
     , CostShortName
     , BUName
     , ProceedingGUID
     , CostGUID
     , DeptGUID
     , Year
     , ZrrGUID
     , CostCode
     , BillType
     , SortNum
from (
    --借款单
    select a.LoanGUID                                                                    AS GUID
         , b.ApplyState                                                                  AS ApplyState
         , b.LoanCode                                                                    AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openLoanWin(''' + CAST(a.LoanGUID as VARCHAR(50)) + ''')">' +
           b.Subject + '</a>'                                                            AS Subject
         , b.LoanAmount_Bz                                                               AS ExpenseAmount
         , b.AppliedByName                                                               AS AppliedByName
         , b.ApplyDate                                                                   AS ApplyDate
         , a.FtAmount - ISNULL(a.BalanceAmount,0)                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END AS ProceedingName
         , a.CostShortName                                                               AS CostShortName
         , a.DeptName                                                                    AS BUName
         , a.ProceedingGUID                                                              AS ProceedingGUID
         , a.CostGUID                                                                    AS CostGUID
         , a.DeptGUID                                                                    AS DeptGUID
         , DATEPART(YEAR,ISNULL(b.ApplyDate,GETDATE()))                                  AS Year
         , b.ApplyBUGUID                                                                 AS ZrrGUID
         , a.CostCode                                                                    AS CostCode
         , DATEPART(MONTH,ISNULL(b.ApplyDate,GETDATE()))                                 AS FtMonth
         , '借款单'                                                                         AS BillType
         , 10                                                                            AS SortNum
         , b.ApplyDate                                                                   as FTRQ
    from cb_Loan_FtDetail                                                                       a
        INNER JOIN dbo.cb_Loan                                                                  b ON a.LoanGUID = b.LoanGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) c
    where b.ApplyState IN ('审核中') AND c.ControlMode = 0 AND a.FtAmount > ISNULL(a.BalanceAmount,0)

    UNION ALL

    --申请单
    select c.ApplyGUID                                                                       AS GUID
         , c.ApproveState                                                                    AS ApplyState
         , ''                                                                                AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openApplyWin(''' + CAST(c.ApplyGUID as VARCHAR(50)) + ''')">' +
           c.ApplySubject + '</a>'                                                           AS Subject
         , c.ApplyAmount                                                                     AS ExpenseAmount
         , c.Applier                                                                         AS AppliedByName
         , c.ApplyDate                                                                       AS ApplyDate
         , a.FtAmount                                                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END     AS ProceedingName
         , a.CostShortName                                                                   AS CostShortName
         , c.DeptName                                                                        AS BUName
         , a.ProceedingGUID                                                                  AS ProceedingGUID
         , a.CostGUID                                                                        AS CostGUID
         , a.DeptGUID                                                                        AS DeptGUID
         , a.FtYear                                                                          AS Year
         , c.ApplierGUID                                                                     AS ZrrGUID
         , a.CostCode                                                                        AS CostCode
         , a.FtMonth                                                                         AS FtMonth
         , '申请单'                                                                             AS BillType
         , 1                                                                                 AS SortNum
         , Convert(varchar(10),a.FtYear) + '-' + Convert(varchar(10),a.FtMonth) + '-' + '01' as FTRQ
    from dbo.fy_Apply_FtDetail_Period                                                           a
        INNER JOIN dbo.fy_Apply_FtDetail                                                        b
        ON a.ApplyGUID = b.ApplyGUID AND a.DeptGUID = b.DeptGUID AND a.ProceedingGUID = b.ProceedingGUID AND
           a.CostGUID = b.CostGUID
        INNER JOIN dbo.fy_Apply                                                                 c ON a.ApplyGUID = c.ApplyGUID
        LEFT JOIN cb_Contract                                                                   N ON C.ApplyGUID = N.ApplyGUID
        LEFT JOIN cb_Expense                                                                    M ON C.ApplyGUID = M.ApplyGUID
        LEFT JOIN cb_Loan                                                                       L ON c.ApplyGUID = L.RelateApplyGUID
        left join ys_fy_ExecutionInfo                                                           O
        on c.ApplyGUID = O.ApplyGUID -- 取审批驳回,作废,未审批执行单 关联的立项单(即过滤掉 已关联【审核中，已审核，已验收】状态的执行单)
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) d
    where
          ISNULL(b.HasBeenUsed,0) = 0
      and c.IsInvalid = '否'
      AND c.ApproveState IN ('已审核', '审核中')
      AND d.ControlMode = 0
      AND (N.ApplyGUID IS NULL OR N.ApproveState = '未审核')
      AND (M.ApplyGUID IS NULL OR M.ApplyState = '未审核')
      AND (L.RelateApplyGUID IS NULL OR L.ApplyState = '未审核')
      AND (O.ApplyGUID IS NULL OR O.ApproverState in ('未审核', '已作废')) -- 已作废执行单ApplyGUID 为空，O.ApplyGUID IS NULL 成立

    UNION ALL
    --合同
    select b.ContractGUID                                                                    AS GUID
         , b.ApproveState                                                                    AS ApplyState
         , b.ContractCode                                                                    AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openContractWin(''' + CAST(b.ContractGUID as VARCHAR(50)) +
           ''')">' + b.ContractName + '</a>'                                                 AS Subject
         , b.HtAmount                                                                        AS ExpenseAmount
         , b.Jbr                                                                             AS AppliedByName
         , b.SignDate                                                                        AS ApplyDate
         , a.FtAmount                                                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END     AS ProceedingName
         , a.CostShortName                                                                   AS CostShortName
         , b.JbDeptName                                                                      AS BUName
         , a.ProceedingGUID                                                                  AS ProceedingGUID
         , a.CostGUID                                                                        AS CostGUID
         , a.DeptGUID                                                                        AS DeptGUID
         , a.FtYear                                                                          AS Year
         , b.JbrGUID                                                                         AS ZrrGUID
         , a.CostCode                                                                        AS CostCode
         , a.FtMonth                                                                         AS FtMonth
         , '合同'                                                                              AS BillType
         , 2                                                                                 AS SortNum
         , Convert(varchar(10),a.FtYear) + '-' + Convert(varchar(10),a.FtMonth) + '-' + '01' as FTRQ
    from dbo.fy_Contract_FtDetail_Period                                                        a
        INNER JOIN dbo.vcb_Contract                                                             b ON a.ContractGUID = b.ContractGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) c
    where b.ApproveState IN ('审核中') AND b.ProjType <> '公司库存' AND c.ControlMode IN (0, 1)

    UNION ALL

    --合同结算
    select b.HTBalanceGUID                                                                   AS GUID
         , b.ApproveState                                                                    AS ApplyState
         , ''                                                                                AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openHtBalanceWin(''' + CAST(b.HTBalanceGUID as VARCHAR(50)) +
           ''')">' + c.ContractName + '</a>'                                                 AS Subject
         , b.AdjustAmount1                                                                   AS ExpenseAmount
         , b.Jbr                                                                             AS AppliedByName
         , b.BalanceDate                                                                     AS ApplyDate
         , a.FtAmount                                                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END     AS ProceedingName
         , a.CostShortName                                                                   AS CostShortName
         , b.JbDeptName                                                                      AS BUName
         , a.ProceedingGUID                                                                  AS ProceedingGUID
         , a.CostGUID                                                                        AS CostGUID
         , a.DeptGUID                                                                        AS DeptGUID
         , a.FtYear                                                                          AS Year
         , b.JbrGUID                                                                         AS ZrrGUID
         , a.CostCode                                                                        AS CostCode
         , a.FtMonth                                                                         AS FtMonth
         , '合同结算'                                                                            AS BillType
         , 4                                                                                 AS SortNum
         , Convert(varchar(10),a.FtYear) + '-' + Convert(varchar(10),a.FtMonth) + '-' + '01' as FTRQ
    from dbo.fy_HTBalance_FtDetail_Period                                                       a
        INNER JOIN dbo.cb_HTBalance                                                             b ON a.HTBalanceGUID = b.HTBalanceGUID
        INNER JOIN dbo.cb_Contract                                                              c ON b.ContractGUID = c.ContractGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) d
    where b.ApproveState IN ('审核中') AND d.ControlMode IN (0, 1)

    UNION ALL
    --日常报销
    select a.ExpenseGUID                                                                      AS GUID
         , a.ApplyState
         , a.ExpenseCode
         , '<a href="javascript:parent.parent.openExpenseWin(''' + a.ApplyState + ''',''' +
           CAST(a.ExpenseGUID as VARCHAR(50)) + ''',' + CAST(d.IsEndCost as VARCHAR(1)) + ')" title="' +
           +CONVERT(VARCHAR(max),a.SUBJECT) + '">' + CONVERT(VARCHAR(max),a.SUBJECT) + '</a>' AS Subject
         , a.ExpenseAmount
         , a.AppliedByName
         , a.ApplyDate
         , b.FtAmount
         , CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END      AS ProceedingName
         , d.CostShortName
         , e.BUName
         , b.ProceedingGUID
         , b.CostGUID
         , b.DeptGUID
         , b.Year
         , ZrrGUID
         , d.CostCode
         , b.Month                                                                            as FtMonth
         , '日常报销'                                                                             AS BillType
         , 7                                                                                  AS SortNum
         , a.ApplyDate                                                                        AS FTRQ
    from cb_Expense                 a
        LEFT JOIN ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID AND b.BusinessType = '日常报销'
        LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
    where a.ApplyState IN ('审核中') and a.ExpenseTypeName <> '工程水电费代付'
    UNION ALL
    --薪酬发放
    select a.EmolumentGUID                                                                                AS GUID
         , a.ApproveState
         , a.EmolumentCode
         , '<a href="javascript:parent.parent.openxcwin(''' + a.ApproveState + ''',''' +
           CAST(a.EmolumentGUID as VARCHAR(50)) + ''',' + CAST(d.IsEndCost as VARCHAR(1)) + ')" title="' +
           +CONVERT(VARCHAR(max),a.EmolumentName) + '">' + CONVERT(VARCHAR(max),a.EmolumentName) + '</a>' AS Subject
         , a.EmolumentAmount
         , a.jbrName
         , a.jbDate
         , b.FtAmount
         , CASE
               WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用'
               ELSE c.ProceedingName
           END                                                                                            AS ProceedingName
         , d.CostShortName
         , e.BUName
         , b.ProceedingGUID
         , b.CostGUID
         , b.DeptGUID
         , b.Year
         , ZrrGUID
         , d.CostCode
         , b.Month                                                                                        as FtMonth
         , '薪酬发放'                                                                                         AS BillType
         , 7                                                                                              AS SortNum
         , a.jbDate                                                                                       AS FTRQ
    from dbo.fy_Emolument           a
        LEFT JOIN ys_DeptCostUseDtl b ON a.EmolumentGUID = b.BusinessGUID AND b.BusinessType = '薪酬发放'
        LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit    e ON a.DeptGUID = e.BUGUID
    where a.ApproveState IN ('审核中')
    UNION ALL
    --执行单
    select a.ExecutionGUID                                            AS GUID
         , a.ApproverState                                            AS ApplyState
         , a.ExecutionCode                                            AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openExecutionWin(''' + a.ApproverState + ''',''' +
           CAST(a.ExecutionGUID as VARCHAR(50)) + ''',''' + CAST(a.DeptGUID as VARCHAR(50)) + ''')">' +
           a.ExecutionName + '</a>'                                   AS Subject
         , a.ReportMoney                                              AS ExpenseAmount
         , mu.UserName                                                AS AppliedByName
         , a.ApplyDate                                                AS ApplyDate
         , b.Amount                                                   AS FtAmount
         , b.ProcessName                                              AS ProceedingName
         , c.CostShortName                                            AS CostShortName
         , d.BUName                                                   AS BUName
         , b.ProcessGUID                                              AS ProceedingGUID
         , c.DeptCostGUID                                             AS CostGUID
         , b.DeptGUID                                                 AS DeptGUID
         , DATEPART(year,a.BussinessBelongDate)                       AS Year
         , a.ApplicantGUID                                            AS ZrrGUID
         , c.CostCode                                                 AS CostCode
         , DATEPART(month,a.BussinessBelongDate)                      AS FtMonth
         , '执行单'                                                      AS BillType
         , 8                                                          AS SortNum
         , Convert(varchar(7),a.BussinessBelongDate,120) + '-' + '01' as FTRQ
    from dbo.ys_fy_ExecutionInfo                                                                a
        JOIN dbo.ys_fy_ExecutionDetails                                                         b ON a.ExecutionGUID = b.ExecutionGUID
        join ys_DeptCost                                                                        c on b.DeptCostGUID = c.DeptCostGUID
        join myBusinessUnit                                                                     d on a.ApplicantDeptGUID = d.BUGUID
        join myUser                                                                             mu on a.ApplicantGUID = mu.UserGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) e
    where a.ApproverState in ('审核中') AND e.ControlMode IN (0, 1)) A
WHERE
      1 = 1
  AND 168 = 168
  and DeptGUID IN (SELECT SpecialUnitGUID
                   from (SELECT CASE
                                    WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID
                                    ELSE b.SpecialUnitGUID
                                END AS SpecialUnitGUID
                         from dbo.ys_SpecialBusinessUnit      A
                             LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
                         WHERE
                                 A.Year = '2020' AND A.SpecialUnitGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478'
                           OR    A.BUGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478'
                           OR    A.ParentGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478') C)
  and CostGUID = 'CA7E054D-8B2B-EA11-A13F-00505692B478'
  and FTRQ >= '2020-12-01 00:00:00'
  AND FTRQ < '2021-01-01 00:00:00'

```

#### 1.9.3.5 将3中的结果与当月已发生明细进行比较

```
select GUID
     , ApplyState
     , ExpenseCode
     , Subject
     , ExpenseAmount
     , AppliedByName
     , ApplyDate
     , FtAmount
     , ProceedingName
     , CostShortName
     , BUName
     , ProceedingGUID
     , CostGUID
     , DeptGUID
     , Year
     , ZrrGUID
     , CostCode
     , BillType
     , SortNum
from (
    --借款单

    select a.LoanGUID                                                                    AS GUID
         , b.ApplyState                                                                  AS ApplyState
         , b.LoanCode                                                                    AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openLoanWin(''' + CAST(a.LoanGUID as VARCHAR(50)) + ''')">' +
           b.Subject + '</a>'                                                            AS Subject
         , b.LoanAmount_Bz                                                               AS ExpenseAmount
         , b.AppliedByName                                                               AS AppliedByName
         , b.ApplyDate                                                                   AS ApplyDate
         , a.FtAmount - ISNULL(a.BalanceAmount,0) - ISNULL(t.FtAmount,0)                 AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END AS ProceedingName
         , a.CostShortName                                                               AS CostShortName
         , a.DeptName                                                                    AS BUName
         , a.ProceedingGUID                                                              AS ProceedingGUID
         , a.CostGUID                                                                    AS CostGUID
         , a.DeptGUID                                                                    AS DeptGUID
         , DATEPART(YEAR,ISNULL(b.ApplyDate,GETDATE()))                                  AS Year
         , b.ApplyBUGUID                                                                 AS ZrrGUID
         , a.CostCode                                                                    AS CostCode
         , DATEPART(MONTH,ISNULL(b.ApplyDate,GETDATE()))                                 AS FtMonth
         , '借款单'                                                                         AS BillType
         , 10                                                                            AS SortNum
         , b.ApplyDate                                                                   as FTRQ
    from cb_Loan_FtDetail                                                                       a
        INNER JOIN dbo.cb_Loan                                                                  b ON a.LoanGUID = b.LoanGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) c
        left join (
        --已关联审核通过的付款申请的借款单,科目的分摊金额应该不再占用已发生，按科目分摊金额占总借款金额的比例释放
        select DeptGUID, costGUID, SUM(FtAmount) AS FtAmount, t5.year, t5.FTRQ
        from (select bl.DeptGUID
                   , bl.costGUID
                   , ISNULL(lba.CurBalanceAmount_Bz,0) * ISNULL(bl.costPercent,0) AS FtAmount
                   , DATEPART(YEAR,ISNULL(loan.ApplyDate,GETDATE()))              as year
                   , DATEPART(MONTH,ISNULL(loan.ApplyDate,GETDATE()))             AS FTRQ
              from dbo.cb_LoanBalanceApply                                                                lba
                  LEFT JOIN dbo.cb_HTFKApply                                                              fk ON lba.RefGUID = fk.HTFKApplyGUID
                  LEFT JOIN cb_loan_kmBL                                                                  bl ON lba.loanGUID = bl.loanGUID
                  LEFT JOIN dbo.cb_Loan                                                                   loan ON lba.LoanGUID = loan.LoanGUID
                  CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) c
              where
                    fk.ApplyState = '已审核'
                AND loan.ApplyState IN ('已审核', '冲账未完成')
                AND EXISTS(select 1
                           from dbo.ys_Voucher
                           where BusinessGUID = loan.LoanGUID AND ISNULL(ApproveState,'') = '已审核')
                AND c.ControlMode = 0) t5
        group by DeptGUID, costGUID, t5.year, t5.FTRQ)                                          t
        ON DATEPART(YEAR,ISNULL(b.ApplyDate,GETDATE())) = t.year AND
           DATEPART(MONTH,ISNULL(b.ApplyDate,GETDATE())) = t.FTRQ AND a.DeptGUID = t.DeptGUID AND
           a.costGUID = t.costGUID
    where b.ApplyState IN ('已审核', '冲账未完成') AND c.ControlMode = 0 AND a.FtAmount > ISNULL(a.BalanceAmount,0)

    UNION ALL

    --合同
    select b.ContractGUID                                                                    AS GUID
         , b.ApproveState                                                                    AS ApplyState
         , b.ContractCode                                                                    AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openContractWin(''' + CAST(b.ContractGUID as VARCHAR(50)) +
           ''')">' + b.ContractName + '</a>'                                                 AS Subject
         , b.HtAmount                                                                        AS ExpenseAmount
         , b.Jbr                                                                             AS AppliedByName
         , b.SignDate                                                                        AS ApplyDate
         , a.FtAmount                                                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END     AS ProceedingName
         , a.CostShortName                                                                   AS CostShortName
         , b.JbDeptName                                                                      AS BUName
         , a.ProceedingGUID                                                                  AS ProceedingGUID
         , a.CostGUID                                                                        AS CostGUID
         , a.DeptGUID                                                                        AS DeptGUID
         , a.FtYear                                                                          AS Year
         , b.JbrGUID                                                                         AS ZrrGUID
         , a.CostCode                                                                        AS CostCode
         , a.FtMonth                                                                         AS FtMonth
         , '合同'                                                                              AS BillType
         , 2                                                                                 AS SortNum
         , Convert(varchar(10),a.FtYear) + '-' + Convert(varchar(10),a.FtMonth) + '-' + '01' as FTRQ
    from dbo.fy_Contract_FtDetail_Period                                                        a
        INNER JOIN dbo.vcb_Contract                                                             b ON a.ContractGUID = b.ContractGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) c
    where b.ApproveState IN ('已审核') AND b.ProjType <> '公司库存' AND c.ControlMode IN (0, 1)

    UNION ALL

    --合同结算
    select b.HTBalanceGUID                                                                   AS GUID
         , b.ApproveState                                                                    AS ApplyState
         , ''                                                                                AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openHtBalanceWin(''' + CAST(b.HTBalanceGUID as VARCHAR(50)) +
           ''')">' + c.ContractName + '</a>'                                                 AS Subject
         , b.AdjustAmount1                                                                   AS ExpenseAmount
         , b.Jbr                                                                             AS AppliedByName
         , b.BalanceDate                                                                     AS ApplyDate
         , a.FtAmount                                                                        AS FtAmount
         , CASE WHEN a.ProceedingGUID = a.DeptGUID THEN '日常费用' ELSE a.ProceedingName END     AS ProceedingName
         , a.CostShortName                                                                   AS CostShortName
         , b.JbDeptName                                                                      AS BUName
         , a.ProceedingGUID                                                                  AS ProceedingGUID
         , a.CostGUID                                                                        AS CostGUID
         , a.DeptGUID                                                                        AS DeptGUID
         , a.FtYear                                                                          AS Year
         , b.JbrGUID                                                                         AS ZrrGUID
         , a.CostCode                                                                        AS CostCode
         , a.FtMonth                                                                         AS FtMonth
         , '合同结算'                                                                            AS BillType
         , 4                                                                                 AS SortNum
         , Convert(varchar(10),a.FtYear) + '-' + Convert(varchar(10),a.FtMonth) + '-' + '01' as FTRQ
    from dbo.fy_HTBalance_FtDetail_Period                                                       a
        INNER JOIN dbo.cb_HTBalance                                                             b ON a.HTBalanceGUID = b.HTBalanceGUID
        INNER JOIN dbo.cb_Contract                                                              c ON b.ContractGUID = c.ContractGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) d
    where b.ApproveState IN ('已审核') AND d.ControlMode IN (0, 1)

    UNION ALL

    --日常报销
    select a.ExpenseGUID                                                                      AS GUID
         , a.ApplyState
         , a.ExpenseCode
         , '<a href="javascript:parent.parent.openExpenseWin(''' + a.ApplyState + ''',''' +
           CAST(a.ExpenseGUID as VARCHAR(50)) + ''',' + CAST(d.IsEndCost as VARCHAR(1)) + ')" title="' +
           +CONVERT(VARCHAR(max),a.SUBJECT) + '">' + CONVERT(VARCHAR(max),a.SUBJECT) + '</a>' AS Subject
         , a.ExpenseAmount
         , a.AppliedByName
         , a.ApplyDate
         , b.FtAmount
         , CASE WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用' ELSE c.ProceedingName END      AS ProceedingName
         , d.CostShortName
         , e.BUName
         , b.ProceedingGUID
         , b.CostGUID
         , b.DeptGUID
         , b.Year
         , ZrrGUID
         , d.CostCode
         , b.Month                                                                            as FtMonth
         , '日常报销'                                                                             AS BillType
         , 7                                                                                  AS SortNum
         , a.ApplyDate                                                                        AS FTRQ
    from cb_Expense                 a
        LEFT JOIN ys_DeptCostUseDtl b ON a.ExpenseGUID = b.BusinessGUID AND b.BusinessType = '日常报销'
        LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit    e ON a.ApplyBUGUID = e.BUGUID
    where a.ApplyState IN ('已审核') and a.ExpenseTypeName <> '工程水电费代付'
    UNION ALL
    --薪酬发放
    select a.EmolumentGUID                                                                                AS GUID
         , a.ApproveState
         , a.EmolumentCode
         , '<a href="javascript:parent.parent.openxcwin(''' + a.ApproveState + ''',''' +
           CAST(a.EmolumentGUID as VARCHAR(50)) + ''',' + CAST(d.IsEndCost as VARCHAR(1)) + ')" title="' +
           +CONVERT(VARCHAR(max),a.EmolumentName) + '">' + CONVERT(VARCHAR(max),a.EmolumentName) + '</a>' AS Subject
         , a.EmolumentAmount
         , a.jbrname
         , a.jbDate
         , b.FtAmount
         , CASE
               WHEN b.ProceedingGUID = b.DeptGUID THEN '日常费用'
               ELSE c.ProceedingName
           END                                                                                            AS ProceedingName
         , d.CostShortName
         , e.BUName
         , b.ProceedingGUID
         , b.CostGUID
         , b.DeptGUID
         , b.Year
         , ZrrGUID
         , d.CostCode
         , b.Month                                                                                        as FtMonth
         , '薪酬发放'                                                                                         AS BillType
         , 7                                                                                              AS SortNum
         , a.Year + '-' + a.Month + '-01 00:00:00'                                                        AS FTRQ
    from dbo.fy_Emolument           a
        LEFT JOIN ys_DeptCostUseDtl b ON a.EmolumentGUID = b.BusinessGUID AND b.BusinessType = '薪酬发放'
        LEFT JOIN ys_Proceeding     c ON b.ProceedingGUID = c.ProceedingGUID
        LEFT JOIN ys_DeptCost       d ON b.CostGUID = d.DeptCostGUID
        LEFT JOIN myBusinessUnit    e ON a.DeptGUID = e.BUGUID
    where a.ApproveState IN ('已审核')
    UNION ALL
    --执行单
    select a.ExecutionGUID                                            AS GUID
         , a.ApproverState                                            AS ApplyState
         , a.ExecutionCode                                            AS ExpenseCode
         , '<a href="javascript:window.parent.parent.openExecutionWin(''' + a.ApproverState + ''',''' +
           CAST(a.ExecutionGUID as VARCHAR(50)) + ''',''' + CAST(a.DeptGUID as VARCHAR(50)) + ''')">' +
           a.ExecutionName + '</a>'                                   AS Subject
         , IIF(a.ApproverState = '已验收',a.BalanceAmount,a.ReportMoney) AS ExpenseAmount --已验收 取执行单结算金额，其他取执行单申报金额
         , mu.UserName                                                AS AppliedByName
         , a.ApplyDate                                                AS ApplyDate
         , IIF(a.ApproverState = '已验收',b.BalanceAmount,b.Amount)      AS FtAmount      --已验收 取分摊明细结算金额，其他取分摊金额（不包括未审核和作废执行单）
         , b.ProcessName                                              AS ProceedingName
         , c.CostShortName                                            AS CostShortName
         , d.BUName                                                   AS BUName
         , b.ProcessGUID                                              AS ProceedingGUID
         , c.DeptCostGUID                                             AS CostGUID
         , b.DeptGUID                                                 AS DeptGUID
         , DATEPART(year,a.BussinessBelongDate)                       AS Year
         , a.ApplicantGUID                                            AS ZrrGUID
         , c.CostCode                                                 AS CostCode
         , DATEPART(month,a.BussinessBelongDate)                      AS FtMonth
         , '执行单'                                                      AS BillType
         , 8                                                          AS SortNum
         , Convert(varchar(7),a.BussinessBelongDate,120) + '-' + '01' as FTRQ
    from dbo.ys_fy_ExecutionInfo                                                                a
        JOIN dbo.ys_fy_ExecutionDetails                                                         b ON a.ExecutionGUID = b.ExecutionGUID
        join ys_DeptCost                                                                        c on b.DeptCostGUID = c.DeptCostGUID
        join myBusinessUnit                                                                     d on a.ApplicantDeptGUID = d.BUGUID
        join myUser                                                                             mu on a.ApplicantGUID = mu.UserGUID
        CROSS JOIN (select ISNULL(ControlMode,2) as ControlMode from dbo.fy_ControlModeSetting) e
    where a.ApproverState in ('已审核', '已验收') AND e.ControlMode IN (0, 1)) A
WHERE
      1 = 1
  AND 168 = 168
  and DeptGUID IN (SELECT SpecialUnitGUID
                   from (SELECT CASE
                                    WHEN b.SpecialUnitGUID IS NULL THEN a.SpecialUnitGUID
                                    ELSE b.SpecialUnitGUID
                                END AS SpecialUnitGUID
                         from dbo.ys_SpecialBusinessUnit      A
                             LEFT JOIN ys_SpecialBusinessUnit B ON A.SpecialUnitGUID = B.ParentGUID
                         WHERE
                                 A.Year = '2020' AND A.SpecialUnitGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478'
                           OR    A.BUGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478'
                           OR    A.ParentGUID = '3e2e1625-ad2b-ea11-a13f-00505692b478') C)
  and CostGUID = 'CA7E054D-8B2B-EA11-A13F-00505692B478'
  and FTRQ >= '2020-12-01 00:00:00'
  AND FTRQ < '2021-01-01 00:00:00'

```

#### 1.9.3.6 报表算法

1. 报表中 已发生金额 = ys_YearPlanProceeding2Cost表中m12（数字对应月份）金额-1.9.3.3中的在途金额

#### 1.9.3.7 分析

1. 根据业务计算逻辑可以得出正确的当月已发生金额，在途金额，总金额（已发生+在途）
2. 根据1中的金额去验证 1.9.3.6中算出来的已发生金额和在途金额，不一致，则说明ys_YearPlanProceeding2Cost该表维护数据有问题。
3. 根据1中的金额去验证已发生明细和在途明细，不一致，则说明明细报表数据有问题
4. 也可以拿在途明细数据去和1.9.3.3中的结果进行对比，不一致，则必是两者统计口径不一致导致数据出现差异，此种情况在系统稳定前提下较少出现



